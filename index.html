<!DOCTYPE html>
<html>
  <head>
    <!-- ... (стили остаются без изменений) ... -->
  </head>
  <body>
    <div id="map"></div>
    <div id="legendPanel" class="legend-panel"></div>
    
    <script>
      // Исправления:
      // 1. Правильные индексы столбцов согласно комментариям
      // 2. Обработка ошибок координат
      // 3. Корректная работа с данными Google Sheets

      var map = L.map("map").setView([51.09, 71.45], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);

      var markers = [];
      var notifications = [];

      function isMobile() {
        return window.innerWidth <= 768;
      }

      function normalize(str) {
        return str ? str.toString().trim().toLowerCase() : "";
      }

      // Исправленные индексы столбцов:
      const COLUMNS = {
        STREET: 0,     // B
        NAME: 1,       // C
        DIRECTION: 2,  // D
        REGION: 3,     // E
        STOP_ID: 6,    // H
        SHAPE: 11,     // M
        STATUS: 15,    // Q
        AD_TYPE: 16,   // R
        POWER: 17,     // S
        EMAIL: 19      // U
      };

      function getFillColor(status) {
        var st = normalize(status);
        switch(st) {
          case "снят табло": return "gray";
          case "демонтирован": return "black";
          case "не работает": return "#FF0000";
          case "работает": return "#00FF00";
          default: return "white";
        }
      }

      function getBorderColor(reklama) {
        var rec = normalize(reklama);
        return {
          'led': 'red',
          'lightbox': 'blue',
          'x': 'green'
        }[rec] || 'black';
      }

      // Остальные функции остаются аналогичными с использованием COLUMNS

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error('Ошибка сети');
          return response.json();
        })
        .then(data => {
          data.forEach(function(item) {
            let row = item.data || item;
            
            // Преобразование объекта в массив если необходимо
            if (!Array.isArray(row)) {
              row = Object.values(row);
            }

            // Проверка и нормализация координат
            let lat = parseFloat(row[4]);  // Предположим, что координаты в столбцах E и F
            let lng = parseFloat(row[5]);  // Нужно уточнить реальные индексы!
            
            if (isNaN(lat) || isNaN(lng)) {
              console.warn("Invalid coordinates:", row);
              return;
            }

            // Создание маркера с исправленными индексами
            var icon = createMarkerIcon(row);
            var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
            
            // Popup с правильными данными
            var popupHtml = `
              <b>Название:</b> ${row[COLUMNS.NAME]}<br>
              <b>Улица:</b> ${row[COLUMNS.STREET]}<br>
              <b>ID:</b> ${row[COLUMNS.STOP_ID]}
            `;
            marker.bindPopup(popupHtml);

            // Проверка уведомлений
            if (normalize(row[COLUMNS.STATUS]) === "работает" && 
                normalize(row[COLUMNS.EMAIL]) === "gsharipbayev@innoforce.kz") {
              notifications.push(`Изменение для ID: ${row[COLUMNS.STOP_ID]}`);
            }
          });
        })
        .catch(err => {
          console.error("Ошибка:", err);
          alert("Не удалось загрузить данные. Попробуйте позже.");
        });

      // ... (остальной код контролов остается аналогичным) ...
    </script>
  </body>
</html>
