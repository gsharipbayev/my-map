<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leaflet Map with Bus Stops</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    html,body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Подключаем Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
/***************************************************************
 * 1) Настройки и переменные
 ***************************************************************/
var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

// Статусы и их цвета
function getColor(statusText) {
  var st = normalize(statusText);
  if (st.includes("не работ")) return "red";
  if (st.includes("демонт"))   return "black";
  if (st.includes("снят"))     return "gray";
  if (st.includes("работает")) return "lime";
  return "white";
}

/***************************************************************
 * 2) Создаём карту Leaflet
 ***************************************************************/
var map = L.map("map", { center:[51.09, 71.45], zoom:11 });
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom:19
}).addTo(map);

// Понадобится, чтобы приблизить карту к маркерам
var markersGroup = L.featureGroup().addTo(map);

/***************************************************************
 * 3) Запрашиваем данные
 ***************************************************************/
fetch(url)
  .then(resp => resp.json())
  .then(data => {
    console.log("Всего строк получено:", data.length);
    if (data.length === 0) {
      console.warn("Похоже, скрипт вернул пустые данные!");
      return;
    }

    // Перебираем каждую строку
    data.forEach((item, index) => {
      // Достаём массив row
      var row = item.data || item;
      if (!Array.isArray(row)) row = Object.values(row);

      // Если столбцов меньше 19, дополняем
      while(row.length < 19) row.push("");

      // Определяем координаты
      var lat = parseFloat(row[5]);  // широта
      var lng = parseFloat(row[6]);  // долгота

      // Если координаты некорректны, пропускаем
      if (isNaN(lat) || isNaN(lng)) {
        console.warn("Плохие координаты в строке", index+1, row[5], row[6]);
        return;
      }

      // Статус
      var status = row[16]; // Q
      var color  = getColor(status);

      // Создаём круглый маркер и добавляем на карту
      var circle = L.circleMarker([lat, lng], {
        radius: 7,
        color: "#333",
        fillColor: color,
        fillOpacity: 0.85
      }).addTo(markersGroup);

      // popup (всплывающая подсказка)
      // row[1] = улица, row[2] = название, row[16] = статус
      var popupHtml = 
        "<b>Улица:</b> "     + (row[1] || "")  + "<br>" +
        "<b>Остановка:</b> " + (row[2] || "")  + "<br>" +
        "<b>Статус:</b> "    + (row[16] || "");
      circle.bindPopup(popupHtml);

      // Для отладки
      console.log("Строка #", (index+1), "Статус=", status, "Цвет=", color);
    });

    // После отрисовки маркеров приближаем карту на все точки
    map.fitBounds(markersGroup.getBounds(), { padding:[50,50] });

    console.log("Рисование завершено.");
  })
  .catch(err => {
    console.error("Ошибка при загрузке данных:", err);
  });

/***************************************************************
 * 4) Вспомогательные функции
 ***************************************************************/
function normalize(s) {
  return s ? s.toLowerCase().trim() : "";
}
</script>
</body>
</html>
