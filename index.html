<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Leaflet Map with Google Sheets Data</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .custom-control {
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 0 5px rgba(0,0,0,0.65);
        cursor: pointer;
      }
      .legend-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #ccc;
        padding: 10px;
        display: none;
        height: 15vh;
        overflow: auto;
        z-index: 1000;
      }
      @media (max-width:768px) {
        .custom-marker {
          width: 64px !important;
          height: 64px !important;
        }
        .custom-control {
          font-size: 24px;
        }
        .lightning {
          font-size: 16px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="legendPanel" class="legend-panel"></div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      var map = L.map("map").setView([51.09, 71.45], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

      var markers = [];

      function isMobile() {
        return window.innerWidth <= 768;
      }

      function normalize(str) {
        return str ? str.toString().trim().toLowerCase() : "";
      }

      function getFillColor(status) {
        var s = normalize(status);
        if (s === "снят табло") return "gray";
        if (s === "демонтирован") return "black";
        if (s === "не работает") return "red";
        if (s === "работает") return "#00ff00";
        return "white";
      }

      function getBorderColor(reklama) {
        var r = normalize(reklama);
        if (r === "led") return "red";
        if (r === "lightbox") return "blue";
        if (r === "x") return "green";
        return "black";
      }

      function getBorderWidth(reklama) {
        var r = normalize(reklama);
        if (["led", "lightbox", "x"].includes(r)) return 3;
        return 1;
      }

      function getShape(val) {
        var v = normalize(val);
        if (v === "медиаборд") return "square";
        if (v === "+") return "circle";
        return "circle";
      }

      function getLightningHTML(power) {
        var p = normalize(power);
        if (p === "питание есть") {
          return '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:green; font-size:' + (isMobile() ? "16px" : "10px") + ';">&#9889;</div>';
        } else if (p === "нет питания") {
          return '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:red; font-size:' + (isMobile() ? "16px" : "10px") + ';">&#9889;</div>';
        }
        return "";
      }

      function createMarkerIcon(row) {
        var markerSize = isMobile() ? 64 : 32;
        var shape = getShape(row[12]);
        var fillColor = getFillColor(row[16]);
        var borderColor = getBorderColor(row[17]);
        var borderWidth = getBorderWidth(row[17]);
        var borderRadius = (shape === "circle") ? "50%" : "0%";
        var lightningHTML = getLightningHTML(row[18]);

        var html = '<div class="custom-marker" style="position:relative; width:' + markerSize + 'px; height:' + markerSize + 'px;">' +
                   '<div style="width:100%; height:100%; background-color:' + fillColor +
                   '; border:' + borderWidth + 'px solid ' + borderColor +
                   '; border-radius:' + borderRadius + ';"></div>' +
                   lightningHTML +
                   '</div>';

        return L.divIcon({
          html: html,
          className: "",
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize / 2, markerSize / 2]
        });
      }

      var url = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log("Получены данные:", data);
          data.forEach(function(item, index) {
            var row = item.data || item;
            if (!Array.isArray(row)) row = Object.values(row);
            while (row.length < 19) row.push("");

            var lat = parseFloat(row[5]);
            var lng = parseFloat(row[6]);
            if (isNaN(lat) || isNaN(lng)) return;

            var icon = createMarkerIcon(row);
            var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
            marker.bindPopup(
              "<b>Наименование улицы:</b> " + row[1] + "<br>" +
              "<b>Название остановок:</b> " + row[2] + "<br>" +
              "<b>Направление:</b> " + row[3] + "<br>" +
              "<b>Район:</b> " + row[4] + "<br>" +
              "<b>ID Табло:</b> " + row[7] + "<br>" +
              "<b>Статус:</b> " + row[16] + "<br>" +
              "<b>Реклама:</b> " + row[17]
            );
          });
        })
        .catch(err => console.error("Ошибка при загрузке данных:", err));
    </script>
  </body>
</html>
