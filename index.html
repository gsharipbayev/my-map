<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –ê—Å—Ç–∞–Ω–∞ ‚Äî –†–∞–±–æ—Ç–∞–µ—Ç / –°—Ç–∞—Ç—É—Å</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  :root { --controls-height: 72px; }
  html,body{height:100%;margin:0}
  /* –ö–∞—Ä—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
  #map{
    position:fixed; top:0; left:0; right:0;
    bottom:var(--controls-height);
    background:#f2f2f2;
    z-index:1;
  }

  /* –í–µ—Ä—Ö–Ω—è—è –≤—ã–µ–∑–∂–∞—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ */
  #bar{position:fixed;left:0;right:0;top:-64px;display:flex;gap:8px;justify-content:center;padding:8px;background:rgba(255,255,255,.95);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:.25s;z-index:20}
  #hover{position:fixed;left:0;right:0;top:0;height:10px;z-index:21}
  #bar.show{top:0}
  #bar input,#bar button{font:14px/1.2 system-ui;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  #bar button{background:#007bff;color:#fff;border:none;cursor:pointer}

  /* –ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É ‚Äî –í–°–ï–ì–î–ê –≤–∏–¥–Ω—ã –∏ –≤—ã—à–µ –≤—Å–µ—Ö */
  .controls{
    position:fixed;bottom:0;left:0;right:0;
    display:flex;gap:8px;justify-content:center;align-items:center;
    background:rgba(255,255,255,.97);padding:10px 8px;
    box-shadow:0 -2px 8px rgba(0,0,0,.25);
    z-index:9999;
  }
  .btn{
    background:#007bff;color:#fff;border:none;border-radius:10px;padding:10px 14px;
    box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer;font:14px/1.2 system-ui
  }
  .btn.active{background:#0056b3;box-shadow:0 0 0 2px #fff,0 0 0 4px #0056b3}

  /* –ü–∞–Ω–µ–ª—å –ª–µ–≥–µ–Ω–¥—ã/–æ–≤–µ—Ä–ª–µ–π –Ω–∏–∂–µ –∫–Ω–æ–ø–æ–∫ */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9000}
  .panel{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(var(--controls-height) + 8px);
    width:92%;max-width:520px;max-height:60%;
    background:#fff;border-radius:18px; padding:16px;
    box-shadow:0 8px 24px rgba(0,0,0,.25);
    display:none; z-index:9500; overflow:auto;
  }
  .panel.active{ display:block; }

  .legend .row{display:flex;align-items:center;gap:10px;margin:8px 0}
  .ico{width:22px;height:22px;border:1px solid #000;display:inline-block;border-radius:50%}
  .sq{border-radius:4px}
  .tri{border:none;width:0;height:0;border-left:11px solid transparent;border-right:11px solid transparent}

  /* –ü–æ–¥—Å–∫–∞–∑–∫–∞-—Å–≤–æ–¥–∫–∞ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã */
  .hint{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(var(--controls-height) + 8px);
    background:rgba(255,255,255,.98);
    border:1px solid #e5e7eb;border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.18);
    padding:10px 12px 8px 12px; min-width:220px; max-width:92%;
    z-index:9800;
  }
  .hint .close{
    position:absolute; left:8px; top:8px; width:22px; height:22px;
    border:none; border-radius:6px; background:#f3f4f6; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 1px 2px rgba(0,0,0,.1);
  }
  .hint .title{ font:600 14px/1.2 system-ui; text-align:center; padding-left:22px; margin-bottom:8px; }
  .hint .grid{ display:grid; grid-template-columns:auto auto; gap:6px 12px; align-items:center; font:13px/1.2 system-ui; }
  .dot{display:inline-block; width:12px; height:12px; border-radius:50%; border:1px solid #000; margin-right:6px; vertical-align:-2px;}
  .sq-sm{display:inline-block; width:12px; height:12px; border-radius:3px; border:1px solid #000; margin-right:6px; vertical-align:-2px;}
  .tri-sm{display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; margin-right:6px; vertical-align:-1px;}

  /* –ë–∞–Ω–Ω–µ—Ä –æ—à–∏–±–æ–∫ */
  .err{position:fixed;top:12px;left:50%;transform:translateX(-50%);
    background:#ffebee;color:#b71c1c;border:1px solid #ffcdd2;
    padding:8px 12px;border-radius:10px;z-index:20000;display:none;font:14px/1.2 system-ui}
</style>
</head>
<body>
  <div id="map"></div>

  <!-- –≤—ã–µ–∑–∂–∞—é—â–∏–π –ø–æ–∏—Å–∫ -->
  <div id="hover"></div>
  <div id="bar">
    <input id="q" placeholder="ID –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"/>
    <button id="find">üîç –ü–æ–∏—Å–∫</button>
  </div>

  <!-- –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ –∫–Ω–æ–ø–∫–∏ -->
  <div class="controls" id="controls">
    <button class="btn active" id="modeWorks">–†–∞–±–æ—Ç–∞–µ—Ç</button>
    <button class="btn" id="modeStatus">–°—Ç–∞—Ç—É—Å</button>
    <button class="btn" id="legendBtn">–õ–µ–≥–µ–Ω–¥–∞</button>
  </div>

  <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∞-—Å–≤–æ–¥–∫–∞ -->
  <div class="hint" id="hint">
    <button class="close" id="hintClose" title="–°–∫—Ä—ã—Ç—å">‚úï</button>
    <div class="title" id="hintTitle">–†–∞–±–æ—Ç–∞–µ—Ç</div>
    <div class="grid" id="hintGrid"></div>
  </div>

  <!-- –ª–µ–≥–µ–Ω–¥–∞ -->
  <div class="overlay" id="ov"></div>
  <div class="panel" id="panel"><div id="legend" class="legend"></div></div>

  <!-- –±–∞–Ω–Ω–µ—Ä –æ—à–∏–±–æ–∫ -->
  <div class="err" id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" defer></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== –ö–æ–Ω—Ñ–∏–≥ ===== */
  const DATA_URL = "https://script.google.com/macros/s/AKfycbykrfvSNKlLMLRPbuxuUtqD_-o1chp-wIIW6-OFW-BjabiBw9QIDUtNwmvxXj9x4igx/exec";
  const CENTER=[51.128,71.43], ZOOM=12, CACHE_TTL_MS=60000;
  const K={ id:"ID –û—Å—Ç–∞–Ω–æ–≤–∫–∏", stop:"–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫", street:"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã", dir:"–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", dist:"–†–∞–π–æ–Ω", lat:"—à–∏—Ä–æ—Ç–∞", lng:"–î–æ–ª–≥–æ—Ç–∞", work:"–†–∞–±–æ—Ç–∞–µ—Ç", agr:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Ç. —Å—Ö–µ–º", all:"–û—Ç–≤–æ–¥", tech:"–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ", inst:"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏", note:"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" };
  const C={ yes:"#00c853", no:"#ff1744", na:"#9e9e9e", blue:"#2196f3", yellow:"#ffeb3b", orange:"#ff9800", violet:"#8e24aa", green:"#2e7d32", cluster:"#555" };
  const RULES={
    works:[
      {when:r=>eq(r[K.work],"–¥–∞"),  shape:"circle", color:C.yes, label:"–†–∞–±–æ—Ç–∞–µ—Ç: –î–∞"},
      {when:r=>eq(r[K.work],"–Ω–µ—Ç"), shape:"circle", color:C.no,  label:"–†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç"},
      {when:_=>true,                shape:"circle", color:C.na,  label:"–ü—É—Å—Ç–æ/–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"},
    ],
    status:[
      {when:r=>eq(r[K.inst],"–≥–æ—Ç–æ–≤–æ"),    shape:"circle",   color:C.yes,    legend:"–ì–æ—Ç–æ–≤–æ"},
      {when:r=>eq(r[K.inst],"—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç"), shape:"triangle", color:C.violet, legend:"–§—É–Ω–¥–∞–º–µ–Ω—Ç"},
      {when:r=>eq(r[K.inst],"—Å–µ—Ç—å"),      shape:"triangle", color:C.orange, legend:"–°–µ—Ç—å"},
      {when:r=>eq(r[K.inst],"–∫–∞—Ä–∫–∞—Å"),    shape:"triangle", color:C.green,  legend:"–ö–∞—Ä–∫–∞—Å"},
      {when:r=>eq(r[K.agr],"—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω"), shape:"square",   color:C.blue,   legend:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω"},
      {when:r=>eq(r[K.all],"–¥–∞"),         shape:"square",   color:C.yellow, legend:"–û—Ç–≤–æ–¥"},
      {when:r=>eq(r[K.tech],"–¥–∞"),        shape:"square",   color:C.orange, legend:"–¢–µ—Ö —É—Å–ª."},
      {when:r=>eq(r[K.work],"–¥–∞"),        shape:"circle",   color:C.yes,    legend:"–î–∞ (fallback)"},
      {when:r=>eq(r[K.work],"–Ω–µ—Ç"),       shape:"circle",   color:C.no,     legend:"–ù–µ—Ç (fallback)"},
      {when:_=>true,                      shape:"circle",   color:C.na,     legend:"–ü—É—Å—Ç–æ (fallback)"},
    ]
  };

  const eq=(v,s)=>String(v==null?"":v).trim().toLowerCase()===s;
  const esc=s=>String(s==null?"":s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  /* ===== –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ ===== */
  const err = (msg) => {
    const el = document.getElementById('err');
    el.textContent = msg;
    el.style.display = 'block';
  };

  /* ===== –ö–∞—Ä—Ç–∞ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–∞ try/catch) ===== */
  let map;
  try{
    map = L.map("map",{zoomControl:false}).setView(CENTER,ZOOM);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    L.control.zoom({position:"topright"}).addTo(map);
  }catch(e){
    err("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet.");
    console.error(e);
    return;
  }

  /* ===== –ö–ª–∞—Å—Ç–µ—Ä—ã –ø–æ shape|color ===== */
  function makeCluster(fixedColor){
    return L.markerClusterGroup({
      maxClusterRadius:60,
      iconCreateFunction: cl => {
        const n=cl.getChildCount(), s=Math.min(Math.max(30+n/10,30),50);
        return L.divIcon({
          html:'<div style="background:'+fixedColor+';border:2px solid '+C.cluster+';border-radius:50%;width:'+s+'px;height:'+s+'px;display:flex;align-items:center;justify-content:center;font-weight:700">'+n+'</div>',
          className:"cluster", iconSize:[s,s], iconAnchor:[s/2,s/2]
        });
      }
    });
  }
  const clusterRegistry=new Map();
  function getCluster(shape,color){
    const key=shape+"|"+color;
    if(clusterRegistry.has(key)) return clusterRegistry.get(key);
    const g=makeCluster(color);
    clusterRegistry.set(key,g);
    map.addLayer(g);
    return g;
  }
  function clearAllClusters(){
    for(const g of clusterRegistry.values()) map.removeLayer(g);
    clusterRegistry.clear();
  }

  /* ===== –ò–∫–æ–Ω–∫–∏ —Å –∫—ç—à–µ–º ===== */
  const iconCache=new Map();
  function getIcon(shape,color){
    const key=shape+"|"+color;
    if(iconCache.has(key)) return iconCache.get(key);
    let html="";
    if(shape==="circle")   html='<div style="width:18px;height:18px;border-radius:50%;background:'+color+';border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4)"></div>';
    if(shape==="square")   html='<div style="width:18px;height:18px;border-radius:4px;background:'+color+';border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4)"></div>';
    if(shape==="triangle") html='<div style="width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:18px solid '+color+';filter:drop-shadow(0 0 3px rgba(0,0,0,.4))"></div>';
    const ic=L.divIcon({html:html,className:"",iconSize:[18,18],iconAnchor:[9,9]});
    iconCache.set(key,ic); return ic;
  }

  /* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
  let mode="works";
  let data=[], view=[];
  let hintClosed=false;

  /* ===== –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ ===== */
  function syncControlsHeight(){
    const controls = document.getElementById('controls');
    if(!controls) return;
    const h = Math.ceil(controls.getBoundingClientRect().height + 10);
    document.documentElement.style.setProperty('--controls-height', h + 'px');
  }
  syncControlsHeight();
  window.addEventListener('resize', syncControlsHeight);

  /* ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Å –∫—ç—à–µ–º ===== */
  (async function init(){
    try{
      const cached = readCache();
      if(cached){ data=cached; } else {
        const r=await fetch(DATA_URL,{cache:"no-store"});
        if(!r.ok){ throw new Error("HTTP "+r.status); }
        const json=await r.json();
        data = Array.isArray(json) ? json : (json.data||[]);
        writeCache(data);
      }
      data=data.map(r=>{
        const lat=parseFloat(r[K.lat]), lng=parseFloat(r[K.lng]);
        return {...r, _lat:lat, _lng:lng,
          _id:String(r[K.id]||""), _nm:String(r[K.stop]||""),
          _work:String(r[K.work]||"").trim().toLowerCase(),
          _inst:String(r[K.inst]||"").trim().toLowerCase(),
          _agr:String(r[K.agr]||"").trim().toLowerCase(),
          _all:String(r[K.all]||"").trim().toLowerCase(),
          _tech:String(r[K.tech]||"").trim().toLowerCase(),
        };
      }).filter(r=>!isNaN(r._lat)&&!isNaN(r._lng));

      view=data; draw(); fit(view);
    }catch(e){
      err("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (GAS/API). –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
      console.error(e);
    }
  })();

  function readCache(){
    try{
      const raw=localStorage.getItem("stops_cache_v1");
      if(!raw) return null;
      const v=JSON.parse(raw);
      if(Date.now()-v.ts > CACHE_TTL_MS) return null;
      return v.rows;
    }catch{return null}
  }
  function writeCache(rows){
    try{ localStorage.setItem("stops_cache_v1", JSON.stringify({ts:Date.now(), rows})); }catch{}
  }

  /* ===== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ + —Å–≤–æ–¥–∫–∞ ===== */
  function draw(){
    clearAllClusters();
    const rules=RULES[mode];
    const batches=new Map(); // key -> [markers]
    const stats=new Map();   // label -> count

    for(const r of view){
      const rule=rules.find(x=>x.when(r));
      const shape=rule.shape, color=rule.color;

      const m=L.marker([r._lat,r._lng],{icon:getIcon(shape,color)});
      m.bindPopup(
        '<b>ID:</b> '+esc(r[K.id])+'<br>'+
        '<b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> '+esc(r[K.stop])+'<br>'+
        '<b>–£–ª–∏—Ü–∞:</b> '+esc(r[K.street])+'<br>'+
        '<b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> '+esc(r[K.dir])+'<br>'+
        '<b>–†–∞–π–æ–Ω:</b> '+esc(r[K.dist])+'<br>'+
        '<b>–†–∞–±–æ—Ç–∞–µ—Ç:</b> '+esc(r[K.work])+'<br>'+
        '<b>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ:</b> '+esc(r[K.agr])+'<br>'+
        '<b>–û—Ç–≤–æ–¥:</b> '+esc(r[K.all])+'<br>'+
        '<b>–¢–µ—Ö —É—Å–ª.:</b> '+esc(r[K.tech])+'<br>'+
        '<b>–°—Ç–∞—Ç—É—Å —É—Å—Ç.:</b> '+esc(r[K.inst])+'<br>'+
        '<b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> '+esc(r[K.note])
      );

      const key=shape+"|"+color;
      if(!batches.has(key)) batches.set(key, []);
      batches.get(key).push(m);

      if(mode==="works"){
        const label = r._work==="–¥–∞" ? "–î–∞" : r._work==="–Ω–µ—Ç" ? "–ù–µ—Ç" : "–ü—É—Å—Ç–æ";
        stats.set(label, (stats.get(label)||0)+1);
      }else{
        const label = rule.legend;
        stats.set(label, (stats.get(label)||0)+1);
      }
    }

    for(const [key, markers] of batches){
      const [shape,color]=key.split("|");
      const g=getCluster(shape,color);
      g.addLayers(markers);
    }

    updateHint(stats);
  }

  function fit(rows){
    if(!rows.length) return;
    const b=L.latLngBounds(rows.map(r=>[r._lat,r._lng]));
    map.fitBounds(b.pad(0.05),{animate:false});
  }

  /* ===== –ü–æ–∏—Å–∫ ===== */
  const q=document.getElementById("q");
  const applySearch=()=>{
    const s=(q.value||"").trim().toLowerCase();
    view = s ? data.filter(r=>r._id.toLowerCase().includes(s)||r._nm.toLowerCase().includes(s)) : data;
    draw(); fit(view);
  };
  document.getElementById("find").onclick=applySearch;
  q.addEventListener("input", debounce(applySearch,220), {passive:true});

  /* ===== –†–µ–∂–∏–º—ã ===== */
  const btnW=document.getElementById("modeWorks");
  const btnS=document.getElementById("modeStatus");
  btnW.onclick=()=>{ mode="works"; btnW.classList.add("active"); btnS.classList.remove("active"); draw(); setHintTitle(); };
  btnS.onclick=()=>{ mode="status"; btnS.classList.add("active"); btnW.classList.remove("active"); draw(); setHintTitle(); };

  /* ===== –õ–µ–≥–µ–Ω–¥–∞ ===== */
  const ov=document.getElementById("ov"), panel=document.getElementById("panel");
  document.getElementById("legendBtn").onclick=()=>{ setLegend(); togglePanel(true); };
  ov.onclick=()=>togglePanel(false);
  function togglePanel(show){
    panel.style.display = show ? "block" : "none";
    ov.style.display    = show ? "block" : "none";
  }
  function setLegend(){
    const box=document.getElementById("legend");
    if(mode==="works"){
      box.innerHTML=
        '<div class="row"><span class="ico" style="background:'+C.yes+'"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –î–∞</div>'+
        '<div class="row"><span class="ico" style="background:'+C.no+'"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç</div>'+
        '<div class="row"><span class="ico" style="background:'+C.na+'"></span> –ü—É—Å—Ç–æ / –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>';
    }else{
      box.innerHTML=
        '<div class="row"><span class="ico" style="background:'+C.yes+'"></span> –ì–æ—Ç–æ–≤–æ</div>'+
        '<div class="row"><span class="tri" style="border-bottom:22px solid '+C.violet+'"></span> –§—É–Ω–¥–∞–º–µ–Ω—Ç</div>'+
        '<div class="row"><span class="tri" style="border-bottom:22px solid '+C.orange+'"></span> –°–µ—Ç—å</div>'+
        '<div class="row"><span class="tri" style="border-bottom:22px solid '+C.green+'"></span> –ö–∞—Ä–∫–∞—Å</div>'+
        '<hr/>'+
        '<div class="row"><span class="ico sq" style="background:'+C.blue+'"></span> –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω</div>'+
        '<div class="row"><span class="ico sq" style="background:'+C.yellow+'"></span> –û—Ç–≤–æ–¥</div>'+
        '<div class="row"><span class="ico sq" style="background:'+C.orange+'"></span> –¢–µ—Ö —É—Å–ª.</div>'+
        '<hr/>'+
        '<div class="row"><span class="ico" style="background:'+C.yes+'"></span> –î–∞ (fallback)</div>'+
        '<div class="row"><span class="ico" style="background:'+C.no+'"></span> –ù–µ—Ç (fallback)</div>'+
        '<div class="row"><span class="ico" style="background:'+C.na+'"></span> –ü—É—Å—Ç–æ (fallback)</div>';
    }
  }

  /* ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–ø–æ–∏—Å–∫) ===== */
  const bar=document.getElementById("bar"), hoverDiv=document.getElementById("hover");
  let t; const show=()=>{clearTimeout(t);bar.classList.add("show")}, hide=()=>bar.classList.remove("show");
  hoverDiv.addEventListener("mouseenter", show); hoverDiv.addEventListener("mouseleave", ()=>t=setTimeout(hide,1200));
  hoverDiv.addEventListener("touchstart", show, {passive:true}); bar.addEventListener("mouseleave", ()=>t=setTimeout(hide,1200));

  /* ===== –ü–æ–¥—Å–∫–∞–∑–∫–∞-—Å–≤–æ–¥–∫–∞ ===== */
  const hintEl=document.getElementById("hint");
  const hintTitle=document.getElementById("hintTitle");
  const hintGrid=document.getElementById("hintGrid");
  document.getElementById("hintClose").onclick=()=>{ hintClosed=true; hintEl.style.display="none"; };
  function setHintTitle(){ hintTitle.textContent = (mode==="works" ? "–†–∞–±–æ—Ç–∞–µ—Ç" : "–°—Ç–∞—Ç—É—Å"); }
  function updateHint(statsMap){
    if(hintClosed) return;
    setHintTitle();
    const orderWorks=["–î–∞","–ù–µ—Ç","–ü—É—Å—Ç–æ"];
    const orderStatus=["–ì–æ—Ç–æ–≤–æ","–§—É–Ω–¥–∞–º–µ–Ω—Ç","–°–µ—Ç—å","–ö–∞—Ä–∫–∞—Å","–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω","–û—Ç–≤–æ–¥","–¢–µ—Ö —É—Å–ª.","–î–∞ (fallback)","–ù–µ—Ç (fallback)","–ü—É—Å—Ç–æ (fallback)"];
    const parts=[];
    const push=(label,count)=>{ parts.push('<div>'+label+'</div><div><b>'+count+'</b></div>'); };

    if(mode==="works"){
      const colorOf = l => l==="–î–∞"?C.yes:l==="–ù–µ—Ç"?C.no:C.na;
      orderWorks.forEach(l => push('<span class="dot" style="background:'+colorOf(l)+'"></span>'+l, statsMap.get(l)||0));
    }else{
      const badge = l => {
        if(l==="–ì–æ—Ç–æ–≤–æ")     return '<span class="dot"   style="background:'+C.yes+'"></span>'+l;
        if(l==="–§—É–Ω–¥–∞–º–µ–Ω—Ç")  return '<span class="tri-sm" style="border-bottom:12px solid '+C.violet+'"></span>'+l;
        if(l==="–°–µ—Ç—å")       return '<span class="tri-sm" style="border-bottom:12px solid '+C.orange+'"></span>'+l;
        if(l==="–ö–∞—Ä–∫–∞—Å")     return '<span class="tri-sm" style="border-bottom:12px solid '+C.green+'"></span>'+l;
        if(l==="–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω") return '<span class="sq-sm"  style="background:'+C.blue+'"></span>'+l;
        if(l==="–û—Ç–≤–æ–¥")      return '<span class="sq-sm"  style="background:'+C.yellow+'"></span>'+l;
        if(l==="–¢–µ—Ö —É—Å–ª.")   return '<span class="sq-sm"  style="background:'+C.orange+'"></span>'+l;
        if(l.indexOf('–î–∞')>-1)  return '<span class="dot" style="background:'+C.yes+'"></span>'+l;
        if(l.indexOf('–ù–µ—Ç')>-1) return '<span class="dot" style="background:'+C.no+'"></span>'+l;
        return '<span class="dot" style="background:'+C.na+'"></span>'+l;
      };
      orderStatus.forEach(l => push(badge(l), statsMap.get(l)||0));
    }
    hintGrid.innerHTML = parts.join('');
    hintEl.style.display = "block";
  }
});
</script>
</body>
</html>
