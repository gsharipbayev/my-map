<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leaflet Bus Stops</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    html,body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
/***************************************************************
 * Настройки
 ***************************************************************/
var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

// Словарь для цвета статуса (если находим подстроку)
var statusColors = {
  "не работает": "red",
  "демонт":      "black",
  "снят":        "gray",
  "работает":    "lime"
};

// Создаём карту Leaflet
var map = L.map("map", { center:[51.09, 71.45], zoom:11 });
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);
var markersGroup = L.featureGroup().addTo(map);

/***************************************************************
 * Загрузка данных
 ***************************************************************/
fetch(url)
  .then(resp => resp.json())
  .then(data => {
    console.log("Всего строк:", data.length);
    data.forEach((item, i) => {
      var row = item.data || item;
      if(!Array.isArray(row)) row = Object.values(row);
      while(row.length < 19) row.push("");

      // Координаты
      let lat = parseFloat(row[5]);
      let lng = parseFloat(row[6]);
      if(isNaN(lat)||isNaN(lng)) {
        console.warn("❗ Плохие координаты, строка=", i+1, row[5], row[6]);
        return;
      }

      // Статус
      let rawStatus = (row[16] || "").trim();
      console.log("Строка #"+(i+1)+": статус =", `"${rawStatus}"`);

      // Определим цвет
      let color = getColorFromStatus(rawStatus);

      // Рисуем круг
      L.circleMarker([lat,lng], {
        radius: 7,
        color: "#333",
        fillColor: color,
        fillOpacity: 0.85
      })
      .bindPopup(
        "<b>Улица:</b> " + (row[1]||"") + "<br>"+
        "<b>Остановка:</b> " + (row[2]||"") + "<br>"+
        "<b>Статус:</b> " + rawStatus
      )
      .addTo(markersGroup);
    });
    // Автоподгон
    if (markersGroup.getBounds().isValid()) {
      map.fitBounds(markersGroup.getBounds(), { padding:[30,30] });
    }
    console.log("Рендер завершён.");
  })
  .catch(e => console.error("Ошибка:", e));

/***************************************************************
 * Функции
 ***************************************************************/
function getColorFromStatus(s) {
  let st = s.toLowerCase();
  // Перебираем ключи словаря (\"не работает\", \"демонт\" и т.д.)
  for (let key in statusColors) {
    if(st.includes(key)) {
      return statusColors[key];
    }
  }
  return "white";
}
</script>
</body>
</html>
