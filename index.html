<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaflet Map ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      font-size:16px;
    }
    #map {
      width:100%;
      height:100%;
      z-index:0;
    }
    .leaflet-top.leaflet-left {
      margin-top:70px;
    }

    /* 1) –ê–≤—Ç–æ‚Äë—Å–∫—Ä—ã—Ç–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
    #searchActivator {
      position:fixed;
      top:0; left:0; right:0;
      height:10px;
      z-index:3000;
    }
    #topSearchBar {
      position:fixed;
      top:-70px;
      left:0; right:0;
      z-index:3001;
      display:flex;
      justify-content:center;
      background:rgba(255,255,255,0.9);
      padding:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
      gap:8px;
      align-items:center;
      transition: top 0.3s;
    }
    #topSearchBar.show {
      top:0;
    }
    #searchInput {
      flex:1;
      max-width:600px;
      padding:5px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:5px;
    }
    #searchBtn {
      font-size:14px;
      padding:5px 8px;
      cursor:pointer;
      border:none;
      background:#007bff;
      color:#fff;
      border-radius:5px;
      flex-shrink:0;
    }

    /* 2) –ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É */
    .control-buttons {
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-wrap: wrap; /* –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ */
      gap:6px;
      z-index:1001;
    }
    .btn {
      padding:10px 16px;
      font-size:14px;
      min-width:110px;
      background-color:#007bff;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:background-color 0.3s;
      text-align:center;
      margin-bottom: 5px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
    }
    .btn.active-filter { /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ */
      background-color:#0056b3;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #0056b3; /* –û–±–≤–æ–¥–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
    }
    .btn:hover {
      background-color:#0056b3;
    }
    .btn span {
      display:block;
      font-size:12px;
      color:#d1e8ff;
      margin-top:5px;
    }

    /* 3) –ü–æ–¥–ª–æ–∂–∫–∞ + –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .overlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      display:none;
      z-index:1000;
    }
    .bottom-panel {
      position:fixed;
      bottom:-100%; /* –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ */
      left:50%;
      transform:translateX(-50%);
      width:90%;
      max-width:500px;
      max-height: 70%; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –ø–∞–Ω–µ–ª–∏ */
      overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–∞–Ω–µ–ª–∏ */
      background:#fff;
      border-radius:15px 15px 0 0;
      font-size:16px;
      padding:20px;
      box-shadow:0 -2px 15px rgba(0,0,0,0.3);
      transition:bottom 0.4s ease-in-out;
      z-index:1002;
    }
    .bottom-panel.active {
      bottom:0; /* –ü–æ–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ 0 –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    .panel-title {
      font-size:20px;
      font-weight:bold;
      margin-bottom:15px;
      color:#333;
    }
     .panel-content-scrollable { /* –î–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ */
      max-height: calc(70vh - 100px); /* –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –º–∏–Ω—É—Å –ø–∞–¥–¥–∏–Ω–≥–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
      overflow-y: auto;
    }

    /* 4) –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */
    .filter-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .filter-buttons button {
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:5px;
      padding:6px 12px;
      cursor:pointer;
      font-size:14px;
      transition:background 0.2s;
    }
    .filter-buttons button:hover {
      background:#0062cc;
    }
    .filter-buttons button.active { /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞ */
      background:#28a745; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
      color: white;
    }
    .filter-buttons button.clear-btn { /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å" */
        background: #6c757d;
    }
    .filter-buttons button.clear-btn:hover {
        background: #5a6268;
    }


    /* 5) –õ–µ–≥–µ–Ω–¥–∞ */
    .legend-container {
      display:flex;
      flex-wrap:wrap;
      gap:15px;
    }
    .legend-section {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .legend-title {
      font-weight:bold;
      margin-bottom:5px;
    }
    .legend-row {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .legend-icon {
      width:20px;
      height:20px;
      display:inline-block;
      border-radius:50%;
      border:1px solid #000;
    }

    /* 6) MarkerCluster (radius=80) */
    .cluster-icon {
      font-weight:bold;
      text-align:center;
    }
    .my-div-icon {
      background:none !important;
      border:none !important;
    }

    /* 7) –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ */
    @media (max-width:600px){
      #searchInput {
        max-width:calc(100% - 70px); /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        font-size:14px;
      }
      #searchBtn {
        font-size:12px;
        padding:4px 6px;
      }
      .control-buttons {
        width: 100%; /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
        padding: 0 10px; /* –ù–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
        box-sizing: border-box;
      }
      .btn {
        padding:8px 10px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –ø–∞–¥–¥–∏–Ω–≥–∏ */
        font-size:12px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç */
        min-width:auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        flex-grow: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
      }
      .bottom-panel {
        width:100%; /* –ü–∞–Ω–µ–ª—å –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
        border-radius: 15px 15px 0 0; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É */
        font-size:14px;
        max-height: 60%; /* –£–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      }
      .panel-title {
        font-size:18px;
      }
      .filter-buttons button {
        font-size:13px;
        padding:5px 10px;
      }
    }
  </style>
</head>
<body>
  <div id="searchActivator"></div>

  <div id="topSearchBar">
    <input
      type="text"
      id="searchInput"
      placeholder="ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    />
    <button id="searchBtn">üîç</button>,
  </div>

  <div id="map"></div>

  <div class="control-buttons">
    <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
    <button class="btn" id="statusToggle">
      –°–æ—Å—Ç–æ—è–Ω–∏–µ <span id="statusLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="reklamaToggle">
      –†–µ–∫–ª–∞–º–∞ <span id="reklamaLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="planToggle">
      –ü–ª–∞–Ω (–º–µ—Å) <span id="planLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="moveToggle">
      –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ <span id="moveLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="planningImportanceToggle">
      –í–∞–∂–Ω–æ—Å—Ç—å <span id="planningImportanceLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="streetToggle">
      –£–ª–∏—Ü–∞ <span id="streetLabel">–í—Å–µ (0)</span>
    </button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="bottom-panel" id="bottomPanel">
    <div class="panel-title" id="panelTitle">–õ–µ–≥–µ–Ω–¥–∞</div>
    <div id="panelContentWrapper"> <div id="panelContent" class="legend-container"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    /***********************************************************
     * 1) –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞
     ***********************************************************/
    const searchActivator = document.getElementById("searchActivator");
    const topSearchBar    = document.getElementById("topSearchBar");
    let hideTimer=null;
    function showSearchBar(){
      clearTimeout(hideTimer);
      topSearchBar.classList.add("show");
    }
    function hideSearchBar(){
      topSearchBar.classList.remove("show");
    }
    function startHideTimer(){
      hideTimer=setTimeout(hideSearchBar,2000);
    }
    searchActivator.addEventListener("mouseenter", showSearchBar);
    searchActivator.addEventListener("mouseleave", startHideTimer);
    searchActivator.addEventListener("touchstart", showSearchBar,{passive:true});
    topSearchBar.addEventListener("mouseleave", startHideTimer);
    topSearchBar.addEventListener("touchstart",()=>clearTimeout(hideTimer),{passive:true});

    /***********************************************************
     * 2) –ö–∞—Ä—Ç–∞
     ***********************************************************/
    const map = L.map("map", {
        zoomControl: false // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª –∑—É–º–∞
    }).setView([51.127,71.43], 12); // –¶–µ–Ω—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ê—Å—Ç–∞–Ω—É –∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∑—É–º

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map); // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª –∑—É–º–∞ —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É


    let markerClusterGroup = null;

    /***********************************************************
     * 3) –î–ê–ù–ù–´–ï –∏ –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í
     ***********************************************************/
    let markersData = [];
    let colorMode = 'status'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'status'

    let selectedStatuses = [];
    let selectedReklamas = [];
    let selectedPlans = []; // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–ü–ª–∞–Ω (–º–µ—Å)" (item.plan)
    let selectedMoves = [];
    let selectedPlanningImportances = []; // –ù–û–í–´–ô: –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–í–∞–∂–Ω–æ—Å—Ç—å" (item.planning)
    let selectedStreets = [];           // –ù–û–í–´–ô: –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–£–ª–∏—Ü–∞" (item.street)

    const allStatuses = ["—Ä–∞–±–æ—Ç–∞–µ—Ç","–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç","—Å–Ω—è—Ç —Ç–∞–±–ª–æ","–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω"];
    const allReklamas = ["led","lightbox","–Ω–µ—Ç"];
    const planMonths = [
      "–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç",
      "—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"
    ];
    const allMoves = ["—Ç—Ä–µ–±—É–µ—Ç—Å—è","–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"];
    // –ù–û–í–´–ï –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–í–∞–∂–Ω–æ—Å—Ç—å"
    const planningImportanceCategories = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "cts", "–Ω–∏–∑–∫–∏–π"];
    let allStreets = []; // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö

    /***********************************************************
     * 4) –†–∞—Å–∫—Ä–∞—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
     ***********************************************************/
    function getStatusColor(st){
      const s=(st||"").toLowerCase().trim();
      switch(s){
        case "—Ä–∞–±–æ—Ç–∞–µ—Ç":     return "#00FF00";
        case "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç":  return "#FF0000";
        case "—Å–Ω—è—Ç —Ç–∞–±–ª–æ":   return "#D3D3D3";
        case "–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω": return "#555555";
        default:             return "#FFFFFF";
      }
    }
    function getReklamaColor(rk){
      let r=(rk||"").toLowerCase().replace(/\s/g,'');
      if(["x","(x)–Ω–µ—Ç","none","x–Ω–µ—Ç", "—Ö"].includes(r)) r='–Ω–µ—Ç'; // –î–æ–±–∞–≤–∏–ª "—Ö"
      switch(r){
        case "led":      return "#FFA500";
        case "lightbox": return "#800080";
        case "–Ω–µ—Ç":      return "#00FFFF";
        default:         return "#000000";
      }
    }
    const planColors={
      "–º–∞—Ä—Ç": "#cce5ff","–∞–ø—Ä–µ–ª—å":"#99ccff","–º–∞–π":"#66b3ff","–∏—é–Ω—å":"#3399ff",
      "–∏—é–ª—å":"#0080ff","–∞–≤–≥—É—Å—Ç":"#0066cc","—Å–µ–Ω—Ç—è–±—Ä—å":"#0052a3","–æ–∫—Ç—è–±—Ä—å":"#003d7a",
      "–Ω–æ—è–±—Ä—å":"#002952","–¥–µ–∫–∞–±—Ä—å":"#001429",
    };
    function getPlanColor(pl){ // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–ü–ª–∞–Ω (–º–µ—Å)"
      const p=(pl||"").toLowerCase().trim();
      return planColors[p]||"#CCCCCC";
    }
    function getMoveColor(mv){
      const m=(mv||"").toLowerCase().trim();
      switch(m){
        case "—Ç—Ä–µ–±—É–µ—Ç—Å—è":    return "#708090";
        case "–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è": return "#8B0000";
        default:             return "#FFFFFF";
      }
    }
    // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è "–í–∞–∂–Ω–æ—Å—Ç—å" (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
    function getPlanningImportanceColor(pi) {
        const p = (pi || "").toLowerCase().trim();
        switch (p) {
            case "–≤—ã—Å–æ–∫–∏–π":  return "#28a745"; // Green
            case "—Å—Ä–µ–¥–Ω–∏–π":  return "#ffc107"; // Yellow
            case "cts":      return "#dc3545"; // Red
            case "–Ω–∏–∑–∫–∏–π":   return "#6c757d"; // Grey
            case "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç": return "#007bff"; // Blue (–¥–æ–±–∞–≤–∏–º, –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è)
            case "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å": return "#17a2b8"; // Cyan (–¥–æ–±–∞–≤–∏–º, –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è)
            default:         return "#FFFFFF"; // Default (–±–µ–ª—ã–π, –µ—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è)
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç colorMode
    function getCurrentMarkerColor(item) {
        if (colorMode === 'reklama') return getReklamaColor(item.reklama);
        if (colorMode === 'plan') return getPlanColor(item.plan); // –ü–ª–∞–Ω (–º–µ—Å)
        if (colorMode === 'move') return getMoveColor(item.move);
        if (colorMode === 'planningImportance') return getPlanningImportanceColor(item.planning); // –í–∞–∂–Ω–æ—Å—Ç—å
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –µ—Å–ª–∏ colorMode === 'status'
        return getStatusColor(item.status);
    }


    /***********************************************************
     * 5) –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–û–í
     ***********************************************************/
    function addMarkers(data){
      if(markerClusterGroup){
        map.removeLayer(markerClusterGroup);
      }

      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 60, // –°–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∏–ª –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
        iconCreateFunction: cluster => {
          const count = cluster.getChildCount();
          let size = 30 + count / 5; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞
          size = Math.min(Math.max(size, 30), 50); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞

          // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ü–≤–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
          const markers = cluster.getAllChildMarkers();
          const colorCountMap = {};
          let mostFrequentColor = '#FFF'; // –ë–µ–ª—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
          let maxCount = 0;

          markers.forEach(m => {
              const c = m.myColor || "#cccccc";
              colorCountMap[c] = (colorCountMap[c] || 0) + 1;
              if (colorCountMap[c] > maxCount) {
                  maxCount = colorCountMap[c];
                  mostFrequentColor = c;
              }
          });
          
          // –ï—Å–ª–∏ –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç —Ü–≤–µ—Ç
          const uniqueColors = Object.keys(colorCountMap);
          let clusterColor = '#DDD'; // –°–µ—Ä—ã–π –¥–ª—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö
          if (uniqueColors.length === 1) {
              clusterColor = uniqueColors[0];
          }


          return L.divIcon({
            html: `<div style="
              background-color:${clusterColor};
              border: 2px solid #555;
              border-radius:50%;
              width:${size}px; height:${size}px;
              display:flex; align-items:center;
              justify-content:center;
              color:#000;
              font-weight:bold;
              font-size: ${size/2.5}px;
            ">${count}</div>`,
            className:'cluster-icon', // –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ç–∏–ª–µ–π DivIcon –Ω–∞–ø—Ä—è–º—É—é
            iconSize:[size,size],
          });
        }
      });

      data.forEach(item => {
        const c = getCurrentMarkerColor(item); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞

        const lat = parseFloat(item.lat);
        const lng = parseFloat(item.lng);

        if (isNaN(lat) || isNaN(lng)) {
            // console.warn("Invalid coordinates for item:", item.stopName, item.lat, item.lng);
            return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        }


        let shape = "border-radius:50%;"; // –ö—Ä—É–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if((item.tabloInfo||"").toLowerCase().includes("–º–µ–¥–∏–∞–±–æ—Ä–¥")){
          shape = "border-radius:0%;"; // –ö–≤–∞–¥—Ä–∞—Ç –¥–ª—è –º–µ–¥–∏–∞–±–æ—Ä–¥–∞
        }
        const iconHTML = `
          <div style="
            width:18px; height:18px; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∏–ª –¥–ª—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ */
            background-color:${c};
            border:1px solid #000;
            ${shape}
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
          "></div>
        `;
        const icon = L.divIcon({
          className:'my-div-icon', // –í–∞–∂–Ω–æ –¥–ª—è CSS –ø—Ä–∞–≤–∏–ª background:none, border:none
          html:iconHTML,
          iconSize:[18,18],
          iconAnchor: [9, 9] // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
        });
        const marker = L.marker([lat,lng], {icon});
        marker.myColor = c; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏

        const stopNameVal = item.stopName || "(–Ω–µ—Ç)";
        const popup = `
          <div style="font-weight:bold; font-size:1.1em; margin-bottom:5px;">
            ${stopNameVal}
          </div>
          <b>ID –¢–∞–±–ª–æ:</b> ${item.tablo||"-"}<br>
          <b>–£–ª–∏—Ü–∞:</b> ${item.street||"-"}<br>
          <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${item.direction||"-"}<br>
          <b>–†–∞–π–æ–Ω:</b> ${item.district||"-"}<br>
          <b>–°—Ç–∞—Ç—É—Å:</b> ${item.status||"-"}<br>
          <b>–†–µ–∫–ª–∞–º–∞:</b> ${item.reklama||"-"}<br>
          <b>–ü–ª–∞–Ω (–º–µ—Å):</b> ${item.plan||"-"}<br>
          <b>–í–∞–∂–Ω–æ—Å—Ç—å:</b> ${item.planning||"-"}<br> <b>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ:</b> ${item.move||"-"}<br>
          <b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${item.note||"-"} `;
        marker.bindPopup(popup);
        markerClusterGroup.addLayer(marker);
      });

      map.addLayer(markerClusterGroup);
    }

    /***********************************************************
     * 6) –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
     ***********************************************************/
    function applyCombinedFilter() {
      if (!markersData || markersData.length === 0) return;

      const filtered = markersData.filter(m => {
        const s = (m.status || "").toLowerCase().trim();
        const passStatus = (selectedStatuses.length === 0) || selectedStatuses.includes(s);

        let r = (m.reklama || "").toLowerCase().replace(/\s/g, '');
        if (["x", "(x)–Ω–µ—Ç", "none", "x–Ω–µ—Ç", "—Ö"].includes(r)) r = '–Ω–µ—Ç';
        const passReklama = (selectedReklamas.length === 0) || selectedReklamas.includes(r);

        const p_month = (m.plan || "").toLowerCase().trim(); // –ü–ª–∞–Ω (–º–µ—Å—è—Ü)
        const passPlanMonth = (selectedPlans.length === 0) || selectedPlans.includes(p_month);

        const mv = (m.move || "").toLowerCase().trim();
        const passMove = (selectedMoves.length === 0) || selectedMoves.includes(mv);

        const p_importance = (m.planning || "").toLowerCase().trim(); // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤–∞–∂–Ω–æ—Å—Ç—å)
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);

        return passStatus && passReklama && passPlanMonth && passMove && passPlanningImportance && passStreet;
      });
      addMarkers(filtered);
      updateLabels(filtered.length);
    }

    function updateLabels(count){
      const total = markersData.length;
      document.getElementById("statusLabel").innerText = `${selectedStatuses.length > 0 ? selectedStatuses.join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("reklamaLabel").innerText = `${selectedReklamas.length > 0 ? selectedReklamas.join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("planLabel").innerText = `${selectedPlans.length > 0 ? selectedPlans.join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("moveLabel").innerText = `${selectedMoves.length > 0 ? selectedMoves.join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("planningImportanceLabel").innerText = `${selectedPlanningImportances.length > 0 ? selectedPlanningImportances.join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("streetLabel").innerText = `${selectedStreets.length > 0 ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—Å–µ'} (${count})`;

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏
      document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('active-filter'));
      if (colorMode === 'status') document.getElementById('statusToggle').classList.add('active-filter');
      else if (colorMode === 'reklama') document.getElementById('reklamaToggle').classList.add('active-filter');
      else if (colorMode === 'plan') document.getElementById('planToggle').classList.add('active-filter');
      else if (colorMode === 'move') document.getElementById('moveToggle').classList.add('active-filter');
      else if (colorMode === 'planningImportance') document.getElementById('planningImportanceToggle').classList.add('active-filter');
    }


    /***********************************************************
     * 7) –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
     ***********************************************************/
    let markersLoaded = false;
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç URL –æ—Ç–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–ª—è–º–∏ 'street' –∏ 'planning'
    fetch("https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec")
      .then(r => {
        if (!r.ok) { throw new Error(`HTTP error! status: ${r.status}`); }
        return r.json();
      })
      .then(data => {
        markersData = data;
        markersLoaded = true;
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —É–ª–∏—Ü –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
        allStreets = [...new Set(markersData.map(item => (item.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim()).filter(s => s))].sort();
        applyCombinedFilter(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        updateLabels(markersData.length); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö
      })
      .catch(e => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
      });

    /***********************************************************
     * 8) –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–ê–ù–ï–õ–ò (–õ–µ–≥–µ–Ω–¥–∞, –§–∏–ª—å—Ç—Ä—ã)
     ***********************************************************/
    const overlay = document.getElementById("overlay");
    const bottomPanel = document.getElementById("bottomPanel");
    const panelContentWrapper = document.getElementById("panelContentWrapper");


    function togglePanel(title, contentHtml, isScrollable = false) {
      const panelTitleElem = document.getElementById("panelTitle");
      const panelContentElem = document.getElementById("panelContent");

      if(bottomPanel.classList.contains("active") && panelTitleElem.innerText === title){
        closePanel();
      } else {
        panelTitleElem.innerText = title;
        panelContentElem.innerHTML = contentHtml;
        // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å–æ–º –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        if (isScrollable) {
            panelContentElem.classList.add("panel-content-scrollable");
        } else {
            panelContentElem.classList.remove("panel-content-scrollable");
        }
        bottomPanel.classList.add("active");
        overlay.style.display = "block";
      }
    }
    function closePanel() {
      bottomPanel.classList.remove("active");
      overlay.style.display = "none";
    }
    overlay.addEventListener("click", closePanel);

    document.getElementById("legendToggle").addEventListener("click", () => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –≤ –ª–µ–≥–µ–Ω–¥–µ, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è–º get...Color
      const legendHtml = `
        <div class="legend-section">
          <div class="legend-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</div>
          ${allStatuses.map(st => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getStatusColor(st)};"></div> ${st.charAt(0).toUpperCase() + st.slice(1)}
            </div>`).join('')}
        </div>
        <div class="legend-section">
          <div class="legend-title">–†–µ–∫–ª–∞–º–∞</div>
          ${allReklamas.map(rk => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getReklamaColor(rk)};"></div> ${rk.charAt(0).toUpperCase() + rk.slice(1)}
            </div>`).join('')}
           <div class="legend-row"> <div class="legend-icon" style="background-color:${getReklamaColor('default')}; border: 1px dashed #ccc;"></div> –î—Ä—É–≥–æ–µ
            </div>
        </div>
        <div class="legend-section">
          <div class="legend-title">–ü–ª–∞–Ω (–º–µ—Å—è—Ü)</div>
          ${planMonths.map(pl => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getPlanColor(pl)};"></div> ${pl.charAt(0).toUpperCase() + pl.slice(1)}
            </div>`).join('')}
        </div>
        <div class="legend-section">
            <div class="legend-title">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</div>
          ${allMoves.map(mv => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getMoveColor(mv)};"></div> ${mv.charAt(0).toUpperCase() + mv.slice(1)}
            </div>`).join('')}
        </div>
        <div class="legend-section">
          <div class="legend-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)</div>
          ${planningImportanceCategories.map(pi => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getPlanningImportanceColor(pi)};"></div> ${pi.charAt(0).toUpperCase() + pi.slice(1)}
            </div>`).join('')}
           <div class="legend-row"> <div class="legend-icon" style="background-color:${getPlanningImportanceColor('default')}; border: 1px dashed #ccc;"></div> –î—Ä—É–≥–æ–µ
            </div>
        </div>
        <hr style="width:100%; border-top: 1px solid #eee; margin: 10px 0;">
        <div class="legend-section">
            <div class="legend-title">–§–æ—Ä–º–∞ –º–∞—Ä–∫–µ—Ä–∞</div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:50%;"></div> –û–±—ã—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
            </div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:0%;"></div> –ú–µ–¥–∏–∞–±–æ—Ä–¥
            </div>
        </div>
      `;
      togglePanel("–õ–µ–≥–µ–Ω–¥–∞", legendHtml, true); // –õ–µ–≥–µ–Ω–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–æ–π, –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
    });

    /***********************************************************
     * 9) –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í (–û–±—â–∞—è –ª–æ–≥–∏–∫–∞)
     ***********************************************************/
    function createFilterPanelLogic(buttonId, panelTitle, itemsArray, selectedArrayRef, colorModeToSet, customClearFunction, isColorModeFilter = true) {
        document.getElementById(buttonId).addEventListener("click", () => {
            if (isColorModeFilter) {
                colorMode = colorModeToSet;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ü–≤–µ—Ç, –µ—Å–ª–∏ —ç—Ç–æ —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∂–∏–º–∞ —Ü–≤–µ—Ç–∞
                selectedStatuses = (colorModeToSet === 'status') ? selectedArrayRef : [];
                selectedReklamas = (colorModeToSet === 'reklama') ? selectedArrayRef : [];
                selectedPlans = (colorModeToSet === 'plan') ? selectedArrayRef : [];
                selectedMoves = (colorModeToSet === 'move') ? selectedArrayRef : [];
                selectedPlanningImportances = (colorModeToSet === 'planningImportance') ? selectedArrayRef : [];
                // –§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–≤–µ—Ç
            }

            let html = `<div class="filter-buttons">`;
            itemsArray.forEach(item => {
                const val = typeof item === 'object' ? item.value : item;
                const display = typeof item === 'object' ? item.display : item;
                const active = selectedArrayRef.includes(val) ? "active" : "";
                html += `<button class="${active}" onclick="toggleFilterItem('${buttonId}', '${val}')">${display}</button>`;
            });
            html += `<button class="clear-btn" onclick="clearFilterItems('${buttonId}')">–û—á–∏—Å—Ç–∏—Ç—å</button></div>`;
            
            togglePanel(panelTitle, html, itemsArray.length > 10); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –µ—Å–ª–∏ –º–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            applyCombinedFilter();
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞
        window.toggleFilterItem = function(btnId, itemValue) {
            let currentSelectedArray;
            if (btnId === 'statusToggle') currentSelectedArray = selectedStatuses;
            else if (btnId === 'reklamaToggle') currentSelectedArray = selectedReklamas;
            else if (btnId === 'planToggle') currentSelectedArray = selectedPlans;
            else if (btnId === 'moveToggle') currentSelectedArray = selectedMoves;
            else if (btnId === 'planningImportanceToggle') currentSelectedArray = selectedPlanningImportances;
            else if (btnId === 'streetToggle') currentSelectedArray = selectedStreets;

            if (currentSelectedArray.includes(itemValue)) {
                const index = currentSelectedArray.indexOf(itemValue);
                currentSelectedArray.splice(index, 1);
            } else {
                currentSelectedArray.push(itemValue);
            }
            applyCombinedFilter();
            document.getElementById(btnId).click(); // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        };

        window.clearFilterItems = function(btnId) {
            if (btnId === 'statusToggle') selectedStatuses = [];
            else if (btnId === 'reklamaToggle') selectedReklamas = [];
            else if (btnId === 'planToggle') selectedPlans = [];
            else if (btnId === 'moveToggle') selectedMoves = [];
            else if (btnId === 'planningImportanceToggle') selectedPlanningImportances = [];
            else if (btnId === 'streetToggle') selectedStreets = [];
            
            applyCombinedFilter();
            document.getElementById(btnId).click(); // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
        };
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏ –Ω–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    createFilterPanelLogic("statusToggle", "–°–æ—Å—Ç–æ—è–Ω–∏–µ", allStatuses, selectedStatuses, 'status');
    createFilterPanelLogic("reklamaToggle", "–†–µ–∫–ª–∞–º–∞", allReklamas, selectedReklamas, 'reklama');
    createFilterPanelLogic("planToggle", "–ü–ª–∞–Ω (–º–µ—Å—è—Ü)", planMonths.map(m => ({value: m, display: m.charAt(0).toUpperCase() + m.slice(1)})), selectedPlans, 'plan');
    createFilterPanelLogic("moveToggle", "–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ", allMoves, selectedMoves, 'move');
    // –ù–û–í–´–ï –§–ò–õ–¨–¢–†–´
    createFilterPanelLogic("planningImportanceToggle", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)", planningImportanceCategories.map(pi => ({value: pi, display: pi.charAt(0).toUpperCase() + pi.slice(1)})), selectedPlanningImportances, 'planningImportance');
    // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —É–ª–∏—Ü isColorModeFilter = false, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –º–µ–Ω—è–µ—Ç —Ä–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏
     document.getElementById("streetToggle").addEventListener("click", () => {
        if (!markersLoaded) {
            alert("–î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            return;
        }
        let html = `<div class="filter-buttons">`;
        allStreets.forEach(street => {
            const active = selectedStreets.includes(street) ? "active" : "";
            html += `<button class="${active}" onclick="toggleStreetFilterItem('${street}')">${street}</button>`;
        });
        html += `<button class="clear-btn" onclick="clearStreetFilterItems()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button></div>`;
        togglePanel("–§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º", html, allStreets.length > 10); // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –µ—Å–ª–∏ –º–Ω–æ–≥–æ —É–ª–∏—Ü
    });

    window.toggleStreetFilterItem = function(streetName) {
        const index = selectedStreets.indexOf(streetName);
        if (index > -1) {
            selectedStreets.splice(index, 1);
        } else {
            selectedStreets.push(streetName);
        }
        applyCombinedFilter();
        document.getElementById("streetToggle").click(); // –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    };

    window.clearStreetFilterItems = function() {
        selectedStreets = [];
        applyCombinedFilter();
        document.getElementById("streetToggle").click(); // –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    };


    /***********************************************************
     * 10) –ü–û–ò–°–ö
     ***********************************************************/
    document.getElementById("searchBtn").addEventListener("click", doSearch);
    document.getElementById("searchInput").addEventListener("keypress", e => {
      if(e.key === "Enter") doSearch();
    });

    function doSearch() {
      const query = document.getElementById("searchInput").value.toLowerCase().trim();
      if (!markersData || markersData.length === 0) return;

      // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
      if (!query) {
        applyCombinedFilter();
        return;
      }

      const filteredBySelection = markersData.filter(m => {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        const s = (m.status || "").toLowerCase().trim();
        const passStatus = (selectedStatuses.length === 0) || selectedStatuses.includes(s);

        let r = (m.reklama || "").toLowerCase().replace(/\s/g, '');
        if (["x", "(x)–Ω–µ—Ç", "none", "x–Ω–µ—Ç", "—Ö"].includes(r)) r = '–Ω–µ—Ç';
        const passReklama = (selectedReklamas.length === 0) || selectedReklamas.includes(r);

        const p_month = (m.plan || "").toLowerCase().trim();
        const passPlanMonth = (selectedPlans.length === 0) || selectedPlans.includes(p_month);

        const mv = (m.move || "").toLowerCase().trim();
        const passMove = (selectedMoves.length === 0) || selectedMoves.includes(mv);

        const p_importance = (m.planning || "").toLowerCase().trim();
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);
        
        if (!(passStatus && passReklama && passPlanMonth && passMove && passPlanningImportance && passStreet)) {
            return false; // –ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
        }

        // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        const stopNameVal = (m.stopName || "").toLowerCase();
        const tabloVal = String(m.tablo || "").toLowerCase();
        return stopNameVal.includes(query) || tabloVal.includes(query);
      });

      addMarkers(filteredBySelection);
      updateLabels(filteredBySelection.length);
    }

  </script>
</body>
</html>
