<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Color-based Clustering with Single Filter</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: sans-serif; font-size: 16px;
    }
    #map {
      width: 100%; height: 100%;
      z-index: 0;
    }
    .leaflet-top.leaflet-left {
      margin-top: 60px;
    }

    /* Панель с кнопками вверху */
    .top-panel {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 9999;
      display: flex;
      gap: 6px;
      background: #f0f0f0;
      padding: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      align-items: center;
    }
    .top-panel button {
      background: #007bff; color: #fff;
      border: none; border-radius: 5px;
      padding: 6px 10px; cursor: pointer;
    }
    .top-panel button:hover {
      background: #0056b3;
    }

    /* Фильтры */
    .top-panel button.active-filter {
      background: #0056b3;
    }

    /* Поисковая строка */
    #searchInput {
      flex: 1; 
      max-width: 300px; 
      border: 1px solid #ccc; 
      border-radius: 4px;
      padding: 4px;
    }

    /* Стили кластера (если нужно) */
    .cluster-icon {
      font-weight: bold;
      text-align: center;
    }

  </style>
</head>
<body>

<!-- Верхняя панель: Кнопки Состояние/Реклама/План + поиск -->
<div class="top-panel">
  <button id="filterStatus">Состояние</button>
  <button id="filterReklama">Реклама</button>
  <button id="filterPlan">План</button>

  <input id="searchInput" type="text" placeholder="Поиск по ID или Остановке" />
  <button id="searchBtn">Поиск</button>
</div>

<!-- Карта -->
<div id="map"></div>

<!-- Leaflet + MarkerCluster -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>

/*************************************************************
 * 1) БАЗОВАЯ ИНИЦИАЛИЗАЦИЯ КАРТЫ
 *************************************************************/
const map = L.map('map').setView([51.09, 71.45], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

/*************************************************************
 * 2) ДАННЫЕ, ФИЛЬТРЫ, РАСКРАСКА
 *************************************************************/
// Исходный массив (заполним после fetch)
let markersData = [];

// colorMode: 'status', 'reklama', 'plan'. По умолчанию 'status'.
let colorMode = 'status';

// Массивы выбранных значений (но по условию — в один момент
// мы используем только одну категорию, остальные сбрасываем)
let selectedStatuses = [];
let selectedReklamas = [];
let selectedPlans = [];

/*************************************************************
 * 2.1) ФУНКЦИИ ПОЛУЧЕНИЯ ЦВЕТА
 *************************************************************/
function getStatusColor(st) {
  const s = (st || '').toLowerCase().trim();
  switch (s) {
    case 'работает':       return '#00FF00'; // зелёный
    case 'не работает':    return '#FF0000'; // красный
    case 'снят табло':     return '#D3D3D3'; // светло-серый
    case 'демонтирован':   return '#555555'; // тёмно-серый
    default:               return '#FFFFFF';
  }
}
function getReklamaColor(rk) {
  let r = (rk || '').toLowerCase().replace(/\s/g, '');
  if (['x','(x)нет','none','xнет'].includes(r)) r='нет';
  switch (r) {
    case 'led':       return '#FFA500'; // оранж
    case 'lightbox':  return '#800080'; // фиолет
    case 'нет':       return '#00FFFF'; // бирюзовый
    default:          return '#000000';
  }
}
const planColors = {
  'март': '#cce5ff',    'апрель': '#99ccff',
  'май': '#66b3ff',     'июнь': '#3399ff',
  'июль': '#0080ff',    'август': '#0066cc',
  'сентябрь': '#0052a3','октябрь': '#003d7a',
  'ноябрь': '#002952',  'декабрь': '#001429',
};
function getPlanColor(pl) {
  const p = (pl || '').toLowerCase().trim();
  return planColors[p] || '#CCCCCC';
}

// Вычисление цвета маркера исходя из colorMode
function computeMarkerColor(item) {
  if (colorMode === 'status') {
    return getStatusColor(item.status);
  } else if (colorMode === 'reklama') {
    return getReklamaColor(item.reklama);
  } else if (colorMode === 'plan') {
    return getPlanColor(item.plan);
  }
  // fallback
  return '#FFFFFF';
}

/*************************************************************
 * 3) «ОТДЕЛЬНАЯ» КЛАСТЕР‐ГРУППА НА КАЖДЫЙ ЦВЕТ
 * Чтобы 3 зелёных объединились, а 2 красных — в другой кластер
 *************************************************************/
let currentGroups = []; // Храним текущие MarkerClusterGroup, чтобы их удалить
function addMarkers(filteredData) {
  // 1) Удаляем предыдущие группы с карты
  currentGroups.forEach(g => map.removeLayer(g));
  currentGroups = [];

  // 2) Сгруппируем маркеры по цвету
  const colorToMarkers = {};

  filteredData.forEach(item => {
    const c = computeMarkerColor(item);
    if (!colorToMarkers[c]) {
      colorToMarkers[c] = [];
    }

    // Создаём маркер
    const lat = parseFloat(item.lat) || 51.0;
    const lng = parseFloat(item.lng) || 71.4;
    let shapeStyle = 'border-radius:50%;';
    if ((item.tabloInfo||'').toLowerCase().includes('медиаборд')) {
      shapeStyle = 'border-radius:0%;';
    }
    const html = `
      <div style="
        width:20px; height:20px; 
        background-color:${c};
        border:1px solid #000;
        ${shapeStyle}
      "></div>
    `;
    const icon = L.divIcon({ html, iconSize:[20,20] });
    const marker = L.marker([lat,lng], { icon });

    // Попап 
    const stopNameVal = item.stopName || '(нет названия)';
    const popup = `
      <div style="font-weight:bold; font-size:1.1em;">
        ${stopNameVal}
      </div>
      ID Табло: ${item.tablo || '-'}<br>
      Улица: ${item.street || '-'}<br>
      Направление: ${item.direction || '-'}<br>
      Район: ${item.district || '-'}<br>
      Статус: ${item.status || '-'}<br>
      Реклама: ${item.reklama || '-'}<br>
      План: ${item.plan || '-'}
    `;
    marker.bindPopup(popup);

    colorToMarkers[c].push(marker);
  });

  // 3) Создаём для каждого цвета свою MarkerClusterGroup
  //    (maxClusterRadius=100)
  for (const [color, arr] of Object.entries(colorToMarkers)) {
    const mcg = L.markerClusterGroup({
      maxClusterRadius: 100,
      iconCreateFunction: cluster => {
        // Все маркеры тут одного цвета => просто цветной круг
        const count = cluster.getChildCount();
        return L.divIcon({
          html: `<div style="
            background-color:${color};
            width:40px; height:40px;
            border-radius:50%;
            border:2px solid #fff;
            display:flex; align-items:center; justify-content:center;
            color:#000; font-weight:bold;
          ">${count}</div>`,
          className: 'cluster-icon',
          iconSize: [40,40],
        });
      }
    });

    arr.forEach(m => mcg.addLayer(m));
    mcg.addTo(map);
    currentGroups.push(mcg);
  }
}

/*************************************************************
 * 4) САМА ФИЛЬТРАЦИЯ (Оставляем только выбранные статусы/рекламу/план)
 *************************************************************/
function applyFilter() {
  // Фильтруем markersData
  const filtered = markersData.filter(item => {
    // Фильтр статуса
    const st = (item.status||'').toLowerCase().trim();
    const passStatus = (selectedStatuses.length===0) || selectedStatuses.includes(st);

    // Фильтр рекламы
    let r = (item.reklama||'').toLowerCase().replace(/\s/g, '');
    if (['x','(x)нет','none','xнет'].includes(r)) r='нет';
    const passReklama = (selectedReklamas.length===0) || selectedReklamas.includes(r);

    // Фильтр плана
    const p = (item.plan||'').toLowerCase().trim();
    const passPlan = (selectedPlans.length===0) || selectedPlans.includes(p);

    return passStatus && passReklama && passPlan;
  });

  // Отрисуем
  addMarkers(filtered);
}

/*************************************************************
 * 5) ПОЛУЧЕНИЕ ДАННЫХ
 *************************************************************/
fetch("https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec")
  .then(r => r.json())
  .then(data => {
    markersData = data;
    // По умолчанию colorMode='status', без фильтров
    addMarkers(markersData);
  })
  .catch(e => console.error("Ошибка загрузки:", e));

/*************************************************************
 * 6) КНОПКИ: Сброс и выбор фильтра (Status / Reklama / Plan)
 *************************************************************/
document.getElementById('filterStatus').addEventListener('click', () => {
  // 1) Сбрасываем всё, ставим colorMode='status'
  colorMode = 'status';
  selectedStatuses = [];
  selectedReklamas = [];
  selectedPlans = [];
  // 2) Спрашиваем у пользователя, какие статусы он хочет (упрощённо)
  //    Здесь для наглядности просто 4 кнопки: работает, не работает, ...
  const userSel = prompt("Введите нужные статусы через запятую\n(Работает, Не работает, Снят табло, Демонтирован) или пусто:", "");
  if (!userSel) {
    // Ничего не выбрано, значит selectedStatuses пуст
    selectedStatuses = [];
  } else {
    // Разбираем
    selectedStatuses = userSel.toLowerCase().split(',').map(s=>s.trim());
  }
  // 3) Применяем фильтр
  applyFilter();
});

document.getElementById('filterReklama').addEventListener('click', () => {
  colorMode = 'reklama';
  selectedStatuses = [];
  selectedReklamas = [];
  selectedPlans = [];

  const userSel = prompt("Введите варианты рекламы (led, lightbox, нет) через запятую или пусто:", "");
  if (!userSel) {
    selectedReklamas = [];
  } else {
    selectedReklamas = userSel.toLowerCase().split(',').map(s=>s.replace(/\s/g, ''));
  }
  applyFilter();
});

document.getElementById('filterPlan').addEventListener('click', () => {
  colorMode = 'plan';
  selectedStatuses = [];
  selectedReklamas = [];
  selectedPlans = [];

  const userSel = prompt("Введите месяцы (Март, Апрель, Май...) через запятую или пусто:", "");
  if (!userSel) {
    selectedPlans = [];
  } else {
    selectedPlans = userSel.toLowerCase().split(',').map(s=>s.trim());
  }
  applyFilter();
});

/*************************************************************
 * 7) ПОИСК (stopName / tablo)
 *************************************************************/
document.getElementById('searchBtn').addEventListener('click', doSearch);
document.getElementById('searchInput').addEventListener('keypress', e => {
  if (e.key==='Enter') doSearch();
});

function doSearch() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!q) {
    // пустой -> полный фильтр
    applyFilter();
    return;
  }

  // Фильтруем markersData ещё и по поиску
  const filtered = markersData.filter(item => {
    const sn = (item.stopName||'').toLowerCase();
    const tb = String(item.tablo||'').toLowerCase();
    return sn.includes(q) || tb.includes(q);
  });

  addMarkers(filtered);
}

</script>
</body>
</html>
