<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaflet Map ‚Äî –§–∏–ª—å—Ç—Ä—ã –í–∞–∂–Ω–æ—Å—Ç—å –∏ –£–ª–∏—Ü–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π popup)</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      font-size:16px;
    }
    #map {
      width:100%;
      height:100%;
      z-index:0;
    }
    .leaflet-top.leaflet-left { /* –ü–æ–∑–∏—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∞ –∑—É–º–∞ Leaflet –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        margin-top: 10px;
    }
     #topSearchBar.show + #map .leaflet-top.leaflet-left {
        margin-top: 70px;
    }

    /* 1) –ê–≤—Ç–æ‚Äë—Å–∫—Ä—ã—Ç–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
    #searchActivator {
      position:fixed;
      top:0; left:0; right:0;
      height:10px;
      z-index:3000;
    }
    #topSearchBar {
      position:fixed;
      top:-70px;
      left:0; right:0;
      z-index:3001;
      display:flex;
      justify-content:center;
      background:rgba(255,255,255,0.9);
      padding:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
      gap:8px;
      align-items:center;
      transition: top 0.3s;
    }
    #topSearchBar.show {
      top:0;
    }
    #searchInput {
      flex:1;
      max-width:600px;
      padding:5px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:5px;
    }
    #searchBtn {
      font-size:14px;
      padding:5px 8px;
      cursor:pointer;
      border:none;
      background:#007bff;
      color:#fff;
      border-radius:5px;
      flex-shrink:0;
    }

    /* 2) –ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É */
    .control-buttons {
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-wrap: wrap;
      justify-content: center;
      gap:6px;
      z-index:1001;
    }
    .btn {
      padding:10px 16px;
      font-size:14px;
      min-width:110px;
      background-color:#007bff;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:background-color 0.3s;
      text-align:center;
      margin-bottom: 5px;
    }
    .btn.active-filter {
      background-color:#0056b3;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #0056b3;
    }
    .btn:hover {
      background-color:#0056b3;
    }
    .btn span {
      display:block;
      font-size:12px;
      color:#d1e8ff;
      margin-top:5px;
    }

    /* 3) –ü–æ–¥–ª–æ–∂–∫–∞ + –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .overlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      display:none;
      z-index:1000;
    }
    .bottom-panel {
      position:fixed;
      bottom:-100%;
      left:50%;
      transform:translateX(-50%);
      width:90%;
      max-width:500px;
      max-height: 70%;
      overflow-y: auto;
      background:#fff;
      border-radius:15px 15px 0 0;
      font-size:16px;
      padding:20px;
      box-shadow:0 -2px 15px rgba(0,0,0,0.3);
      transition:bottom 0.4s ease-in-out;
      z-index:1002;
    }
    .bottom-panel.active {
      bottom:0;
    }
    .panel-title {
      font-size:20px;
      font-weight:bold;
      margin-bottom:15px;
      color:#333;
    }
     .panel-content-scrollable {
      max-height: calc(70vh - 100px);
      overflow-y: auto;
    }

    /* 4) –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */
    .filter-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .filter-buttons button {
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:5px;
      padding:6px 12px;
      cursor:pointer;
      font-size:14px;
      transition:background 0.2s;
    }
    .filter-buttons button:hover {
      background:#0062cc;
    }
    .filter-buttons button.active {
      background:#28a745;
      color: white;
    }
    .filter-buttons button.clear-btn {
        background: #6c757d;
    }
    .filter-buttons button.clear-btn:hover {
        background: #5a6268;
    }

    /* 5) –õ–µ–≥–µ–Ω–¥–∞ */
    .legend-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .legend-section {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .legend-title {
      font-weight:bold;
      margin-bottom:5px;
    }
    .legend-row {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .legend-icon {
      width:20px;
      height:20px;
      display:inline-block;
      border-radius:50%;
      border:1px solid #000;
    }

    /* 6) MarkerCluster */
    .cluster-icon { /* –û–±—â–∏–π –∫–ª–∞—Å—Å –¥–ª—è DivIcon –∫–ª–∞—Å—Ç–µ—Ä–∞, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω */
      font-weight:bold;
      text-align:center;
    }
    .my-div-icon {
      background:none !important;
      border:none !important;
    }
     .cluster-icon-only { /* –ö–ª–∞—Å—Å –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ */
        /* –°—Ç–∏–ª–∏ –∑–∞–¥–∞—é—Ç—Å—è –∏–Ω–ª–∞–π–Ω –≤ iconCreateFunction */
    }


    /* 7) –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ */
    @media (max-width:600px){
      #searchInput {
        max-width:calc(100% - 70px);
        font-size:14px;
      }
      #searchBtn {
        font-size:12px;
        padding:4px 6px;
      }
      .control-buttons {
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .btn {
        padding:8px 10px;
        font-size:12px;
        min-width:auto;
        flex-grow: 1;
      }
      .bottom-panel {
        width:100%;
        border-radius: 15px 15px 0 0;
        font-size:14px;
        max-height: 60%;
      }
      .panel-title {
        font-size:18px;
      }
      .filter-buttons button {
        font-size:13px;
        padding:5px 10px;
      }
    }
  </style>
</head>
<body>
  <div id="searchActivator"></div>
  <div id="topSearchBar">
    <input type="text" id="searchInput" placeholder="ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"/>
    <button id="searchBtn">üîç</button>
  </div>

  <div id="map"></div>

  <div class="control-buttons">
    <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
    <button class="btn" id="planningImportanceToggle">
      –í–∞–∂–Ω–æ—Å—Ç—å <span id="planningImportanceLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="streetToggle">
      –£–ª–∏—Ü–∞ <span id="streetLabel">–í—Å–µ (0)</span>
    </button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="bottom-panel" id="bottomPanel">
    <div class="panel-title" id="panelTitle">–õ–µ–≥–µ–Ω–¥–∞</div>
    <div id="panelContentWrapper">
        <div id="panelContent" class="legend-container"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    /***********************************************************
     * 1) –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞
     ***********************************************************/
    const searchActivator = document.getElementById("searchActivator");
    const topSearchBar    = document.getElementById("topSearchBar");
    let hideTimer=null;
    function showSearchBar(){ clearTimeout(hideTimer); topSearchBar.classList.add("show"); }
    function hideSearchBar(){ topSearchBar.classList.remove("show"); }
    function startHideTimer(){ hideTimer=setTimeout(hideSearchBar,2000); }
    searchActivator.addEventListener("mouseenter", showSearchBar);
    searchActivator.addEventListener("mouseleave", startHideTimer);
    searchActivator.addEventListener("touchstart", showSearchBar,{passive:true});
    topSearchBar.addEventListener("mouseleave", startHideTimer);
    topSearchBar.addEventListener("touchstart",()=>clearTimeout(hideTimer),{passive:true});

    /***********************************************************
     * 2) –ö–∞—Ä—Ç–∞
     ***********************************************************/
    const map = L.map("map", { zoomControl: false }).setView([51.127,71.43], 12); // –¶–µ–Ω—Ç—Ä –ê—Å—Ç–∞–Ω—ã
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let markerClusterGroup = null;
    const DEFAULT_MARKER_COLOR = "#007bff"; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    /***********************************************************
     * 3) –î–ê–ù–ù–´–ï –∏ –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í
     ***********************************************************/
    let markersData = [];
    let colorMode = 'planningImportance'; // –†–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    let selectedPlanningImportances = [];
    let selectedStreets = [];

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≤–∫–ª—é—á–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    const planningImportanceCategories = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "cts", "–Ω–∏–∑–∫–∏–π", "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"];
    let allStreets = [];

    /***********************************************************
     * 4) –†–∞—Å–∫—Ä–∞—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
     ***********************************************************/
    function getPlanningImportanceColor(pi) {
        const p = (pi || "").toLowerCase().trim();
        switch (p) {
            case "–≤—ã—Å–æ–∫–∏–π":  return "#28a745"; // Green
            case "—Å—Ä–µ–¥–Ω–∏–π":  return "#ffc107"; // Yellow
            case "cts":      return "#dc3545"; // Red
            case "–Ω–∏–∑–∫–∏–π":   return "#6c757d"; // Grey
            case "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç": return "#007bff"; // Blue (–¥–ª—è "–°—É—â–µ—Å—Ç–≤—É–µ—Ç")
            case "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å": return "#17a2b8"; // Cyan (–¥–ª—è "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
            default:         return DEFAULT_MARKER_COLOR; // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö
        }
    }

    function getCurrentMarkerColor(item) {
        if (colorMode === 'planningImportance') {
            const currentPlanningValue = (item.planning || "").toLowerCase().trim();
            if (selectedPlanningImportances.length > 0) { // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏
                if (selectedPlanningImportances.includes(currentPlanningValue)) {
                    return getPlanningImportanceColor(currentPlanningValue);
                }
                return DEFAULT_MARKER_COLOR; // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –≤–∞–∂–Ω–æ—Å—Ç–∏
            } else { // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä "–í–∞–∂–Ω–æ—Å—Ç—å" –∞–∫—Ç–∏–≤–µ–Ω, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –∫—Ä–∞—Å–∏–º –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é
                return getPlanningImportanceColor(currentPlanningValue);
            }
        }
        return DEFAULT_MARKER_COLOR; // –û–±—â–∏–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    /***********************************************************
     * 5) –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–û–í
     ***********************************************************/
    function addMarkers(data){
      if(markerClusterGroup){ map.removeLayer(markerClusterGroup); }

      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 60, // –†–∞–¥–∏—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
        iconCreateFunction: cluster => {
          const count = cluster.getChildCount();
          let size = 30 + count / 10; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
          size = Math.min(Math.max(size, 30), 50); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä

          // –õ–æ–≥–∏–∫–∞ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ (–º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Å–ª–æ–∂–Ω–µ–µ)
          const markers = cluster.getAllChildMarkers();
          const colorCountMap = {};
          let mostFrequentColor = DEFAULT_MARKER_COLOR; 
          let maxCount = 0;
          markers.forEach(m => {
              const c = m.myColor || DEFAULT_MARKER_COLOR;
              colorCountMap[c] = (colorCountMap[c] || 0) + 1;
              if (colorCountMap[c] > maxCount) { maxCount = colorCountMap[c]; mostFrequentColor = c; }
          });
          const uniqueColors = Object.keys(colorCountMap);
          let clusterColor = '#DDD'; // –°–µ—Ä—ã–π –¥–ª—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
          if (uniqueColors.length === 1) { 
              clusterColor = uniqueColors[0]; // –ï—Å–ª–∏ –≤—Å–µ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
          } else if (uniqueColors.length > 1 && mostFrequentColor !== DEFAULT_MARKER_COLOR && maxCount > markers.length / 2) {
              clusterColor = mostFrequentColor; // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ü–≤–µ—Ç (–Ω–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π)
          }


          return L.divIcon({
            html: `<div style="background-color:${clusterColor}; border: 2px solid #555; border-radius:50%; width:${size}px; height:${size}px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size: ${Math.max(10, size/2.5)}px;">${count}</div>`,
            className:'cluster-icon-only', 
            iconSize:[size,size],
            iconAnchor: [size/2, size/2]
          });
        }
      });

      data.forEach(item => {
        const c = getCurrentMarkerColor(item);
        const lat = parseFloat(item.lat); 
        const lng = parseFloat(item.lng);
        if (isNaN(lat) || isNaN(lng)) { 
            // console.warn("–ü—Ä–æ–ø—É—â–µ–Ω –º–∞—Ä–∫–µ—Ä —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:", item);
            return; 
        }

        let shape = "border-radius:50%;"; // –ö—Ä—É–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if((item.tabloInfo||"").toLowerCase().includes("–º–µ–¥–∏–∞–±–æ—Ä–¥")){ shape = "border-radius:0%;"; } // –ö–≤–∞–¥—Ä–∞—Ç –¥–ª—è –º–µ–¥–∏–∞–±–æ—Ä–¥–∞
        
        const iconHTML = `<div style="width:18px; height:18px; background-color:${c}; border:1px solid #000; ${shape} box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>`;
        const icon = L.divIcon({ 
            className:'my-div-icon', 
            html:iconHTML, 
            iconSize:[18,18], 
            iconAnchor: [9, 9] // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
        });
        const marker = L.marker([lat,lng], {icon});
        marker.myColor = c; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞

        const popupContent = `
          <b>ID –¢–∞–±–ª–æ:</b> ${item.tablo || "-"}<br>
          <b>–£–ª–∏—Ü–∞:</b> ${item.street || "-"}<br>
          <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${item.direction || "-"}<br>
          <b>–†–∞–π–æ–Ω:</b> ${item.district || "-"}<br>
          <b>–ü–ª–∞–Ω (–º–µ—Å):</b> ${item.plan || "-"}<br>
          <b>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ:</b> ${item.move || "-"}<br>
          <b>–í–∞–∂–Ω–æ—Å—Ç—å:</b> ${item.planning || "-"}
        `;
        marker.bindPopup(popupContent);
        markerClusterGroup.addLayer(marker);
      });
      map.addLayer(markerClusterGroup);
    }

    /***********************************************************
     * 6) –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
     ***********************************************************/
    function applyCombinedFilter() {
      if (!markersData || markersData.length === 0) {
        if(markerClusterGroup) map.removeLayer(markerClusterGroup); // –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        updateLabels(0);
        return;
      }

      const filtered = markersData.filter(m => {
        const p_importance = (m.planning || "").toLowerCase().trim();
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);

        return passPlanningImportance && passStreet;
      });
      addMarkers(filtered);
      updateLabels(filtered.length);
    }

    function updateLabels(count){
      // const total = markersData.length; // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      document.getElementById("planningImportanceLabel").innerText = `${selectedPlanningImportances.length > 0 ? selectedPlanningImportances.map(s => s.substring(0,3)).join('/') : '–í—Å–µ'} (${count})`;
      document.getElementById("streetLabel").innerText = `${selectedStreets.length > 0 ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—Å–µ'} (${count})`;

      document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('active-filter'));
      if (colorMode === 'planningImportance') { // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏
        document.getElementById('planningImportanceToggle').classList.add('active-filter');
      }
    }

    /***********************************************************
     * 7) –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
     ***********************************************************/
    let markersLoaded = false;
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –Ω–∏–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à Google Apps Script, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
    fetch("https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec") 
      .then(r => { 
        if (!r.ok) { 
          console.error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", r);
          throw new Error(`HTTP error! status: ${r.status}`); 
        } 
        return r.json(); 
      })
      .then(data => {
        markersData = data;
        markersLoaded = true;
        allStreets = [...new Set(markersData.map(item => (item.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim()).filter(s => s))].sort();
        applyCombinedFilter(); 
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–Ω–æ–ø–∫–∞ "–í–∞–∂–Ω–æ—Å—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞, —Ç.–∫. colorMode = 'planningImportance'
        document.getElementById('planningImportanceToggle').classList.add('active-filter'); 
      })
      .catch(e => { 
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e); 
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."); 
      });

    /***********************************************************
     * 8) –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–ê–ù–ï–õ–ò
     ***********************************************************/
    const overlay = document.getElementById("overlay");
    const bottomPanel = document.getElementById("bottomPanel");
    function togglePanel(title, contentHtml, isScrollable = false) {
      const panelTitleElem = document.getElementById("panelTitle");
      const panelContentElem = document.getElementById("panelContent");
      if(bottomPanel.classList.contains("active") && panelTitleElem.innerText === title){ 
        closePanel(); 
      } else {
        panelTitleElem.innerText = title; 
        panelContentElem.innerHTML = contentHtml;
        panelContentElem.classList.toggle("panel-content-scrollable", isScrollable);
        bottomPanel.classList.add("active"); 
        overlay.style.display = "block";
      }
    }
    function closePanel() { 
      bottomPanel.classList.remove("active"); 
      overlay.style.display = "none"; 
    }
    overlay.addEventListener("click", closePanel);

    document.getElementById("legendToggle").addEventListener("click", () => {
      const legendHtml = `
        <div class="legend-section">
          <div class="legend-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)</div>
          ${planningImportanceCategories.map(pi => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getPlanningImportanceColor(pi)};"></div> ${pi.charAt(0).toUpperCase() + pi.slice(1)}
            </div>`).join('')}
           <div class="legend-row"> <div class="legend-icon" style="background-color:${getPlanningImportanceColor('–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}; border: 1px dashed #ccc;"></div> –î—Ä—É–≥–æ–µ/–ü–æ —É–º–æ–ª—á.
            </div>
        </div>
        <hr style="width:100%; border-top: 1px solid #eee; margin: 10px 0;">
        <div class="legend-section">
            <div class="legend-title">–§–æ—Ä–º–∞ –º–∞—Ä–∫–µ—Ä–∞</div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:50%; background-color: ${DEFAULT_MARKER_COLOR};"></div> –û–±—ã—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
            </div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:0%; background-color: ${DEFAULT_MARKER_COLOR};"></div> –ú–µ–¥–∏–∞–±–æ—Ä–¥
            </div>
        </div>
      `;
      togglePanel("–õ–µ–≥–µ–Ω–¥–∞", legendHtml, true); // –õ–µ–≥–µ–Ω–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–æ–π
    });

    /***********************************************************
     * 9) –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í
     ***********************************************************/
    function createGenericFilterPanel(buttonId, panelTitle, itemsArrayProvider, selectedArrayRef, colorModeToSetIfAny) {
        document.getElementById(buttonId).addEventListener("click", () => {
            if (!markersLoaded) { alert("–î–∞–Ω–Ω—ã–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è..."); return; }

            if (colorModeToSetIfAny) { 
                colorMode = colorModeToSetIfAny;
            }

            let html = `<div class="filter-buttons">`;
            const itemsArray = itemsArrayProvider(); // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–≤–∞–∂–Ω–æ –¥–ª—è allStreets)

            itemsArray.forEach(item => {
                const val = typeof item === 'object' ? item.value : item;
                const display = typeof item === 'object' ? item.display : item;
                const active = selectedArrayRef.includes(val) ? "active" : "";
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏–∏ –¥–ª—è HTML –∞—Ç—Ä–∏–±—É—Ç–∞ onclick
                const escapedVal = val.replace(/'/g, "\\'");
                html += `<button class="${active}" onclick="toggleFilterItem('${buttonId}', '${escapedVal}')">${display}</button>`;
            });
            html += `<button class="clear-btn" onclick="clearFilterItems('${buttonId}')">–û—á–∏—Å—Ç–∏—Ç—å</button></div>`;
            
            togglePanel(panelTitle, html, itemsArray.length > 10); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ –º–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            applyCombinedFilter(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–Ω–æ–ø–∫–∏ .active-filter
        });
    }
    
    window.toggleFilterItem = function(btnId, itemValue) {
        let currentSelectedArray;
        if (btnId === 'planningImportanceToggle') currentSelectedArray = selectedPlanningImportances;
        else if (btnId === 'streetToggle') currentSelectedArray = selectedStreets;

        if (currentSelectedArray) {
            const index = currentSelectedArray.indexOf(itemValue);
            if (index > -1) { currentSelectedArray.splice(index, 1); }
            else { currentSelectedArray.push(itemValue); }
        }
        applyCombinedFilter(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
        // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–µ
        // –≠–º—É–ª–∏—Ä—É–µ–º –∫–ª–∏–∫, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç —Ä–µ–∫—É—Ä—Å–∏—é –∏–ª–∏ –ª–∏—à–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        const panelButton = document.getElementById(btnId);
        if (bottomPanel.classList.contains("active") && document.getElementById("panelTitle").innerText === panelButton.textContent.split(" ")[0]) {
            panelButton.click(); // –ó–∞–∫—Ä—ã—Ç—å
            panelButton.click(); // –û—Ç–∫—Ä—ã—Ç—å —Å–Ω–æ–≤–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        } else {
           // panelButton.click(); // –ï—Å–ª–∏ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å
        }
         // –í–º–µ—Å—Ç–æ —ç–º—É–ª—è—Ü–∏–∏ –∫–ª–∏–∫–∞, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        if (bottomPanel.classList.contains("active") && document.getElementById("panelTitle").innerText === panelButton.dataset.panelTitle) {
            // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–∞–Ω–µ–ª–∏ (–µ—Å–ª–∏ createGenericFilterPanel –¥–µ–ª–∞–µ—Ç —ç—Ç–æ)
        }

    };

    window.clearFilterItems = function(btnId) {
        let panelTitleForButton = "";
        if (btnId === 'planningImportanceToggle') {
            selectedPlanningImportances = [];
            panelTitleForButton = "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)";
             // colorMode = 'planningImportance'; // –û—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º —Ä–µ–∂–∏–º–æ–º
        } else if (btnId === 'streetToggle') {
            selectedStreets = [];
            panelTitleForButton = "–§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º";
        }
        applyCombinedFilter();
        // –ß—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å –æ—Å—Ç–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã—Ç–æ–π –∏ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
        if (bottomPanel.classList.contains("active") && document.getElementById("panelTitle").innerText === panelTitleForButton) {
             document.getElementById(btnId).click(); // –ó–∞–∫—Ä—ã—Ç—å
             document.getElementById(btnId).click(); // –û—Ç–∫—Ä—ã—Ç—å —Å–Ω–æ–≤–∞
        }
    };
    
    createGenericFilterPanel(
        "planningImportanceToggle", 
        "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)", 
        () => planningImportanceCategories.map(pi => ({value: pi, display: pi.charAt(0).toUpperCase() + pi.slice(1)})), 
        selectedPlanningImportances, 
        'planningImportance'
    );
    // data-panel-title –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤ clearFilterItems –∏ toggleFilterItem
    document.getElementById("planningImportanceToggle").dataset.panelTitle = "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)";


    createGenericFilterPanel(
        "streetToggle", 
        "–§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º", 
        () => allStreets, // allStreets –±—É–¥–µ—Ç —Ñ—É–Ω–∫—Ü–∏–µ–π, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–π –º–∞—Å—Å–∏–≤
        selectedStreets, 
        null // –≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –Ω–µ –º–µ–Ω—è–µ—Ç colorMode
    );
    document.getElementById("streetToggle").dataset.panelTitle = "–§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º";


    /***********************************************************
     * 10) –ü–û–ò–°–ö
     ***********************************************************/
    document.getElementById("searchBtn").addEventListener("click", doSearch);
    document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") doSearch(); });

    function doSearch() {
      const query = document.getElementById("searchInput").value.toLowerCase().trim();
      if (!markersData || markersData.length === 0) return;
      if (!query) { applyCombinedFilter(); return; } // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã

      const filteredBySearchAndFilters = markersData.filter(m => {
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
        const p_importance = (m.planning || "").toLowerCase().trim();
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);
        
        if (!(passPlanningImportance && passStreet)) { 
            return false; // –ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        const stopNameVal = (m.stopName || "").toLowerCase(); // stopName –º–æ–∂–µ—Ç –≤—Å–µ –µ—â–µ –±—ã—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö
        const tabloVal = String(m.tablo || "").toLowerCase();
        return stopNameVal.includes(query) || tabloVal.includes(query);
      });
      addMarkers(filteredBySearchAndFilters);
      updateLabels(filteredBySearchAndFilters.length);
    }
  </script>
</body>
</html>
