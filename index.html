<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>–ö–∞—Ä—Ç–∞ –õ–∏—Å—Ç–æ–≤–∫–∏ (Sheets + Apps Script)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
    #topSearchBar {
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 1002; background: rgba(255, 255, 255, 0.9);
      padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: flex; gap: 5px; align-items: center;
    }
    #searchInput { width: 300px; padding: 5px 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
    #searchBtn { font-size: 16px; padding: 5px 10px; cursor: pointer; border: none; background: #007BFF; color: white; border-radius: 5px; }

    /* –ö–∞—Ä—Ç–∞ */
    #map { width: 100%; height: 100%; z-index: 0; }

    /* –ù–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
    .control-buttons {
      position: absolute; bottom: 20px; left: 50%;
      transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001;
    }
    .btn {
      padding: 15px 25px; background-color: #007BFF; color: white;
      border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
      transition: background-color 0.3s; min-width: 150px; text-align: center;
    }
    .btn:hover { background-color: #0056b3; }
    .btn span { display: block; font-size: 12px; color: #D1E8FF; margin-top: 5px; }

    /* –ü–∞–Ω–µ–ª—å –ª–µ–≥–µ–Ω–¥—ã –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .bottom-panel {
      position: fixed; bottom: -100%; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 500px; background-color: #fff;
      border-radius: 15px 15px 0 0; padding: 20px;
      box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.3);
      transition: bottom 0.4s ease-in-out; z-index: 1002;
    }
    .bottom-panel.active { bottom: 10%; }
    .legend-title { font-weight: bold; margin-bottom: 5px; }
    .legend-icon { width: 20px; height: 20px; display: inline-block; border-radius: 50%; border: 1px solid black; }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
    .filter-buttons button {
      padding: 10px 15px; background-color: #007BFF; color: white;
      border: none; border-radius: 8px; font-size: 14px; cursor: pointer;
      transition: background-color 0.3s;
    }
    .filter-buttons button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <div id="topSearchBar">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏—é –æ—Å—Ç–∞–Ω–æ–≤–∫–∏">
    <button id="searchBtn">üîç</button>
  </div>
  <div id="map"></div>
  <div class="control-buttons">
    <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
    <button class="btn" id="statusToggle">–°–æ—Å—Ç–æ—è–Ω–∏–µ <span id="statusLabel">–í—Å–µ</span></button>
    <button class="btn" id="reklamaToggle">–†–µ–∫–ª–∞–º–∞ <span id="reklamaLabel">–í—Å–µ</span></button>
    <button class="btn" id="planToggle">–ü–ª–∞–Ω <span id="planLabel">–í—Å–µ</span></button>
  </div>
  <div class="bottom-panel" id="bottomPanel"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([51.09, 71.45], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let markersData = [], markers = [], selectedPlanMonths = [];

    // üé® –¶–≤–µ—Ç–∞ "–ü–ª–∞–Ω–∞"
    const planColors = {
        '–º–∞—Ä—Ç': '#cce5ff', '–∞–ø—Ä–µ–ª—å': '#99ccff', '–º–∞–π': '#66b3ff',
        '–∏—é–Ω—å': '#3399ff', '–∏—é–ª—å': '#0080ff', '–∞–≤–≥—É—Å—Ç': '#0066cc',
        '—Å–µ–Ω—Ç—è–±—Ä—å': '#0052a3', '–æ–∫—Ç—è–±—Ä—å': '#003d7a', '–Ω–æ—è–±—Ä—å': '#002952',
        '–¥–µ–∫–∞–±—Ä—å': '#001429', '–Ω–µ—Ç –ø–ª–∞–Ω–∞': '#CCCCCC'
    };

    function getPlanColor(plan) {
        return planColors[plan.toLowerCase().trim()] || planColors['–Ω–µ—Ç –ø–ª–∞–Ω–∞'];
    }

    function getStatusColor(status) {
        switch (status.toLowerCase().trim()) {
            case '—Ä–∞–±–æ—Ç–∞–µ—Ç': return '#00FF00';
            case '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç': return '#FF0000';
            case '—Å–Ω—è—Ç —Ç–∞–±–ª–æ': return '#D3D3D3';
            case '–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω': return '#555555';
            default: return '#FFFFFF';
        }
    }

    function getReklamaColor(reklama) {
        switch (reklama.toLowerCase().trim()) {
            case 'led': return '#FFA500';
            case 'lightbox': return '#800080';
            case '–Ω–µ—Ç': return '#00FFFF';
            default: return '#000000';
        }
    }

    function addMarkers(data) {
        clearMarkers();
        data.forEach(marker => {
            const color = getPlanColor(marker.plan);
            const html = `<div style="background-color: ${color}; border: 1px solid black; width: 20px; height: 20px; border-radius:50%;"></div>`;
            const icon = L.divIcon({ className: 'custom-icon', html: html });
            const mapMarker = L.marker([marker.lat, marker.lng], { icon: icon }).addTo(map);
            mapMarker.bindPopup(`<strong>${marker.stop || '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</strong><br>ID: ${marker.id}`);
            markers.push(mapMarker);
        });
    }

    function clearMarkers() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
    }

    fetch('https://script.google.com/macros/s/.../exec')
      .then(response => response.json())
      .then(data => { markersData = data; addMarkers(markersData); })
      .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));

  </script>
</body>
</html>
