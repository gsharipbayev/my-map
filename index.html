<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaflet Map ‚Äî –§–∏–ª—å—Ç—Ä—ã –í–∞–∂–Ω–æ—Å—Ç—å –∏ –£–ª–∏—Ü–∞</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      font-size:16px;
    }
    #map {
      width:100%;
      height:100%;
      z-index:0;
    }
    .leaflet-top.leaflet-left { /* –ü–æ–∑–∏—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∞ –∑—É–º–∞ Leaflet –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        margin-top: 10px; /* –°–¥–≤–∏–≥–∞–µ–º —á—É—Ç—å –Ω–∏–∂–µ, –µ—Å–ª–∏ –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ */
    }
     #topSearchBar.show + #map .leaflet-top.leaflet-left {
        margin-top: 70px; /* –°–¥–≤–∏–≥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã Leaflet –≤–Ω–∏–∑, –∫–æ–≥–¥–∞ –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –≤–∏–¥–∏–º–∞ */
    }


    /* 1) –ê–≤—Ç–æ‚Äë—Å–∫—Ä—ã—Ç–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
    #searchActivator {
      position:fixed;
      top:0; left:0; right:0;
      height:10px;
      z-index:3000;
    }
    #topSearchBar {
      position:fixed;
      top:-70px;
      left:0; right:0;
      z-index:3001;
      display:flex;
      justify-content:center;
      background:rgba(255,255,255,0.9);
      padding:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
      gap:8px;
      align-items:center;
      transition: top 0.3s;
    }
    #topSearchBar.show {
      top:0;
    }
    #searchInput {
      flex:1;
      max-width:600px;
      padding:5px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:5px;
    }
    #searchBtn {
      font-size:14px;
      padding:5px 8px;
      cursor:pointer;
      border:none;
      background:#007bff;
      color:#fff;
      border-radius:5px;
      flex-shrink:0;
    }

    /* 2) –ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É */
    .control-buttons {
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-wrap: wrap;
      justify-content: center;
      gap:6px;
      z-index:1001;
    }
    .btn {
      padding:10px 16px;
      font-size:14px;
      min-width:110px;
      background-color:#007bff;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:background-color 0.3s;
      text-align:center;
      margin-bottom: 5px;
    }
    .btn.active-filter {
      background-color:#0056b3;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #0056b3;
    }
    .btn:hover {
      background-color:#0056b3;
    }
    .btn span {
      display:block;
      font-size:12px;
      color:#d1e8ff;
      margin-top:5px;
    }

    /* 3) –ü–æ–¥–ª–æ–∂–∫–∞ + –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .overlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      display:none;
      z-index:1000;
    }
    .bottom-panel {
      position:fixed;
      bottom:-100%;
      left:50%;
      transform:translateX(-50%);
      width:90%;
      max-width:500px;
      max-height: 70%;
      overflow-y: auto;
      background:#fff;
      border-radius:15px 15px 0 0;
      font-size:16px;
      padding:20px;
      box-shadow:0 -2px 15px rgba(0,0,0,0.3);
      transition:bottom 0.4s ease-in-out;
      z-index:1002;
    }
    .bottom-panel.active {
      bottom:0;
    }
    .panel-title {
      font-size:20px;
      font-weight:bold;
      margin-bottom:15px;
      color:#333;
    }
     .panel-content-scrollable {
      max-height: calc(70vh - 100px);
      overflow-y: auto;
    }

    /* 4) –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */
    .filter-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .filter-buttons button {
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:5px;
      padding:6px 12px;
      cursor:pointer;
      font-size:14px;
      transition:background 0.2s;
    }
    .filter-buttons button:hover {
      background:#0062cc;
    }
    .filter-buttons button.active {
      background:#28a745;
      color: white;
    }
    .filter-buttons button.clear-btn {
        background: #6c757d;
    }
    .filter-buttons button.clear-btn:hover {
        background: #5a6268;
    }

    /* 5) –õ–µ–≥–µ–Ω–¥–∞ */
    .legend-container { /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–µ–∫—Ü–∏–π –ª–µ–≥–µ–Ω–¥—ã */
        display: flex;
        flex-direction: column; /* –°–µ–∫—Ü–∏–∏ –æ–¥–Ω–∞ –ø–æ–¥ –¥—Ä—É–≥–æ–π */
        gap: 15px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏ */
    }
    .legend-section {
      display:flex;
      flex-direction:column;
      gap:10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ */
    }
    .legend-title {
      font-weight:bold;
      margin-bottom:5px;
    }
    .legend-row {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .legend-icon {
      width:20px;
      height:20px;
      display:inline-block;
      border-radius:50%;
      border:1px solid #000;
    }

    /* 6) MarkerCluster */
    .cluster-icon {
      font-weight:bold;
      text-align:center;
    }
    .my-div-icon { /* –î–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∏–ª–µ–π leaflet –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è divIcon */
      background:none !important;
      border:none !important;
    }

    /* 7) –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ */
    @media (max-width:600px){
      #searchInput {
        max-width:calc(100% - 70px);
        font-size:14px;
      }
      #searchBtn {
        font-size:12px;
        padding:4px 6px;
      }
      .control-buttons {
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .btn {
        padding:8px 10px;
        font-size:12px;
        min-width:auto;
        flex-grow: 1;
      }
      .bottom-panel {
        width:100%;
        border-radius: 15px 15px 0 0;
        font-size:14px;
        max-height: 60%;
      }
      .panel-title {
        font-size:18px;
      }
      .filter-buttons button {
        font-size:13px;
        padding:5px 10px;
      }
    }
  </style>
</head>
<body>
  <div id="searchActivator"></div>
  <div id="topSearchBar">
    <input type="text" id="searchInput" placeholder="ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"/>
    <button id="searchBtn">üîç</button>
  </div>

  <div id="map"></div>

  <div class="control-buttons">
    <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
    <button class="btn" id="planningImportanceToggle">
      –í–∞–∂–Ω–æ—Å—Ç—å <span id="planningImportanceLabel">–í—Å–µ (0)</span>
    </button>
    <button class="btn" id="streetToggle">
      –£–ª–∏—Ü–∞ <span id="streetLabel">–í—Å–µ (0)</span>
    </button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="bottom-panel" id="bottomPanel">
    <div class="panel-title" id="panelTitle">–õ–µ–≥–µ–Ω–¥–∞</div>
    <div id="panelContentWrapper">
        <div id="panelContent" class="legend-container"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    /***********************************************************
     * 1) –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
     ***********************************************************/
    const searchActivator = document.getElementById("searchActivator");
    const topSearchBar    = document.getElementById("topSearchBar");
    let hideTimer=null;
    function showSearchBar(){ clearTimeout(hideTimer); topSearchBar.classList.add("show"); }
    function hideSearchBar(){ topSearchBar.classList.remove("show"); }
    function startHideTimer(){ hideTimer=setTimeout(hideSearchBar,2000); }
    searchActivator.addEventListener("mouseenter", showSearchBar);
    searchActivator.addEventListener("mouseleave", startHideTimer);
    searchActivator.addEventListener("touchstart", showSearchBar,{passive:true});
    topSearchBar.addEventListener("mouseleave", startHideTimer);
    topSearchBar.addEventListener("touchstart",()=>clearTimeout(hideTimer),{passive:true});

    /***********************************************************
     * 2) –ö–∞—Ä—Ç–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
     ***********************************************************/
    const map = L.map("map", { zoomControl: false }).setView([51.127,71.43], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let markerClusterGroup = null;
    const DEFAULT_MARKER_COLOR = "#007bff"; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤

    /***********************************************************
     * 3) –î–ê–ù–ù–´–ï –∏ –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í (—É–ø—Ä–æ—â–µ–Ω–æ)
     ***********************************************************/
    let markersData = [];
    let colorMode = 'planningImportance'; // –†–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    let selectedPlanningImportances = [];
    let selectedStreets = [];

    const planningImportanceCategories = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "cts", "–Ω–∏–∑–∫–∏–π", "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"]; // –î–æ–±–∞–≤–ª–µ–Ω—ã "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
    let allStreets = [];

    /***********************************************************
     * 4) –†–∞—Å–∫—Ä–∞—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–æ)
     ***********************************************************/
    function getPlanningImportanceColor(pi) {
        const p = (pi || "").toLowerCase().trim();
        switch (p) {
            case "–≤—ã—Å–æ–∫–∏–π":  return "#28a745"; // Green
            case "—Å—Ä–µ–¥–Ω–∏–π":  return "#ffc107"; // Yellow
            case "cts":      return "#dc3545"; // Red
            case "–Ω–∏–∑–∫–∏–π":   return "#6c757d"; // Grey
            case "—Å—É—â–µ—Å—Ç–≤—É–µ—Ç": return "#007bff"; // Blue
            case "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å": return "#17a2b8"; // Cyan
            default:         return DEFAULT_MARKER_COLOR; // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏–ª–∏ –¥–ª—è "–î—Ä—É–≥–æ–µ"
        }
    }

    function getCurrentMarkerColor(item) {
        if (colorMode === 'planningImportance' && selectedPlanningImportances.length > 0) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤–∞–∂–Ω–æ—Å—Ç–∏, –∫—Ä–∞—Å–∏–º –ø–æ –Ω–∏–º
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ item.planning –µ—Å—Ç—å —Å—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            const currentPlanningValue = (item.planning || "").toLowerCase().trim();
            if (selectedPlanningImportances.includes(currentPlanningValue)) {
                 return getPlanningImportanceColor(currentPlanningValue);
            }
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –Ω–µ –≤ —Ñ–∏–ª—å—Ç—Ä–µ, –Ω–æ —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ü–≤–µ—Ç "–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç" –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
            return DEFAULT_MARKER_COLOR; // –ò–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö
        }
         if (colorMode === 'planningImportance' && selectedPlanningImportances.length === 0) {
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–í–∞–∂–Ω–æ—Å—Ç—å" –∞–∫—Ç–∏–≤–µ–Ω, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –∫—Ä–∞—Å–∏–º –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é item.planning
            return getPlanningImportanceColor(item.planning);
        }
        return DEFAULT_MARKER_COLOR; // –û–±—â–∏–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–∏–∫–∞–∫–æ–π —Ä–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã —Å–Ω—è—Ç—ã
    }

    /***********************************************************
     * 5) –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–û–í (popup –æ–±–Ω–æ–≤–ª–µ–Ω)
     ***********************************************************/
    function addMarkers(data){
      if(markerClusterGroup){ map.removeLayer(markerClusterGroup); }

      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 60,
        iconCreateFunction: cluster => {
          const count = cluster.getChildCount();
          let size = 30 + count / 5; size = Math.min(Math.max(size, 30), 50);
          const markers = cluster.getAllChildMarkers();
          const colorCountMap = {};
          let mostFrequentColor = DEFAULT_MARKER_COLOR;
          let maxCount = 0;
          markers.forEach(m => {
              const c = m.myColor || DEFAULT_MARKER_COLOR;
              colorCountMap[c] = (colorCountMap[c] || 0) + 1;
              if (colorCountMap[c] > maxCount) { maxCount = colorCountMap[c]; mostFrequentColor = c; }
          });
          const uniqueColors = Object.keys(colorCountMap);
          let clusterColor = '#DDD'; if (uniqueColors.length === 1) { clusterColor = uniqueColors[0]; }

          return L.divIcon({
            html: `<div style="background-color:${clusterColor}; border: 2px solid #555; border-radius:50%; width:${size}px; height:${size}px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size: ${size/2.5}px;">${count}</div>`,
            className:'cluster-icon-only', iconSize:[size,size],
          });
        }
      });

      data.forEach(item => {
        const c = getCurrentMarkerColor(item);
        const lat = parseFloat(item.lat); const lng = parseFloat(item.lng);
        if (isNaN(lat) || isNaN(lng)) { return; }

        let shape = "border-radius:50%;";
        if((item.tabloInfo||"").toLowerCase().includes("–º–µ–¥–∏–∞–±–æ—Ä–¥")){ shape = "border-radius:0%;"; }
        const iconHTML = `<div style="width:18px; height:18px; background-color:${c}; border:1px solid #000; ${shape} box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>`;
        const icon = L.divIcon({ className:'my-div-icon', html:iconHTML, iconSize:[18,18], iconAnchor: [9, 9] });
        const marker = L.marker([lat,lng], {icon});
        marker.myColor = c;

        const stopNameVal = item.stopName || "(–Ω–µ—Ç)";
        // –ü–æ–ª—è –∏–∑ –≤–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è popup
        const popup = `
          <div style="font-weight:bold; font-size:1.1em; margin-bottom:5px;">${stopNameVal}</div>
          <b>ID –¢–∞–±–ª–æ:</b> ${item.tablo||"-"}<br>
          <b>–£–ª–∏—Ü–∞:</b> ${item.street||"-"}<br>
          <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${item.direction||"-"}<br>
          <b>–†–∞–π–æ–Ω:</b> ${item.district||"-"}<br>
          <b>–¢–∏–ø –ø–∞–≤–∏–ª—å–æ–Ω–∞:</b> ${item.pavilionType||"-"}<br>
          <b>–û–±—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> ${item.outfit||"-"}<br>
          <b>–¢–∞–±–ª–æ:</b> ${item.tabloInfo||"-"}<br>
          <b>–û—á–µ—Ä–µ–¥—å ITS:</b> ${item.itsQueue||"-"}<br>
          <b>–°—Ç–∞—Ç—É—Å:</b> ${item.status||"-"}<br> <b>–†–µ–∫–ª–∞–º–∞:</b> ${item.reklama||"-"}<br> <b>–ü–ª–∞–Ω (–º–µ—Å):</b> ${item.plan||"-"}<br> <b>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ:</b> ${item.move||"-"}<br> <b>–í–∞–∂–Ω–æ—Å—Ç—å:</b> ${item.planning||"-"}<br> <b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${item.note||"-"}
        `;
        marker.bindPopup(popup);
        markerClusterGroup.addLayer(marker);
      });
      map.addLayer(markerClusterGroup);
    }

    /***********************************************************
     * 6) –§–ò–õ–¨–¢–†–ê–¶–ò–Ø (—É–ø—Ä–æ—â–µ–Ω–æ)
     ***********************************************************/
    function applyCombinedFilter() {
      if (!markersData || markersData.length === 0) return;

      const filtered = markersData.filter(m => {
        const p_importance = (m.planning || "").toLowerCase().trim();
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);

        return passPlanningImportance && passStreet;
      });
      addMarkers(filtered);
      updateLabels(filtered.length);
    }

    function updateLabels(count){
      const total = markersData.length;
      document.getElementById("planningImportanceLabel").innerText = `${selectedPlanningImportances.length > 0 ? selectedPlanningImportances.map(s => s.substring(0,3)).join(', ') : '–í—Å–µ'} (${count})`;
      document.getElementById("streetLabel").innerText = `${selectedStreets.length > 0 ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—Å–µ'} (${count})`;

      document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('active-filter'));
      if (colorMode === 'planningImportance') {
        document.getElementById('planningImportanceToggle').classList.add('active-filter');
      }
    }

    /***********************************************************
     * 7) –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ, URL –ø—Ä–æ–≤–µ—Ä—å—Ç–µ)
     ***********************************************************/
    let markersLoaded = false;
    fetch("https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec")
      .then(r => { if (!r.ok) { throw new Error(`HTTP error! status: ${r.status}`); } return r.json(); })
      .then(data => {
        markersData = data;
        markersLoaded = true;
        allStreets = [...new Set(markersData.map(item => (item.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim()).filter(s => s))].sort();
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        // selectedPlanningImportances = ['–≤—ã—Å–æ–∫–∏–π']; // –ü—Ä–∏–º–µ—Ä: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–≤—ã—Å–æ–∫–∏–π"
        applyCombinedFilter();
        updateLabels(markersData.length);
        if (selectedPlanningImportances.length > 0) { // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
             document.getElementById('planningImportanceToggle').classList.add('active-filter');
        }
      })
      .catch(e => { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e); alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ."); });

    /***********************************************************
     * 8) –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–ê–ù–ï–õ–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
     ***********************************************************/
    const overlay = document.getElementById("overlay");
    const bottomPanel = document.getElementById("bottomPanel");
    function togglePanel(title, contentHtml, isScrollable = false) {
      const panelTitleElem = document.getElementById("panelTitle");
      const panelContentElem = document.getElementById("panelContent");
      if(bottomPanel.classList.contains("active") && panelTitleElem.innerText === title){ closePanel(); }
      else {
        panelTitleElem.innerText = title; panelContentElem.innerHTML = contentHtml;
        panelContentElem.classList.toggle("panel-content-scrollable", isScrollable);
        bottomPanel.classList.add("active"); overlay.style.display = "block";
      }
    }
    function closePanel() { bottomPanel.classList.remove("active"); overlay.style.display = "none"; }
    overlay.addEventListener("click", closePanel);

    document.getElementById("legendToggle").addEventListener("click", () => {
      const legendHtml = `
        <div class="legend-section">
          <div class="legend-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)</div>
          ${planningImportanceCategories.map(pi => `
            <div class="legend-row">
              <div class="legend-icon" style="background-color:${getPlanningImportanceColor(pi)};"></div> ${pi.charAt(0).toUpperCase() + pi.slice(1)}
            </div>`).join('')}
           <div class="legend-row">
              <div class="legend-icon" style="background-color:${getPlanningImportanceColor('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}; border: 1px dashed #ccc;"></div> –î—Ä—É–≥–æ–µ/–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            </div>
        </div>
        <hr style="width:100%; border-top: 1px solid #eee; margin: 10px 0;">
        <div class="legend-section">
            <div class="legend-title">–§–æ—Ä–º–∞ –º–∞—Ä–∫–µ—Ä–∞</div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:50%; background-color: ${DEFAULT_MARKER_COLOR};"></div> –û–±—ã—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
            </div>
            <div class="legend-row">
                <div class="legend-icon" style="border-radius:0%; background-color: ${DEFAULT_MARKER_COLOR};"></div> –ú–µ–¥–∏–∞–±–æ—Ä–¥
            </div>
        </div>
      `;
      togglePanel("–õ–µ–≥–µ–Ω–¥–∞", legendHtml, true);
    });

    /***********************************************************
     * 9) –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í (—É–ø—Ä–æ—â–µ–Ω–æ)
     ***********************************************************/
    function createGenericFilterPanel(buttonId, panelTitle, itemsArray, selectedArrayRef, colorModeToSetIfAny) {
        document.getElementById(buttonId).addEventListener("click", () => {
            if (colorModeToSetIfAny) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –º–µ–Ω—è–µ—Ç —Ä–µ–∂–∏–º —Ü–≤–µ—Ç–∞
                colorMode = colorModeToSetIfAny;
                 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ "—Ü–≤–µ—Ç–æ–≤—ã–µ" —Ñ–∏–ª—å—Ç—Ä—ã, –µ—Å–ª–∏ –µ—Å—Ç—å (–∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∞–∫–æ–π)
                if (colorModeToSetIfAny === 'planningImportance') {
                    // selectedStreets –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç.–∫. —ç—Ç–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Ñ–∏–ª—å—Ç—Ä
                }
            }

            let html = `<div class="filter-buttons">`;
            const itemSource = (typeof itemsArray === 'function') ? itemsArray() : itemsArray;

            itemSource.forEach(item => {
                const val = typeof item === 'object' ? item.value : item;
                const display = typeof item === 'object' ? item.display : item;
                const active = selectedArrayRef.includes(val) ? "active" : "";
                html += `<button class="${active}" onclick="toggleFilterItem('${buttonId}', '${val.replace(/'/g, "\\'")}')">${display}</button>`;
            });
            html += `<button class="clear-btn" onclick="clearFilterItems('${buttonId}')">–û—á–∏—Å—Ç–∏—Ç—å</button></div>`;
            
            togglePanel(panelTitle, html, itemSource.length > 10);
            applyCombinedFilter(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è colorMode
        });
    }
    
    window.toggleFilterItem = function(btnId, itemValue) {
        let currentSelectedArray;
        if (btnId === 'planningImportanceToggle') currentSelectedArray = selectedPlanningImportances;
        else if (btnId === 'streetToggle') currentSelectedArray = selectedStreets;

        if (currentSelectedArray) {
            const index = currentSelectedArray.indexOf(itemValue);
            if (index > -1) { currentSelectedArray.splice(index, 1); }
            else { currentSelectedArray.push(itemValue); }
        }
        applyCombinedFilter();
        document.getElementById(btnId).click(); // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
    };

    window.clearFilterItems = function(btnId) {
        if (btnId === 'planningImportanceToggle') {
            selectedPlanningImportances = [];
            // colorMode = 'default'; // –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å 'planningImportance', –Ω–æ –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        } else if (btnId === 'streetToggle') {
            selectedStreets = [];
        }
        applyCombinedFilter();
        document.getElementById(btnId).click(); // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
    };
    
    createGenericFilterPanel("planningImportanceToggle", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–∞–∂–Ω–æ—Å—Ç—å)", planningImportanceCategories.map(pi => ({value: pi, display: pi.charAt(0).toUpperCase() + pi.slice(1)})), selectedPlanningImportances, 'planningImportance');
    createGenericFilterPanel("streetToggle", "–§–∏–ª—å—Ç—Ä –ø–æ —É–ª–∏—Ü–∞–º", () => allStreets, selectedStreets, null); // null - –Ω–µ –º–µ–Ω—è–µ—Ç colorMode


    /***********************************************************
     * 10) –ü–û–ò–°–ö (—É–ø—Ä–æ—â–µ–Ω–æ)
     ***********************************************************/
    document.getElementById("searchBtn").addEventListener("click", doSearch);
    document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") doSearch(); });

    function doSearch() {
      const query = document.getElementById("searchInput").value.toLowerCase().trim();
      if (!markersData || markersData.length === 0) return;
      if (!query) { applyCombinedFilter(); return; }

      const filteredBySelection = markersData.filter(m => {
        const p_importance = (m.planning || "").toLowerCase().trim();
        const passPlanningImportance = (selectedPlanningImportances.length === 0) || selectedPlanningImportances.includes(p_importance);

        const str = (m.street || "–ë–µ–∑ —É–ª–∏—Ü—ã").trim();
        const passStreet = (selectedStreets.length === 0) || selectedStreets.includes(str);
        
        if (!(passPlanningImportance && passStreet)) { return false; }

        const stopNameVal = (m.stopName || "").toLowerCase();
        const tabloVal = String(m.tablo || "").toLowerCase();
        return stopNameVal.includes(query) || tabloVal.includes(query);
      });
      addMarkers(filteredBySelection);
      updateLabels(filteredBySelection.length);
    }
  </script>
</body>
</html>
