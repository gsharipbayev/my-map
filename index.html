<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet Map (Sheets + Apps Script)</title>
  
  <!-- Подключаем Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>

  <style>
    /* Карта на весь экран */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* Кнопка переключения слоёв */
    .toggle-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 9999; /* чтобы не перекрывалась картой */
      padding: 10px 15px;
      background-color: #fff;
      border: 2px solid #666;
      border-radius: 5px;
      cursor: pointer;
      font-family: sans-serif;
      font-size: 14px;
    }
    .toggle-btn:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toggle-btn" id="toggleBtn">Показать НЕ_работает</div>

  <!-- Подключаем Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
    // 1) Инициализируем карту
    var map = L.map('map').setView([51.09, 71.45], 11);

    // 2) Подключаем тайлы (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // 3) ВАША ссылка на задеплоенный скрипт
    var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

    /* -------------------------------------------------------------------
       ФУНКЦИИ ДЛЯ ОПРЕДЕЛЕНИЯ ЦВЕТОВ
       ------------------------------------------------------------------- */

    // Цвет заливки по статусу (столбец M):
    // "работает" => #00FF00 (ярко-зеленый)
    // "не работает" => #FF0000 (красный)
    // "снят" => #AAAAAA (ярко-серый)
    // "демонтирован" => #555555 (темно-серый)
    function getStatusFill(status) {
      var st = status.toLowerCase();
      if (st.includes('работает')) {
        return '#00FF00';
      } else if (st.includes('не работает')) {
        return '#FF0000';
      } else if (st.includes('снят')) {
        return '#AAAAAA';
      } else if (st.includes('демонт')) {
        return '#555555';
      }
      // по умолчанию
      return '#FFFFFF';
    }

    // Цвет обводки для "рабочего" (по рекламе, столбец R)
    // LED => жирная красная обводка (#FF0000) + белая тонкая (#FFFFFF)
    // Lightbox => жирная синяя (#0000FF) + белая тонкая (#FFFFFF)
    // None => жирная зеленая (#00FF00) + черная тонкая (#000000)
    // Иначе по умолчанию => (outer:#000000, inner:#FFFFFF)
    function getReklamaBorder(reklama) {
      switch (reklama) {
        case 'LED':
          return { outer: '#FF0000', inner: '#FFFFFF' };
        case 'Lightbox':
          return { outer: '#0000FF', inner: '#FFFFFF' };
        case 'X':
          return { outer: '#00FF00', inner: '#000000' };
        default:
          return { outer: '#000000', inner: '#FFFFFF' };
      }
    }

    // Цвет обводки для "нерабочего" (по питанию, столбец S)
    // если "да" => жирная ярко-зелёная (#00FF00) + белая тонкая (#FFFFFF)
    // если "нет" => жирная ярко-красная (#FF0000) + белая тонкая (#FFFFFF)
    // иначе по умолчанию => (outer:#000000, inner:#FFFFFF)
    function getPowerBorder(powerValue) {
      var val = powerValue.toLowerCase().trim();
      if (val === 'да') {
        return { outer: '#00FF00', inner: '#FFFFFF' };
      } else if (val === 'нет') {
        return { outer: '#FF0000', inner: '#FFFFFF' };
      } else {
        return { outer: '#000000', inner: '#FFFFFF' };
      }
    }

    /* -------------------------------------------------------------------
       СОЗДАНИЕ КАСТОМНОГО ICON
       ------------------------------------------------------------------- */

    // Единственная точка входа для создания иконок
    // - status (для заливки)
    // - reklama (для рабочей обводки)
    // - power (для нерабочей обводки)
    // - isTablo (true => круг, false => квадрат)
    // - isWorking (true => рекламная обводка, false => обводка по питанию)
    function createCustomIcon(status, reklama, power, isTablo, isWorking) {
      // fillColor => статус
      var fillColor = getStatusFill(status);

      // borderColors => реклама (если isWorking), питание (если неWorking)
      var borderColors = isWorking
        ? getReklamaBorder(reklama)
        : getPowerBorder(power);

      var shape = isTablo ? '50%' : '0'; // круг/квадрат

      // Составим inline-стиль:
      //  - ширина/высота 16px
      //  - background-color = fillColor
      //  - 4px solid border = outer
      //  - тонкая внутренняя граница (1px) => box-shadow: inset 0 0 0 1px inner
      //  - border-radius = shape (50% => круг)
      var style = [
        'width:16px',
        'height:16px',
        'border-radius:' + shape,
        'background-color:' + fillColor,
        'border:4px solid ' + borderColors.outer,
        'box-shadow: inset 0 0 0 1px ' + borderColors.inner
      ].join(';');

      var html = '<div style="' + style + '"></div>';

      return L.divIcon({
        html: html,
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        className: ''
      });
    }

    /* -------------------------------------------------------------------
       СЛОИ (ГРУППЫ МАРКЕРОВ) + КНОПКА ПЕРЕКЛЮЧЕНИЯ
       ------------------------------------------------------------------- */
    var workingGroup = L.layerGroup();    // для "работает"
    var notWorkingGroup = L.layerGroup(); // для "не работает", "снят табло", "демонтирован"

    var showWorking = true; // по умолчанию включаем рабочие

    function toggleLayers() {
      if (showWorking) {
        map.removeLayer(workingGroup);
        map.addLayer(notWorkingGroup);
        document.getElementById("toggleBtn").textContent = "Показать РАБОТАЕТ";
        showWorking = false;
      } else {
        map.removeLayer(notWorkingGroup);
        map.addLayer(workingGroup);
        document.getElementById("toggleBtn").textContent = "Показать НЕ_работает";
        showWorking = true;
      }
    }

    document.getElementById('toggleBtn').addEventListener('click', toggleLayers);

    /* -------------------------------------------------------------------
       ЗАГРУЗКА ДАННЫХ
       ------------------------------------------------------------------- */
    fetch(url)
      .then(function(response){
        return response.json();
      })
      .then(function(data){
        console.log("Данные:", data);

        data.forEach(function(item){
          var lat = parseFloat(item.lat);
          var lng = parseFloat(item.lng);
          if (isNaN(lat) || isNaN(lng)) {
            return; // пропускаем некорректные координаты
          }

          var statusRaw = (item.status || '').trim();
          var stLower = statusRaw.toLowerCase();

          // Разделяем на рабочую/нерабочую группу
          var isWorking = stLower.includes('работает');
          var isNotWorking = (
            stLower.includes('не работает') ||
            stLower.includes('снят') ||
            stLower.includes('демонт')
          );

          // если статус не подходит ни туда, ни сюда, пропустим
          if (!isWorking && !isNotWorking) {
            console.log('Неизвестный статус', statusRaw);
            return;
          }

          // тип (M) => "Табло" / "Медиаборд"
          var typeMRaw = (item.tablo || '').toLowerCase();
          var isTablo = typeMRaw.includes('табло'); // иначе медиаборд

          // рекламу берём из item.reklama
          var reklama = (item.reklama || '').trim();
          // питание (S)
          var power = (item.power || '').trim(); // "да" / "нет" / etc.

          // Создаём кастомный маркер
          var markerIcon = createCustomIcon(
            statusRaw,       // для заливки
            reklama,         // для рабочей обводки
            power,           // для нерабочей обводки
            isTablo,         // форма
            isWorking        // выбор обводки
          );

          var marker = L.marker([lat, lng], { icon: markerIcon });

          // popup
          var popupHtml =
            '<b>Название остановки:</b> ' + (item.stopName || '') + '<br>' +
            '<b>Улица:</b> ' + (item.street || '') + '<br>' +
            '<b>Направление:</b> ' + (item.direction || '') + '<br>' +
            '<b>Район:</b> ' + (item.region || '') + '<br>' +
            '<b>ID Остановки:</b> ' + (item.stopId || '') + '<br>' +
            '<b>Статус:</b> ' + (item.status || '') + '<br>' +
            '<b>Реклама:</b> ' + (item.reklama || '') + '<br>' +
            '<b>Питание (S):</b> ' + (item.power || '');

          marker.bindPopup(popupHtml);

          // Добавляем в нужную группу
          if (isWorking) {
            workingGroup.addLayer(marker);
          } else {
            notWorkingGroup.addLayer(marker);
          }
        });

        // по умолчанию показываем "рабочие"
        workingGroup.addTo(map);
      })
      .catch(function(err){
        console.error("Ошибка при загрузке JSON:", err);
      });
  </script>
</body>
</html>
