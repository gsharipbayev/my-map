<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet Map (Sheets + Apps Script)</title>
  
  <!-- Подключаем Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  
  <style>
    /* Карта на весь экран */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Подключаем Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  
  <script>
    // 1) Инициализируем карту Leaflet
    var map = L.map('map').setView([51.09, 71.45], 11); // При желании поменяйте координаты/зум
    
    // 2) Подключаем тайлы (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // 3) Укажите ВАШУ ссылку на задеплоенный скрипт
    var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

    // a) Определяем цвет обводки
    function getBorderColor(item) {
      // Если "Пассажирообразующий" (P) = "+"
      if (item.passenger === "+") {
        return "black";
      }
      // Иначе по рекламе (R)
      switch (item.reklama) {
        case "LED":
          return "green";
        case "Lightbox":
          return "blue";
        case "X":
          return "red";
        default:
          return "black"; // по умолчанию
      }
    }

    // b) Определяем цвет заливки (только для остановок с табло)
    function getFillColorByStatus(status) {
      // статус (Q)
      switch (status) {
        case "работает":
          return "#00FF00"; // ярко-зелёный
        case "не работает":
          return "#FF0000"; // ярко-красный
        case "демонтирован":
          return "gray";    // серый
        default:
          return "white";   // если статус незнакомый, делаем белый
      }
    }

    // 4) Загружаем JSON
    fetch(url)
      .then(response => response.json())
      .then(data => {
        console.log("Данные из Apps Script:", data); // Посмотрите в консоли, что реально приходит

        data.forEach(function(item) {
          // Преобразуем широту/долготу в числа
          var lat = parseFloat(item.lat);
          var lng = parseFloat(item.lng);
          if (isNaN(lat) || isNaN(lng)) {
            // Если координаты некорректны, пропускаем
            return;
          }

          // Получаем цвет обводки
          var borderColor = getBorderColor(item);

          // Проверяем, есть ли табло (столбец M) — достаточно, чтобы было непустое значение
          if (item.tablo && item.tablo.trim() !== "") {
            // --- ОСТАНОВКА С ТАБЛО => КВАДРАТ ---
            var fillColor = getFillColorByStatus(item.status);

            // Создаём divIcon, где через inline-стиль делаем квадрат
            var squareIcon = L.divIcon({
              html:
                '<div style="width:16px; height:16px; ' +
                'background-color:' + fillColor + '; ' +
                'border: 2px solid ' + borderColor + '; ' +
                'border-radius: 0;">' +
                '</div>',
              iconSize: [16, 16],
              iconAnchor: [8, 8], // чтобы центр квадрата совпадал с координатой
              className: ''       // убираем дефолтные стили Leaflet
            });

            var marker = L.marker([lat, lng], { icon: squareIcon }).addTo(map);

          } else {
            // --- ОСТАНОВКА БЕЗ ТАБЛО => КРУГ ---
            // Цвет заливки — белый
            var circle = L.circleMarker([lat, lng], {
              radius: 8,
              fillColor: "white",
              fillOpacity: 1,
              color: borderColor, // обводка
              weight: 2
            }).addTo(map);

            var marker = circle; // чтобы далее .bindPopup(marker)
          }

          // Формируем HTML-текст всплывающего окна
          // 1) Название остановки (C)
          // 2) Улица (B)
          // 3) Направление (D)
          // 4) Район (E)
          // 5) ID Остановки (H)
          // 6) Статус (Q)
          // 7) Реклама (R)
          var popupHtml =
            "<b>Название остановки:</b> " + (item.stopName || "") + "<br>" +
            "<b>Улица:</b> " + (item.street || "") + "<br>" +
            "<b>Направление:</b> " + (item.direction || "") + "<br>" +
            "<b>Район:</b> " + (item.region || "") + "<br>" +
            "<b>ID Остановки:</b> " + (item.stopId || "") + "<br>" +
            "<b>Статус:</b> " + (item.status || "") + "<br>" +
            "<b>Реклама:</b> " + (item.reklama || "");

          // Привязываем popup
          marker.bindPopup(popupHtml);
        });
      })
      .catch(err => {
        console.error("Ошибка при загрузке JSON:", err);
      });
  </script>
</body>
</html>
