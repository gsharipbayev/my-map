<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Leaflet Map – Данные из таблицы (Sheets + Apps Script)</title>
    <!-- Подключаем Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
      /* Карта на весь экран */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      /* Стили для пользовательских контролов */
      .custom-control {
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 0 5px rgba(0,0,0,0.65);
        cursor: pointer;
      }
      /* Панель легенды (нижняя) */
      .legend-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #ccc;
        padding: 10px;
        display: none;
        height: 15vh;
        overflow: auto;
        z-index: 1000;
      }
      /* Для мобильных устройств – увеличенные размеры */
      @media (max-width:768px) {
        .custom-marker {
          width: 64px !important;
          height: 64px !important;
        }
        .custom-control {
          font-size: 24px;
        }
        .lightning {
          font-size: 16px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- Панель для легенды -->
    <div id="legendPanel" class="legend-panel"></div>
    <!-- Подключаем Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      /***************************************************************
       * Схема индексов (A существует, нумерация с 0):
       *
       * A: №                            → row[0]
       * B: Наименование улицы           → row[1]
       * C: Название остановок           → row[2]
       * D: Направление                  → row[3]
       * E: Район                        → row[4]
       * F: Широта                       → row[5]
       * G: Долгота                      → row[6]
       * H: ID Табло                     → row[7]
       * I: Тип павильона                → row[8]
       * J: Принадлежность павильонов     → row[9]
       * K: д.з 5.12                     → row[10]
       * L: Обустройство                 → row[11]
       * M: Табло информирование         → row[12]   ← Форма маркера: "+" → круг, "медиаборд" → квадрат
       * N: Очередь ITS                  → row[13]
       * O: План                         → row[14]
       * P: Пассажирообразующие          → row[15]
       * Q: Статус                       → row[16]   ← Цвет заливки
       * R: Реклама                      → row[17]   ← Обводка (цвет и толщина)
       * S: Питание                      → row[18]   ← Значок молнии
       ***************************************************************/

      // Инициализация карты
      var map = L.map("map").setView([51.09, 71.45], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

      // Массив для хранения маркеров
      var markers = [];

      // Функция для определения, мобильное ли устройство
      function isMobile() {
        return window.innerWidth <= 768;
      }

      // Функция нормализации строки (обрезка пробелов и перевод в нижний регистр)
      function normalize(str) {
        return str ? str.toString().trim().toLowerCase() : "";
      }

      // Функция для определения цвета заливки по значению из столбца Q (row[16])
      function getFillColor(status) {
        var s = normalize(status);
        if (s === "снят табло") return "gray";
        if (s === "демонтирован") return "black";
        if (s === "не работает") return "red";
        if (s === "работает") return "#00ff00";  // ярко зеленый
        return "white";
      }

      // Функция для определения цвета и толщины обводки по значению из столбца R (row[17])
      function getBorderColor(reklama) {
        var r = normalize(reklama);
        if (r === "led") return "red";
        if (r === "lightbox") return "blue";
        if (r === "x") return "green";
        return "black";
      }
      function getBorderWidth(reklama) {
        var r = normalize(reklama);
        if (r === "led" || r === "lightbox" || r === "x") return 3;
        return 1;
      }

      // Функция для определения формы маркера по значению из столбца M (row[12])
      function getShape(val) {
        var v = normalize(val);
        if (v === "медиаборд") return "square";
        if (v === "+") return "circle";
        return "circle";
      }

      // Функция для формирования значка молнии по значению из столбца S (row[18])
      function getLightningHTML(power) {
        var p = normalize(power);
        if (p === "питание есть") {
          return '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:green; font-size:' + (isMobile() ? "16px" : "10px") + ';">&#9889;</div>';
        } else if (p === "нет питания") {
          return '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:red; font-size:' + (isMobile() ? "16px" : "10px") + ';">&#9889;</div>';
        }
        return "";
      }

      // Функция для создания иконки маркера с учетом данных строки row
      function createMarkerIcon(row) {
        // Для ПК: 32px, для мобильных: 64px
        var markerSize = isMobile() ? 64 : 32;
        var shape = getShape(row[12]);           // Значение из столбца M
        var fillColor = getFillColor(row[16]);     // Значение из столбца Q
        var borderColor = getBorderColor(row[17]); // Значение из столбца R
        var borderWidth = getBorderWidth(row[17]); // Толщина обводки
        var borderRadius = (shape === "circle") ? "50%" : "0%";
        var lightningHTML = getLightningHTML(row[18]); // Значение из столбца S
        var html = '<div class="custom-marker" style="position:relative; width:' + markerSize + 'px; height:' + markerSize + 'px;">' +
                   '<div style="width:100%; height:100%; background-color:' + fillColor +
                   '; border:' + borderWidth + 'px solid ' + borderColor +
                   '; border-radius:' + borderRadius + ';"></div>' +
                   lightningHTML +
                   '</div>';
        return L.divIcon({
          html: html,
          className: "",
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize/2, markerSize/2]
        });
      }

      // URL вашего Apps Script (убедитесь, что выбирается диапазон от A до S)
      var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

      // Загрузка данных из Apps Script
      fetch(url)
        .then(response => response.json())
        .then(data => {
          console.log("Получены данные из Apps Script:", data);
          data.forEach(function(item, index) {
            // Предполагаем, что строка данных — массив (либо item.data, либо сам item)
            var row = item.data || item;
            if (!Array.isArray(row)) {
              row = Object.values(row);
            }
            // Если длина строки меньше 19, дополняем пустыми строками
            while (row.length < 19) {
              row.push("");
            }
            console.log("Строка", index, ":", row);

            // Координаты: широта – столбец F (row[5]), долгота – столбец G (row[6])
            var lat = parseFloat(row[5]);
            var lng = parseFloat(row[6]);
            if (isNaN(lat) || isNaN(lng)) {
              console.warn("Неверные координаты для строки", index, row);
              return;
            }

            // Создаем маркер
            var icon = createMarkerIcon(row);
            var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
            marker.rowData = row;
            markers.push(marker);

            // Формируем popup с данными:
            // Наименование улицы (B, row[1]), Название остановок (C, row[2]),
            // Направление (D, row[3]), Район (E, row[4]), ID Табло (H, row[7]),
            // Статус (Q, row[16]), Реклама (R, row[17])
            var popupHtml = "<b>Наименование улицы:</b> " + row[1] + "<br>" +
                            "<b>Название остановок:</b> " + row[2] + "<br>" +
                            "<b>Направление:</b> " + row[3] + "<br>" +
                            "<b>Район:</b> " + row[4] + "<br>" +
                            "<b>ID Табло:</b> " + row[7] + "<br>" +
                            "<b>Статус:</b> " + row[16] + "<br>" +
                            "<b>Реклама:</b> " + row[17];
            marker.bindPopup(popupHtml);
          });
        })
        .catch(err => {
          console.error("Ошибка при загрузке JSON:", err);
        });

      // Контрол уведомлений (левый верхний угол)
      var NotificationControl = L.Control.extend({
        options: { position: "topleft" },
        onAdd: function(map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML = "&#128276;"; // иконка уведомлений (например, звонок)
          container.title = "Уведомления";
          container.style.fontSize = isMobile() ? "24px" : "16px";
          L.DomEvent.disableClickPropagation(container);
          container.onclick = function() {
            // Здесь можно вывести информацию об изменениях
            alert("Информация об изменениях: остановка в столбце Статус изменена на 'снят табло'.");
          };
          return container;
        }
      });
      map.addControl(new NotificationControl());

      // Контрол поиска (правый верхний угол)
      var SearchControl = L.Control.extend({
        options: { position: "topright" },
        onAdd: function(map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML = '<input id="searchBox" type="text" placeholder="Поиск остановки или ID" style="width:150px;">';
          L.DomEvent.disableClickPropagation(container);
          return container;
        }
      });
      map.addControl(new SearchControl());

      document.getElementById("searchBox").addEventListener("keyup", function(e) {
        if (e.key === "Enter") {
          var query = normalize(this.value);
          if (!query) return;
          var found = false;
          markers.forEach(function(marker) {
            var row = marker.rowData;
            // Поиск по Названию остановок (C, row[2]) или ID Табло (H, row[7])
            if (normalize(row[2]).indexOf(query) !== -1 || normalize(row[7]).indexOf(query) !== -1) {
              map.setView(marker.getLatLng(), 15);
              marker.openPopup();
              found = true;
            }
          });
          if (!found) alert("Остановка не найдена");
        }
      });

      // Контрол легенды (правый нижний угол)
      var LegendControl = L.Control.extend({
        options: { position: "bottomright" },
        onAdd: function(map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML = "&#9432;"; // иконка информации
          container.title = "Легенда";
          container.style.fontSize = isMobile() ? "24px" : "16px";
          L.DomEvent.disableClickPropagation(container);
          container.onclick = function() {
            var legendPanel = document.getElementById("legendPanel");
            if (legendPanel.style.display === "block") {
              legendPanel.style.display = "none";
            } else {
              legendPanel.style.display = "block";
              legendPanel.innerHTML =
                "<b>Легенда:</b><br>" +
                "<span style='color:#00ff00;'>■</span> Работает (ярко зеленый)<br>" +
                "<span style='color:#ff0000;'>■</span> Не работает (красный)<br>" +
                "<span style='color:gray;'>■</span> Снят табло (серый)<br>" +
                "<span style='color:black;'>■</span> Демонтирован (черный)<br>" +
                "<span style='color:red;'>&#9889;</span> Нет питания (красная молния)<br>" +
                "<span style='color:green;'>&#9889;</span> Питание есть (зеленая молния)<br>" +
                "■ – Квадратик (если в столбце M указано 'медиаборд')<br>" +
                "● – Круг (если в столбце M указан '+')";
            }
          };
          return container;
        }
      });
      map.addControl(new LegendControl());

      // Закрытие панели легенды при клике по карте
      map.on("click", function() {
        var legendPanel = document.getElementById("legendPanel");
        if (legendPanel.style.display === "block") {
          legendPanel.style.display = "none";
        }
      });
    </script>
  </body>
</html>
