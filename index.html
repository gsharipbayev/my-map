<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet Map ‚Äî –§–∏–ª—å—Ç—Ä –ø–æ –†–∞–±–æ—Ç–∞–µ—Ç –∏ –°—Ç–∞—Ç—É—Å</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; font-size:16px; }
        #map { width:100%; height:100%; z-index:0; }
        .leaflet-top.leaflet-left { margin-top: 10px; }
        #topSearchBar.show + #map .leaflet-top.leaflet-left { margin-top: 70px; }
        /* 1) –ê–≤—Ç–æ‚Äë—Å–∫—Ä—ã—Ç–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
        #searchActivator { position:fixed; top:0; left:0; right:0; height:10px; z-index:3000; }
        #topSearchBar { position:fixed; top:-70px; left:0; right:0; z-index:3001; display:flex; justify-content:center; background:rgba(255,255,255,0.9); padding:8px; box-shadow:0 2px 5px rgba(0,0,0,0.3); gap:8px; align-items:center; transition: top 0.3s; }
        #topSearchBar.show { top:0; }
        #searchInput { flex:1; max-width:600px; padding:5px; font-size:15px; border:1px solid #ccc; border-radius:5px; }
        #searchBtn { font-size:14px; padding:5px 8px; cursor:pointer; border:none; background:#007bff; color:#fff; border-radius:5px; flex-shrink:0; }
        /* 2) –ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É */
        .control-buttons { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); display:flex; flex-wrap: wrap; justify-content: center; gap:6px; z-index:1001; }
        .btn { padding:10px 16px; font-size:14px; min-width:110px; background-color:#007bff; color:#fff; border:none; border-radius:8px; cursor:pointer; transition:background-color 0.3s; text-align:center; margin-bottom: 5px; }
        .btn.active-filter { /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ */ background-color:#0056b3; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #0056b3; }
        .btn:hover { background-color:#0056b3; }
        .btn span { display:block; font-size:12px; color:#d1e8ff; margin-top:5px; }
        /* 3) –ü–æ–¥–ª–æ–∂–∫–∞ + –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:1000; }
        .bottom-panel { position:fixed; bottom:-100%; left:50%; transform:translateX(-50%); width:90%; max-width:500px; max-height: 70%; overflow-y: auto; background:#fff; border-radius:15px 15px 0 0; font-size:16px; padding:20px; box-shadow:0 -2px 15px rgba(0,0,0,0.3); transition:bottom 0.4s ease-in-out; z-index:1002; }
        .bottom-panel.active { bottom:0; }
        .panel-title { font-size:20px; font-weight:bold; margin-bottom:15px; color:#333; }
        .panel-content-scrollable { max-height: calc(70vh - 100px); overflow-y: auto; }
        /* 4) –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */
        .filter-buttons { display:flex; flex-wrap:wrap; gap:8px; }
        .filter-buttons button { background:#007bff; color:#fff; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; font-size:14px; transition:background 0.2s; }
        .filter-buttons button:hover { background:#0062cc; }
        .filter-buttons button.active { /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */ background:#28a745; color: white; }
        .filter-buttons button.clear-btn { background: #6c757d; }
        .filter-buttons button.clear-btn:hover { background: #5a6268; }
        /* 5) –õ–µ–≥–µ–Ω–¥–∞ */
        .legend-container { display: flex; flex-direction: column; gap: 15px; }
        .legend-section { display:flex; flex-direction:column; gap:10px; }
        .legend-title { font-weight:bold; margin-bottom:5px; }
        .legend-row { display:flex; align-items:center; gap:10px; }
        .legend-icon { width:20px; height:20px; display:inline-block; border-radius:50%; border:1px solid #000; }
        /* 6) MarkerCluster */
        .cluster-icon-only { /* –°—Ç–∏–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∏–Ω–ª–∞–π–Ω–æ–≤—ã–µ */ }
        .my-div-icon { background:none !important; border:none !important; }
        /* 7) –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ */
        @media (max-width:600px){
            #searchInput { max-width:calc(100% - 70px); font-size:14px; }
            #searchBtn { font-size:12px; padding:4px 6px; }
            .control-buttons { width: 100%; padding: 0 10px; box-sizing: border-box; }
            .btn { padding:8px 10px; font-size:12px; min-width:auto; flex-grow: 1; }
            .bottom-panel { width:100%; border-radius: 15px 15px 0 0; font-size:14px; max-height: 60%; }
            .panel-title { font-size:18px; }
            .filter-buttons button { font-size:13px; padding:5px 10px; }
        }
    </style>
</head>
<body>
    <div id="searchActivator"></div>
    <div id="topSearchBar">
        <input type="text" id="searchInput" placeholder="ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"/>
        <button id="searchBtn">üîç</button>
    </div>
    <div id="map"></div>
    <div class="control-buttons">
        <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
        <button class="btn" id="workingFilterToggle"> –†–∞–±–æ—Ç–∞–µ—Ç <span id="workingFilterLabel">–í—Å–µ (0)</span> </button>
        <button class="btn" id="statusToggle"> –°—Ç–∞—Ç—É—Å <span id="statusLabel">–í—Å–µ (0)</span> </button>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="bottom-panel" id="bottomPanel">
        <div class="panel-title" id="panelTitle">–õ–µ–≥–µ–Ω–¥–∞</div>
        <div id="panelContentWrapper">
            <div id="panelContent" class="legend-container"></div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        /***********************************************************
         * 1) –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞
         ***********************************************************/
        const searchActivator = document.getElementById("searchActivator");
        const topSearchBar = document.getElementById("topSearchBar");
        let hideTimer=null;
        function showSearchBar(){ clearTimeout(hideTimer); topSearchBar.classList.add("show"); }
        function hideSearchBar(){ topSearchBar.classList.remove("show"); }
        function startHideTimer(){ hideTimer=setTimeout(hideSearchBar,2000); }
        searchActivator.addEventListener("mouseenter", showSearchBar);
        searchActivator.addEventListener("mouseleave", startHideTimer);
        searchActivator.addEventListener("touchstart", showSearchBar,{passive:true});
        topSearchBar.addEventListener("mouseleave", startHideTimer);
        topSearchBar.addEventListener("touchstart",()=>clearTimeout(hideTimer),{passive:true});
        /***********************************************************
         * 2) –ö–∞—Ä—Ç–∞
         ***********************************************************/
        const map = L.map("map", { zoomControl: false }).setView([51.127,71.43], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);
        let clusterGroups = null;
        const DEFAULT_MARKER_COLOR = "#888888";
        /***********************************************************
         * 3) –î–ê–ù–ù–´–ï –∏ –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í
         ***********************************************************/
        let markersData = []; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ–π, –±—É–¥–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        let originalMarkersData = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let colorMode = 'working';
        let selectedWorkings = [];
        let selectedStatuses = [];
        const workingCategories = ["–î–∞", "–ù–µ—Ç", "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"];
        const statusCategories = ["–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω", "–û—Ç–≤–æ–¥", "–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ", "–§—É–Ω–¥–∞–º–µ–Ω—Ç", "–°–µ—Ç—å", "–ö–∞—Ä–∫–∞—Å", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"];
        /***********************************************************
         * 4) –†–∞—Å–∫—Ä–∞—Å–∫–∞ –∏ —Ñ–æ—Ä–º—ã –º–∞—Ä–∫–µ—Ä–æ–≤
         ***********************************************************/
        function getWorkingCategory(workingValue) {
            const w = (workingValue || "").toLowerCase().trim();
            if (w === "–¥–∞") return "–î–∞";
            if (w === "–Ω–µ—Ç") return "–ù–µ—Ç";
            return "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
        }
        function getWorkingColor(workingValue) {
            const w = (workingValue || "").toLowerCase().trim();
            if (w === "–¥–∞") return "#28a745"; // –ó–µ–ª–µ–Ω—ã–π
            if (w === "–Ω–µ—Ç") return "#dc3545"; // –ö—Ä–∞—Å–Ω—ã–π
            return DEFAULT_MARKER_COLOR; // –°–µ—Ä—ã–π
        }
        function getStatusCategory(item) {
            const agreement = (item.agreement || "").trim();
            const allotment = (item.allotment || "").trim();
            const tech_condition = (item.tech_condition || "").trim();
            const install_status = (item.install_status || "").trim();
            if (install_status === "–§—É–Ω–¥–∞–º–µ–Ω—Ç") return "–§—É–Ω–¥–∞–º–µ–Ω—Ç";
            if (install_status === "–°–µ—Ç—å") return "–°–µ—Ç—å";
            if (install_status === "–ö–∞—Ä–∫–∞—Å") return "–ö–∞—Ä–∫–∞—Å";
            if (tech_condition === "–î–∞") return "–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ";
            if (allotment === "–î–∞") return "–û—Ç–≤–æ–¥";
            if (agreement === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω") return "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω";
            return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        }
        function getStatusColor(item) {
            const agreement = (item.agreement || "").trim();
            const allotment = (item.allotment || "").trim();
            const tech_condition = (item.tech_condition || "").trim();
            const install_status = (item.install_status || "").trim();
            if (install_status === "–§—É–Ω–¥–∞–º–µ–Ω—Ç") return "#800080"; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
            if (install_status === "–°–µ—Ç—å") return "#ffa500"; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            if (install_status === "–ö–∞—Ä–∫–∞—Å") return "#008000"; // –ó–µ–ª–µ–Ω—ã–π
            if (tech_condition === "–î–∞") return "#ffa500"; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            if (allotment === "–î–∞") return "#ffff00"; // –ñ–µ–ª—Ç—ã–π
            if (agreement === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω") return "#0000ff"; // –°–∏–Ω–∏–π
            return DEFAULT_MARKER_COLOR; // –°–µ—Ä—ã–π
        }
        function getStatusShape(item) {
            const install_status = (item.install_status || "").trim();
            if (install_status === "–§—É–Ω–¥–∞–º–µ–Ω—Ç" || install_status === "–°–µ—Ç—å" || install_status === "–ö–∞—Ä–∫–∞—Å") {
                return "triangle";
            }
            const agreement = (item.agreement || "").trim();
            const allotment = (item.allotment || "").trim();
            const tech_condition = (item.tech_condition || "").trim();
            if (agreement === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω" || allotment === "–î–∞" || tech_condition === "–î–∞") {
                return "square";
            }
            return "circle";
        }
        function getCurrentMarkerColor(item) {
            if (colorMode === 'working') {
                const currentWorkingValue = getWorkingCategory(item.working);
                if (selectedWorkings.length > 0) {
                    if (selectedWorkings.includes(currentWorkingValue)) {
                        const w = currentWorkingValue.toLowerCase();
                        if (w === "–¥–∞") return "#00ff00"; // –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π
                        if (w === "–Ω–µ—Ç") return "#ff0000"; // –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
                        return DEFAULT_MARKER_COLOR;
                    }
                    return DEFAULT_MARKER_COLOR;
                } else {
                    return getWorkingColor(item.working);
                }
            } else if (colorMode === 'status') {
                return getStatusColor(item);
            }
            return DEFAULT_MARKER_COLOR;
        }
        function getCurrentMarkerShape(item) {
            if (colorMode === 'working') {
                return 'circle';
            } else if (colorMode === 'status') {
                return getStatusShape(item);
            }
            return 'circle';
        }
        /***********************************************************
         * 5) –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–û–í
         ***********************************************************/
        function addMarkers(dataToDisplay){ // –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if(clusterGroups){
                Object.values(clusterGroups).forEach(group => map.removeLayer(group));
            }
            clusterGroups = {
                circle: L.markerClusterGroup({ maxClusterRadius: 60, iconCreateFunction: createClusterIcon }),
                square: L.markerClusterGroup({ maxClusterRadius: 60, iconCreateFunction: createClusterIcon }),
                triangle: L.markerClusterGroup({ maxClusterRadius: 60, iconCreateFunction: createClusterIcon })
            };
            function createClusterIcon(cluster) {
                const count = cluster.getChildCount();
                let size = 30 + count / 10;
                size = Math.min(Math.max(size, 30), 50);
                const markers = cluster.getAllChildMarkers();
                const colorCountMap = {};
                let mostFrequentColor = DEFAULT_MARKER_COLOR;
                let maxCount = 0;
                markers.forEach(m => {
                    const c = m.myColor || DEFAULT_MARKER_COLOR;
                    colorCountMap[c] = (colorCountMap[c] || 0) + 1;
                    if (colorCountMap[c] > maxCount) {
                        maxCount = colorCountMap[c];
                        mostFrequentColor = c;
                    }
                });
                const uniqueColors = Object.keys(colorCountMap);
                let clusterColor = uniqueColors.length === 1 ? uniqueColors[0] : mostFrequentColor;
                if (typeof clusterColor === 'undefined' || clusterColor === null) {
                    clusterColor = DEFAULT_MARKER_COLOR;
                }
                return L.divIcon({
                    html: `<div style="background-color:${clusterColor}; border: 2px solid #555; border-radius:50%; width:${size}px; height:${size}px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size: ${Math.max(10, size/2.5)}px;">${count}</div>`,
                    className:'cluster-icon-only',
                    iconSize:[size,size],
                    iconAnchor: [size/2, size/2]
                });
            }
            dataToDisplay.forEach(item => {
                const c = getCurrentMarkerColor(item);
                const shape = getCurrentMarkerShape(item);
                const lat = parseFloat(item.lat);
                const lng = parseFloat(item.lng);
                if (isNaN(lat) || isNaN(lng)) { return; }
                let iconHTML;
                let iconSize = [18, 18];
                let iconAnchor = [9, 9];
                if (shape === 'triangle') {
                    iconHTML = `<div style="width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 18px solid ${c};"></div>`;
                    iconAnchor = [9, 18];
                } else {
                    const borderRadius = shape === 'circle' ? '50%' : '0%';
                    iconHTML = `<div style="width:18px; height:18px; background-color:${c}; border:1px solid #000; border-radius:${borderRadius}; box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>`;
                }
                const icon = L.divIcon({ className:'my-div-icon', html:iconHTML, iconSize, iconAnchor });
                const marker = L.marker([lat,lng], {icon});
                marker.myColor = c;
                const popupContent = `<b>ID –¢–∞–±–ª–æ:</b> ${item.tablo || "-"}<br>
                <b>–£–ª–∏—Ü–∞:</b> ${item.street || "-"}<br>
                <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${item.direction || "-"}<br>
                <b>–†–∞–π–æ–Ω:</b> ${item.district || "-"}<br>
                <b>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ:</b> ${item.move || "-"}<br>
                <b>–†–∞–±–æ—Ç–∞–µ—Ç:</b> ${item.working || "-"}`;
                marker.bindPopup(popupContent);
                clusterGroups[shape].addLayer(marker);
            });
            Object.values(clusterGroups).forEach(group => map.addLayer(group));
        }
        /***********************************************************
         * 6) –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
         ***********************************************************/
        function applyCombinedFilter() {
            if (!markersData || markersData.length === 0) {
                if(clusterGroups) Object.values(clusterGroups).forEach(group => map.removeLayer(group));
                updateLabels(0);
                return;
            }
            const filtered = markersData.filter(m => {
                const currentWorkingVal = getWorkingCategory(m.working);
                const passWorking = (selectedWorkings.length === 0) || selectedWorkings.includes(currentWorkingVal);
                const currentStatusVal = getStatusCategory(m);
                const passStatus = (selectedStatuses.length === 0) || selectedStatuses.includes(currentStatusVal);
                return passWorking && passStatus;
            });
            addMarkers(filtered);
            updateLabels(filtered.length);
        }
        function updateLabels(count){
            // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ä–∫–µ—Ä–æ–≤
            const baseCount = markersData.length;
            document.getElementById("workingFilterLabel").innerText = `${selectedWorkings.length > 0 ? selectedWorkings.join('/') : '–í—Å–µ'} (${count}/${baseCount})`;
            document.getElementById("statusLabel").innerText = `${selectedStatuses.length > 0 ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—Å–µ'} (${count}/${baseCount})`;
            document.querySelectorAll('.control-buttons .btn').forEach(b => b.classList.remove('active-filter'));
            if (colorMode === 'working') {
                document.getElementById('workingFilterToggle').classList.add('active-filter');
            } else if (colorMode === 'status') {
                document.getElementById('statusToggle').classList.add('active-filter');
            }
        }
        /***********************************************************
         * 7) –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
         ***********************************************************/
        let markersLoaded = false;
        fetch("https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec")
        .then(r => {
            if (!r.ok) { console.error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", r); throw new Error(`HTTP error! status: ${r.status}`); }
            return r.json();
        })
        .then(data => {
            originalMarkersData = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            markersData = originalMarkersData;
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${markersData.length} –∑–∞–ø–∏—Å–µ–π.`);
            markersLoaded = true;
            applyCombinedFilter();
            document.getElementById('workingFilterToggle').classList.add('active-filter');
        })
        .catch(e => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
        });
        /***********************************************************
         * 8) –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–ê–ù–ï–õ–ò
         ***********************************************************/
        const overlay = document.getElementById("overlay");
        const bottomPanel = document.getElementById("bottomPanel");
        function togglePanel(title, contentHtml, isScrollable = false) {
            const panelTitleElem = document.getElementById("panelTitle");
            const panelContentElem = document.getElementById("panelContent");
            if(bottomPanel.classList.contains("active") && panelTitleElem.innerText === title){ closePanel(); }
            else {
                panelTitleElem.innerText = title;
                panelContentElem.innerHTML = contentHtml;
                panelContentElem.classList.toggle("panel-content-scrollable", isScrollable);
                bottomPanel.classList.add("active");
                overlay.style.display = "block";
            }
        }
        function closePanel() {
            bottomPanel.classList.remove("active");
            overlay.style.display = "none";
        }
        overlay.addEventListener("click", closePanel);
        document.getElementById("legendToggle").addEventListener("click", () => {
            const workingHtml = `<div class="legend-section">
                <div class="legend-title">–†–∞–±–æ—Ç–∞–µ—Ç</div>
                ${workingCategories.map(cat => {
                    const color = getWorkingColor(cat);
                    return `<div class="legend-row"> <div class="legend-icon" style="background-color:${color};"></div> ${cat} </div>`;
                }).join('')}
            </div>`;
            const statusLegendData = [
                {label: "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω", color: "#0000ff", shape: "square"},
                {label: "–û—Ç–≤–æ–¥", color: "#ffff00", shape: "square"},
                {label: "–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ", color: "#ffa500", shape: "square"},
                {label: "–§—É–Ω–¥–∞–º–µ–Ω—Ç", color: "#800080", shape: "triangle"},
                {label: "–°–µ—Ç—å", color: "#ffa500", shape: "triangle"},
                {label: "–ö–∞—Ä–∫–∞—Å", color: "#008000", shape: "triangle"},
                {label: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", color: DEFAULT_MARKER_COLOR, shape: "circle"}
            ];
            const statusHtml = `<div class="legend-section">
                <div class="legend-title">–°—Ç–∞—Ç—É—Å</div>
                ${statusLegendData.map(entry => {
                    let iconHtml;
                    if (entry.shape === "triangle") {
                        iconHtml = `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid ${entry.color};"></div>`;
                    } else {
                        const radius = entry.shape === "circle" ? "50%" : "0%";
                        iconHtml = `<div style="width:20px; height:20px; background-color:${entry.color}; border:1px solid #000; border-radius:${radius};"></div>`;
                    }
                    return `<div class="legend-row"> ${iconHtml} ${entry.label} </div>`;
                }).join('')}
            </div>`;
            const legendHtml = `${workingHtml} <hr style="width:100%; border-top: 1px solid #eee; margin: 10px 0;"> ${statusHtml}`;
            togglePanel("–õ–µ–≥–µ–Ω–¥–∞", legendHtml, true);
        });
        /***********************************************************
         * 9) –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í
         ***********************************************************/
        function createGenericFilterPanel(buttonId, panelTitle, itemsArrayProvider, selectedArrayRef, colorModeToSetIfAny) {
            const buttonElement = document.getElementById(buttonId);
            buttonElement.dataset.panelTitle = panelTitle;
            buttonElement.addEventListener("click", () => {
                if (!markersLoaded) { alert("–î–∞–Ω–Ω—ã–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è..."); return; }
                if (colorModeToSetIfAny) { colorMode = colorModeToSetIfAny; }
                let html = `<div class="filter-buttons">`;
                const itemsArray = itemsArrayProvider();
                itemsArray.forEach(item => {
                    const val = typeof item === 'object' ? item.value : item;
                    const display = typeof item === 'object' ? item.display : item;
                    const active = selectedArrayRef.includes(val) ? "active" : "";
                    const escapedVal = val.replace(/'/g, "\\'");
                    html += `<button class="${active}" onclick="toggleFilterItem('${buttonId}', '${escapedVal}')">${display}</button>`;
                });
                html += `<button class="clear-btn" onclick="clearFilterItems('${buttonId}')">–û—á–∏—Å—Ç–∏—Ç—å</button></div>`;
                togglePanel(panelTitle, html, itemsArray.length > 10);
                applyCombinedFilter();
            });
        }
        window.toggleFilterItem = function(btnId, itemValue) {
            let currentSelectedArray;
            const buttonElement = document.getElementById(btnId);
            const panelTitleForButton = buttonElement.dataset.panelTitle;
            if (btnId === 'workingFilterToggle') currentSelectedArray = selectedWorkings;
            else if (btnId === 'statusToggle') currentSelectedArray = selectedStatuses;
            if (currentSelectedArray) {
                const index = currentSelectedArray.indexOf(itemValue);
                if (index > -1) { currentSelectedArray.splice(index, 1); }
                else { currentSelectedArray.push(itemValue); }
            }
            applyCombinedFilter();
            if (bottomPanel.classList.contains("active") && document.getElementById("panelTitle").innerText === panelTitleForButton) {
                buttonElement.click(); // –ó–∞–∫—Ä—ã—Ç—å
                buttonElement.click(); // –û—Ç–∫—Ä—ã—Ç—å —Å–Ω–æ–≤–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –≤ –ø–∞–Ω–µ–ª–∏
            }
        };
        window.clearFilterItems = function(btnId) {
            let panelTitleForButton = document.getElementById(btnId).dataset.panelTitle;
            if (btnId === 'workingFilterToggle') { selectedWorkings = []; colorMode = 'working'; }
            else if (btnId === 'statusToggle') { selectedStatuses = []; }
            applyCombinedFilter();
            if (bottomPanel.classList.contains("active") && document.getElementById("panelTitle").innerText === panelTitleForButton) {
                document.getElementById(btnId).click();
                document.getElementById(btnId).click();
            }
        };
        createGenericFilterPanel(
            "workingFilterToggle",
            "–†–∞–±–æ—Ç–∞–µ—Ç",
            () => workingCategories.map(cat => ({value: cat, display: cat})),
            selectedWorkings,
            'working'
        );
        createGenericFilterPanel(
            "statusToggle",
            "–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É",
            () => statusCategories,
            selectedStatuses,
            'status'
        );
        /***********************************************************
         * 10) –ü–û–ò–°–ö
         ***********************************************************/
        document.getElementById("searchBtn").addEventListener("click", doSearch);
        document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") doSearch(); });
        function doSearch() {
            const query = document.getElementById("searchInput").value.toLowerCase().trim();
            if (!markersData || markersData.length === 0) return;
            if (!query) { applyCombinedFilter(); return; }
            const filteredBySearchAndFilters = markersData.filter(m => {
                const currentWorkingVal = getWorkingCategory(m.working);
                const passWorking = (selectedWorkings.length === 0) || selectedWorkings.includes(currentWorkingVal);
                const currentStatusVal = getStatusCategory(m);
                const passStatus = (selectedStatuses.length === 0) || selectedStatuses.includes(currentStatusVal);
                if (!(passWorking && passStatus)) { return false; }
                const stopNameVal = (m.stopName || "").toLowerCase();
                const tabloVal = String(m.tablo || "").toLowerCase();
                return stopNameVal.includes(query) || tabloVal.includes(query);
            });
            addMarkers(filteredBySearchAndFilters);
            updateLabels(filteredBySearchAndFilters.length);
        }
    </script>
</body>
</html>
