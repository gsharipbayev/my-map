<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet Map (Sheets + Apps Script)</title>
  
  <!-- CSS Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  
  <style>
    /* Полноэкранная карта */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* Кнопка переключения */
    .toggle-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 9999; /* Чтобы не перекрывалась картой */
      padding: 10px 15px;
      background-color: #fff;
      border: 2px solid #666;
      border-radius: 5px;
      cursor: pointer;
      font-family: sans-serif;
      font-size: 14px;
    }
    .toggle-btn:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toggle-btn" id="toggleBtn">Показать НЕ_работает</div> 
  
  <!-- JS Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  
  <script>
    // 1) Инициализация карты
    var map = L.map('map').setView([51.09, 71.45], 11); 
    
    // 2) Подключение тайлов (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // 3) ВАША ссылка на задеплоенный скрипт
    var url = "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

    // a) Цвет обводки для "рабочих" по рекламе
    function getReklamaColor(reklama) {
      switch (reklama) {
        case "LED":
          return "red";
        case "Lightbox":
          return "blue";
        case "X":
          return "green";
        default:
          return "black"; 
      }
    }

    // b) Цвет обводки для "не работает/снят/демонтирован" по питанию
    // Проверим в тексте "есть" => зелёный, иначе красный
    function getPowerColor(powerValue) {
      // powerValue могут быть "питание есть", "да", "нет" и т.п.
      // Приведём всё к lowercase и проверим подстроку "есть" или "да"
      var lv = powerValue.toLowerCase();
      if (lv.includes("есть") || lv.includes("да")) {
        return "green";
      } else {
        return "red";
      }
    }

    // c) Создаём иконку-квадрат (для Медиаборда)
    function createSquareIcon(fillColor) {
      return L.divIcon({
        html:
          '<div style="width:16px; height:16px; ' +
          'background-color:' + fillColor + '; ' +
          'border: 2px solid ' + fillColor + '; ' +
          'border-radius: 0;">' +
          '</div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8],
        className: ''
      });
    }

    // d) Создаём круг (для Табло) — circleMarker
    function createCircleMarker(lat, lng, color) {
      return L.circleMarker([lat, lng], {
        radius: 8,
        fillColor: color,
        fillOpacity: 1,
        color: color,
        weight: 2
      });
    }

    // --- Группы маркеров ---
    var workingGroup = L.layerGroup();       // Для "работает" (и Медиабордов в работе)
    var notWorkingGroup = L.layerGroup();    // Для "не работает", "снят табло", "демонтирован"

    // Флажок, какая группа сейчас видна
    var showWorking = true;

    // Переключение слоев
    function toggleLayers() {
      if (showWorking) {
        // Удаляем "рабочие"
        map.removeLayer(workingGroup);
        // Добавляем "не рабочие"
        map.addLayer(notWorkingGroup);
        // Меняем текст кнопки
        document.getElementById("toggleBtn").textContent = "Показать РАБОТАЕТ";
        showWorking = false;
      } else {
        // Удаляем "не рабочие"
        map.removeLayer(notWorkingGroup);
        // Добавляем "рабочие"
        map.addLayer(workingGroup);
        // Меняем текст кнопки
        document.getElementById("toggleBtn").textContent = "Показать НЕ_работает";
        showWorking = true;
      }
    }

    // Навешиваем обработчик на кнопку
    document.getElementById("toggleBtn").addEventListener("click", toggleLayers);

    // 4) Загружаем JSON
    fetch(url)
      .then(response => response.json())
      .then(data => {
        console.log("Данные из Apps Script:", data);

        data.forEach(function(item) {
          var lat = parseFloat(item.lat);
          var lng = parseFloat(item.lng);
          if (isNaN(lat) || isNaN(lng)) return; // пропускаем некорректные координаты

          // Статус
          var statusRaw = (item.status || "").trim();
          var status = statusRaw.toLowerCase(); 
          // Возможные варианты: "работает", "не работает", "снят табло", "демонтирован" 
          
          // Тип (M) => "Табло" или "Медиаборд"
          // Могут быть вариации "Табло", "табло", "Mediabord", "медиаборд" и т.п.
          var typeMRaw = (item.tablo || "").trim();
          var typeM = typeMRaw.toLowerCase();

          // Реклама (R)
          var reklama = (item.reklama || "").trim();

          // Питание (S)
          var powerValueRaw = (item.power || "").trim();

          // --- Определяем, в какую группу пойдёт ---
          // Группа "рабочие" (workingGroup), если status == "работает"
          // Группа "не рабочие" (notWorkingGroup), если status in ["не работает", "демонтирован", "снят табло"]
          var isWorking = (status.includes("работает"));
          var isNotWorking = (status.includes("не работает") || status.includes("демонтирован") || status.includes("снят"));

          // Если не подходит ни в одну категорию — пропустим
          if (!isWorking && !isNotWorking) {
            console.log("Пропущен статус", statusRaw);
            return;
          }

          // --- Создаём маркер в зависимости от M ---
          // Если M содержит "табло" => круг; если M содержит "медиаборд" => квадрат
          var marker;
          var markerColor;

          if (isWorking) {
            // Рабочее => цвет по рекламе
            markerColor = getReklamaColor(reklama);
          } else {
            // Не рабочее => цвет по питанию
            markerColor = getPowerColor(powerValueRaw);
          }

          if (typeM.includes("табло")) {
            // Табло => круг
            marker = createCircleMarker(lat, lng, markerColor);
          } else if (typeM.includes("медиаборд")) {
            // Медиаборд => квадрат
            marker = L.marker([lat, lng], { icon: createSquareIcon(markerColor) });
          } else {
            // Если не "Табло" и не "Медиаборд", пропустим
            console.log("Пропущен тип", typeMRaw);
            return;
          }

          // Попап
          var popupHtml =
            "<b>Название остановки:</b> " + (item.stopName || "") + "<br>" +
            "<b>Улица:</b> " + (item.street || "") + "<br>" +
            "<b>Направление:</b> " + (item.direction || "") + "<br>" +
            "<b>Район:</b> " + (item.region || "") + "<br>" +
            "<b>ID Остановки:</b> " + (item.stopId || "") + "<br>" +
            "<b>Статус:</b> " + (item.status || "") + "<br>" +
            "<b>Реклама:</b> " + (item.reklama || "") + "<br>" +
            "<b>Питание:</b> " + (item.power || "");

          marker.bindPopup(popupHtml);

          // Добавляем маркер в соответствующую группу
          if (isWorking) {
            workingGroup.addLayer(marker);
          } else {
            notWorkingGroup.addLayer(marker);
          }
        });

        // По умолчанию включаем "рабочие"
        workingGroup.addTo(map);
      })
      .catch(err => {
        console.error("Ошибка при загрузке JSON:", err);
      });
  </script>
</body>
</html>
