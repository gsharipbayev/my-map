<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Leaflet Map с номерами столбцов и уведомлением</title>
    <!-- Подключаем Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
      /* Карта на весь экран */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      /* Стили для пользовательских контролов */
      .custom-control {
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.65);
        cursor: pointer;
      }
      /* Панель легенды (снизу) */
      .legend-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #ccc;
        padding: 10px;
        display: none;
        height: 15vh;
        overflow: auto;
        z-index: 1000;
      }
      /* Для мобильных устройств увеличиваем значки */
      @media (max-width: 768px) {
        .custom-marker {
          width: 32px !important;
          height: 32px !important;
        }
        .custom-control {
          font-size: 24px;
        }
        .lightning {
          font-size: 16px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- Панель легенды (появляется при нажатии на иконку) -->
    <div id="legendPanel" class="legend-panel"></div>
    <!-- Подключаем Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      /**************************************************************
       * ПРИНЯТОЕ СООТВЕТСТВИЕ НОМЕРОВ СТОЛБЦОВ (индексация с 0):
       *
       * Если данные приходят как массив, то:
       *
       * Для popup:
       *   - Столбец B (Улица)         → index 0
       *   - Столбец C (Название)       → index 1
       *   - Столбец D (Направление)    → index 2
       *   - Столбец E (Район)          → index 3
       *   - Столбец H (ID Остановки)   → index 6
       *   - Столбец Q (Статус)         → index 16
       *   - Столбец R (Реклама)        → index 17
       *
       * Для формирования маркера:
       *   - Столбец M (форма: "+" или "медиаборд") → index 12
       *   - Столбец Q (Статус для цвета заливки)    → index 16
       *   - Столбец R (Реклама для обводки)          → index 17
       *   - Столбец S (Питание для значка молнии)    → index 18
       *
       * Для уведомления:
       *   - Столбец U (email пользователя) → index 20
       *
       * Координаты:
       *   Если объект имеет свойства lat и lng, они используются;
       *   иначе предполагается, что:
       *     - lat находится в массиве по индексу 0,
       *     - lng – по индексу 1.
       *
       * (Если ваша структура данных иная, отредактируйте номера индексов ниже.)
       **************************************************************/

      // Инициализация карты
      var map = L.map("map").setView([51.09, 71.45], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);

      // Массив для хранения маркеров (для поиска)
      var markers = [];

      // Функция определения мобильного устройства
      function isMobile() {
        return window.innerWidth <= 768;
      }

      // Функция нормализации строк (обрезка пробелов, перевод в нижний регистр)
      function normalize(str) {
        return str ? str.toString().trim().toLowerCase() : "";
      }

      // Функция для определения цвета заливки (по столбцу Q – index 16)
      function getFillColor(status) {
        var st = normalize(status);
        if (st === "снят табло") return "gray";
        if (st === "демонтирован") return "black";
        if (st === "не работает") return "#FF0000"; // красный
        if (st === "работает") return "#00FF00"; // ярко зеленый
        return "white";
      }

      // Функция для определения цвета и толщины обводки (по столбцу R – index 17)
      function getBorderColor(reklama) {
        var rec = normalize(reklama);
        if (rec === "led") return "red";
        if (rec === "lightbox") return "blue";
        if (rec === "x") return "green";
        return "black";
      }
      function getBorderWidth(reklama) {
        var rec = normalize(reklama);
        if (rec === "led" || rec === "lightbox" || rec === "x") return 3;
        return 1;
      }

      // Функция для определения формы маркера (по столбцу M – index 12)
      function getShape(value) {
        var val = normalize(value);
        if (val === "медиаборд") return "square";
        if (val === "+") return "circle";
        return "circle";
      }

      // Функция для формирования значка молнии (по столбцу S – index 18)
      function getLightningHTML(power) {
        var p = normalize(power);
        if (p === "питание есть") {
          return (
            '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:green; font-size:' +
            (isMobile() ? "16px" : "10px") +
            ';">&#9889;</div>'
          );
        } else if (p === "нет питания") {
          return (
            '<div class="lightning" style="position:absolute; bottom:-2px; right:-2px; color:red; font-size:' +
            (isMobile() ? "16px" : "10px") +
            ';">&#9889;</div>'
          );
        }
        return "";
      }

      // Функция для создания иконки маркера (используем данные из массива row)
      function createMarkerIcon(row) {
        var markerSize = isMobile() ? 32 : 16;
        var shape = getShape(row[12]);
        var fillColor = getFillColor(row[16]);
        var borderColor = getBorderColor(row[17]);
        var borderWidth = getBorderWidth(row[17]);
        var borderRadius = shape === "circle" ? "50%" : "0%";
        var lightningHTML = getLightningHTML(row[18]);

        var html =
          '<div class="custom-marker" style="position:relative; width:' +
          markerSize +
          "px; height:" +
          markerSize +
          'px;">' +
          '<div style="width:100%; height:100%; background-color:' +
          fillColor +
          "; border:" +
          borderWidth +
          "px solid " +
          borderColor +
          "; border-radius:" +
          borderRadius +
          ';"></div>' +
          lightningHTML +
          "</div>";

        return L.divIcon({
          html: html,
          className: "",
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize / 2, markerSize / 2]
        });
      }

      // URL к задеплоенному Apps Script (замените на свой)
      var url =
        "https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec";

      // Массив для хранения уведомлений
      var notifications = [];

      // Загрузка данных из Apps Script
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          console.log("Данные из Apps Script:", data);
          data.forEach(function (item) {
            // Определяем координаты:
            // Если объект имеет свойства lat и lng – используем их,
            // иначе считаем, что координаты находятся в массиве по индексам 0 и 1.
            var lat =
              item.lat !== undefined
                ? parseFloat(item.lat)
                : parseFloat(item[0]);
            var lng =
              item.lng !== undefined
                ? parseFloat(item.lng)
                : parseFloat(item[1]);
            if (isNaN(lat) || isNaN(lng)) return;

            // Остальные данные берем из массива.
            // Если данные находятся в свойстве data, используем его, иначе – сам item.
            var row = item.data || item;
            // Для popup:
            // Улица – index 0, Название – index 1, Направление – index 2, Район – index 3,
            // ID – index 6, Статус – index 16, Реклама – index 17.
            var street = row[0] || "";
            var stopName = row[1] || "";
            var direction = row[2] || "";
            var region = row[3] || "";
            var stopId = row[6] || "";
            var status = row[16] || "";
            var reklama = row[17] || "";

            // Создаем маркер с иконкой
            var icon = createMarkerIcon(row);
            var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
            marker.rowData = row;
            markers.push(marker);

            // Формируем содержимое popup
            var popupHtml =
              "<b>Название остановки:</b> " +
              stopName +
              "<br>" +
              "<b>Улица:</b> " +
              street +
              "<br>" +
              "<b>Направление:</b> " +
              direction +
              "<br>" +
              "<b>Район:</b> " +
              region +
              "<br>" +
              "<b>ID Остановки:</b> " +
              stopId +
              "<br>" +
              "<b>Статус:</b> " +
              status +
              "<br>" +
              "<b>Реклама:</b> " +
              reklama;
            marker.bindPopup(popupHtml);

            // Если статус (index 16) равен "работает" и email (из столбца U, index 20)
            // равен "gsharipbayev@innoforce.kz" – добавляем уведомление.
            var userEmail = row[20] || "";
            if (
              normalize(status) === "работает" &&
              normalize(userEmail) === "gsharipbayev@innoforce.kz"
            ) {
              var notificationMsg =
                "Пользователь " +
                userEmail +
                " сделал изменение. " +
                "Остановка номер ID: " +
                stopId +
                ", наименование: " +
                stopName +
                " изменен статус (Столбец Q): " +
                status;
              notifications.push(notificationMsg);
            }
          });
        })
        .catch((err) => {
          console.error("Ошибка при загрузке JSON:", err);
        });

      /*******************
       * Пользовательские контролы
       *******************/

      // 1. Контрол уведомлений (левый верхний угол)
      var NotificationControl = L.Control.extend({
        options: {
          position: "topleft"
        },
        onAdd: function (map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML = "&#128276;"; // иконка уведомлений
          container.title = "Уведомления";
          container.style.fontSize = isMobile() ? "24px" : "16px";
          L.DomEvent.disableClickPropagation(container);
          container.onclick = function () {
            if (notifications.length > 0) {
              alert(notifications.join("\n\n"));
            } else {
              alert("Нет уведомлений.");
            }
          };
          return container;
        }
      });
      map.addControl(new NotificationControl());

      // 2. Контрол поиска (правый верхний угол)
      var SearchControl = L.Control.extend({
        options: {
          position: "topright"
        },
        onAdd: function (map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML =
            '<input id="searchBox" type="text" placeholder="Поиск остановки или ID" style="width:150px;">';
          L.DomEvent.disableClickPropagation(container);
          return container;
        }
      });
      map.addControl(new SearchControl());

      document
        .getElementById("searchBox")
        .addEventListener("keyup", function (e) {
          if (e.key === "Enter") {
            var query = this.value.trim().toLowerCase();
            if (!query) return;
            var found = false;
            markers.forEach(function (marker) {
              var row = marker.rowData;
              var stopName = row[1] || "";
              var stopId = row[6] || "";
              if (
                normalize(stopName).indexOf(query) !== -1 ||
                normalize(stopId).indexOf(query) !== -1
              ) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
                found = true;
              }
            });
            if (!found) alert("Остановка не найдена");
          }
        });

      // 3. Контрол легенды (правый нижний угол)
      var LegendControl = L.Control.extend({
        options: {
          position: "bottomright"
        },
        onAdd: function (map) {
          var container = L.DomUtil.create("div", "custom-control");
          container.innerHTML = "&#9432;";
          container.title = "Легенда";
          container.style.fontSize = isMobile() ? "24px" : "16px";
          L.DomEvent.disableClickPropagation(container);
          container.onclick = function () {
            var legendPanel = document.getElementById("legendPanel");
            if (legendPanel.style.display === "block") {
              legendPanel.style.display = "none";
            } else {
              legendPanel.style.display = "block";
              legendPanel.innerHTML =
                "<b>Легенда:</b><br>" +
                "<span style='color:#00FF00;'>■</span> Работает (ярко зеленый)<br>" +
                "<span style='color:#FF0000;'>■</span> Не работает (красный)<br>" +
                "<span style='color:gray;'>■</span> Снят табло (серый)<br>" +
                "<span style='color:black;'>■</span> Демонтирован (черный)<br>" +
                "<span style='color:red;'>&#9889;</span> Нет питания (красная молния)<br>" +
                "<span style='color:green;'>&#9889;</span> Питание есть (зеленая молния)<br>" +
                "■ – Квадратик (медиаборд)<br>" +
                "● – Круг (табло старое)";
            }
          };
          return container;
        }
      });
      map.addControl(new LegendControl());

      // Закрываем панель легенды при клике по карте (опционально)
      map.on("click", function () {
        var legendPanel = document.getElementById("legendPanel");
        if (legendPanel.style.display === "block") {
          legendPanel.style.display = "none";
        }
      });
    </script>
  </body>
</html>
