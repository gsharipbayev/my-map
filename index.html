<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaflet Map ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã</title>

  <!-- Leaflet &¬†Marker‚Äëcluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* ===== base ===== */
    html,body{margin:0;padding:0;height:100%;font-family:sans-serif;font-size:16px}
    #map{width:100%;height:100%;z-index:0}
    .leaflet-top.leaflet-left{margin-top:70px}

    /* ===== search bar ===== */
    #searchActivator{position:fixed;top:0;left:0;right:0;height:10px;z-index:3000}
    #topSearchBar{position:fixed;top:-70px;left:0;right:0;z-index:3001;display:flex;align-items:center;justify-content:center;gap:8px;background:rgba(255,255,255,.9);padding:8px;box-shadow:0 2px 5px rgba(0,0,0,.3);transition:top .3s}
    #topSearchBar.show{top:0}
    #searchInput{flex:1;max-width:600px;padding:5px;border:1px solid #ccc;border-radius:5px;font-size:15px}
    #searchBtn{padding:5px 8px;border:none;border-radius:5px;background:#007bff;color:#fff;font-size:14px;cursor:pointer}

    /* ===== bottom buttons ===== */
    .control-buttons{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:2000}
    .btn{min-width:110px;padding:10px 16px;font-size:14px;border:none;border-radius:8px;background:#007bff;color:#fff;cursor:pointer;transition:background .3s;text-align:center}
    .btn:hover,.btn.active-filter{background:#0056b3}
    .btn span{display:block;font-size:12px;color:#d1e8ff;margin-top:5px}

    /* ===== overlay / bottom panel ===== */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000}
    .bottom-panel{position:fixed;bottom:-100%;left:50%;transform:translateX(-50%);width:90%;max-width:500px;background:#fff;border-radius:15px 15px 0 0;padding:20px;font-size:16px;box-shadow:0 -2px 15px rgba(0,0,0,.3);transition:bottom .4s ease-in-out;z-index:1500}
    .bottom-panel.active{bottom:10%}
    .panel-title{font-size:20px;font-weight:bold;margin-bottom:15px;color:#333}

    /* ===== inside‚Äëpanel buttons ===== */
    .filter-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .filter-buttons button{padding:6px 12px;font-size:14px;border:none;border-radius:5px;background:#007bff;color:#fff;cursor:pointer;transition:background .2s}
    .filter-buttons button:hover{background:#0062cc}
    .filter-buttons button.active{background:#0056b3}

    /* ===== legend ===== */
    .legend-container{display:flex;flex-wrap:wrap;gap:15px}
    .legend-section{display:flex;flex-direction:column;gap:10px}
    .legend-title{font-weight:bold;margin-bottom:5px}
    .legend-row{display:flex;align-items:center;gap:10px}
    .legend-icon{width:20px;height:20px;border:1px solid #000;border-radius:50%}

    /* ===== clusters ===== */
    .cluster-icon{font-weight:bold;text-align:center}
    .my-div-icon{background:none!important;border:none!important}

    /* ===== mobile ===== */
    @media(max-width:600px){#searchInput{max-width:400px;font-size:14px}#searchBtn{font-size:12px;padding:4px 6px}.btn{min-width:90px;padding:8px 12px;font-size:13px}.bottom-panel{width:95%;font-size:14px}.panel-title{font-size:18px}.filter-buttons button{font-size:13px;padding:5px 10px}}
  </style>
</head>
<body>
  <!-- search bar -->
  <div id="searchActivator"></div>
  <div id="topSearchBar"><input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –¢–∞–±–ª–æ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"/><button id="searchBtn">üîç</button></div>

  <!-- map -->
  <div id="map"></div>

  <!-- bottom buttons -->
  <div class="control-buttons">
    <button class="btn" id="legendToggle">–õ–µ–≥–µ–Ω–¥–∞</button>
    <button class="btn" id="statusToggle">–°–æ—Å—Ç–æ—è–Ω–∏–µ <span id="statusLabel">–í—Å–µ (0)</span></button>
    <button class="btn" id="reklamaToggle">–†–µ–∫–ª–∞–º–∞ <span id="reklamaLabel">–í—Å–µ (0)</span></button>
    <button class="btn" id="planToggle">–ü–ª–∞–Ω <span id="planLabel">–í—Å–µ (0)</span></button>
    <button class="btn" id="moveToggle">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ <span id="moveLabel">–í—Å–µ (0)</span></button>
  </div>

  <!-- overlay & panel -->
  <div class="overlay" id="overlay"></div>
  <div class="bottom-panel" id="bottomPanel"><div class="panel-title" id="panelTitle"></div><div id="panelContent" class="legend-container"></div></div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    /* ------------------------------------------------------------------
       0.¬†UTILS
       ------------------------------------------------------------------*/
    /**
     * –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å—Ç–æ–ª–±—Ü—É¬†T (–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ).
     * Apps¬†Script –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∫–ª—é—á–∏ ¬´move¬ª, ¬´–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ¬ª, ¬´movement¬ª¬†–∏¬†—Ç.–¥.
     */
    function getMoveVal(obj){
      return (obj.move ?? obj["–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ"] ?? obj.peremeshchenie ?? obj.movement ?? obj.transfer ?? "").toString().toLowerCase().trim();
    }

    /* ------------------------------------------------------------------
       1.¬†SEARCH BAR (–ø–æ—è–≤–ª–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ)
       ------------------------------------------------------------------*/
    const searchActivator=document.getElementById('searchActivator');
    const topSearchBar=document.getElementById('topSearchBar');
    let hideTimer=null;
    const showSearchBar=()=>{clearTimeout(hideTimer);topSearchBar.classList.add('show');};
    const hideSearchBar=()=>topSearchBar.classList.remove('show');
    const startHideTimer=()=>hideTimer=setTimeout(hideSearchBar,2000);
    ['mouseenter','touchstart'].forEach(e=>searchActivator.addEventListener(e,showSearchBar,{passive:true}));
    searchActivator.addEventListener('mouseleave',startHideTimer);
    topSearchBar.addEventListener('mouseleave',startHideTimer);
    topSearchBar.addEventListener('touchstart',()=>clearTimeout(hideTimer),{passive:true});

    /* ------------------------------------------------------------------
       2.¬†MAP
       ------------------------------------------------------------------*/
    const map=L.map('map').setView([51.09,71.45],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    let markerClusterGroup=null;

    /* ------------------------------------------------------------------
       3.¬†DATA &¬†FILTER STATE
       ------------------------------------------------------------------*/
    let markersData=[];
    let colorMode='status';
    let selectedStatuses=[],selectedReklamas=[],selectedPlans=[],selectedMoves=[];
    const allStatuses=['—Ä–∞–±–æ—Ç–∞–µ—Ç','–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç','—Å–Ω—è—Ç —Ç–∞–±–ª–æ','–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω'];
    const allReklamas=['led','lightbox','–Ω–µ—Ç'];
    const planMonths=['–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];
    const allMoves=['—Ç—Ä–µ–±—É–µ—Ç—Å—è','–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'];

    /* ------------------------------------------------------------------
       4.¬†COLOR HELPERS
       ------------------------------------------------------------------*/
    const getStatusColor=st=>({'—Ä–∞–±–æ—Ç–∞–µ—Ç':'#00FF00','–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç':'#FF0000','—Å–Ω—è—Ç —Ç–∞–±–ª–æ':'#D3D3D3','–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω':'#555555'}[st]||'#FFFFFF');
    const getReklamaColor=rk=>({led:'#FFA500',lightbox:'#800080','–Ω–µ—Ç':'#00FFFF'}[rk]||'#000000');
    const planColors={'–º–∞—Ä—Ç':'#cce5ff','–∞–ø—Ä–µ–ª—å':'#99ccff','–º–∞–π':'#66b3ff','–∏—é–Ω—å':'#3399ff','–∏—é–ª—å':'#0080ff','–∞–≤–≥—É—Å—Ç':'#0066cc','—Å–µ–Ω—Ç—è–±—Ä—å':'#0052a3','–æ–∫—Ç—è–±—Ä—å':'#003d7a','–Ω–æ—è–±—Ä—å':'#002952','–¥–µ–∫–∞–±—Ä—å':'#001429'};
    const getPlanColor=pl=>planColors[pl]||'#CCCCCC';
    const getMoveColor=mv=>({'—Ç—Ä–µ–±—É–µ—Ç—Å—è':'#708090','–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è':'#8B0000'}[mv]||'#FFFFFF');

    /* ------------------------------------------------------------------
       5.¬†ADD¬†MARKERS
       ------------------------------------------------------------------*/
    function addMarkers(arr){
      if(markerClusterGroup)map.removeLayer(markerClusterGroup);
      markerClusterGroup=L.markerClusterGroup({maxClusterRadius:80,iconCreateFunction:cl=>{
        const colors=new Set(cl.getAllChildMarkers().map(m=>m.myColor));
        const bg=colors.size===1?[...colors][0]:'#FFF';
        return L.divIcon({html:<div style="background:${bg};border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;">${cl.getChildCount()}</div>,className:'cluster-icon',iconSize:[40,40]});
      }});

      arr.forEach(it=>{
        const moveVal=getMoveVal(it);
        let c=getStatusColor(it.status?.toLowerCase().trim());
        if(colorMode==='reklama')c=getReklamaColor((it.reklama||'').toLowerCase().replace(/\s/g,''));
        else if(colorMode==='plan')c=getPlanColor((it.plan||'').toLowerCase().trim());
        else if(colorMode==='move')c=getMoveColor(moveVal);

        const lat=parseFloat(it.lat)||51,lng=parseFloat(it.lng)||71;
        const isBoard=(it.tabloInfo||'').toLowerCase().includes('–º–µ–¥–∏–∞–±–æ—Ä–¥');
        const icon=L.divIcon({className:'my-div-icon',html:<div style="width:20px;height:20px;background:${c};border:1px solid #000;${isBoard?'border-radius:0%;':'border-radius:50%;'}"></div>,iconSize:[20,20]});
        const m=L.marker([lat,lng],{icon});m.myColor=c;

        m.bindPopup(<div style="font-weight:bold;font-size:1.1em;">${it.stopName||'(–Ω–µ—Ç)'}</div>ID –¢–∞–±–ª–æ: ${it.tablo||'-'}<br>–£–ª–∏—Ü–∞: ${it.street||'-'}<br>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${it.direction||'-'}<br>–†–∞–π–æ–Ω: ${it.district||'-'}<br>–°—Ç–∞—Ç—É—Å: ${it.status||'-'}<br>–†–µ–∫–ª–∞–º–∞: ${it.reklama||'-'}<br>–ü–ª–∞–Ω: ${it.plan||'-'}<br>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: ${moveVal||'-'});
        markerClusterGroup.addLayer(m);
      });
      map.addLayer(markerClusterGroup);
    }

    /* ------------------------------------------------------------------
       6.¬†FILTERING
       ------------------------------------------------------------------*/
    function applyCombinedFilter(){
      const filtered=markersData.filter(m=>{
        const st=(m.status||'').toLowerCase().trim();
        let rk=(m.reklama||'').toLowerCase().replace(/\s/g,'');if(['x','(x)–Ω–µ—Ç','none','x–Ω–µ—Ç'].includes(rk))rk='–Ω–µ—Ç';
        const pl=(m.plan||'').toLowerCase().trim();
        const mv=getMoveVal(m);
        const okStatus=selectedStatuses.length===0||selectedStatuses.includes(st);
        const okRekl  =selectedReklamas.length===0||selectedReklamas.includes(rk);
        const okPlan  =selectedPlans.length===0||selectedPlans.includes(pl);
        const okMove  =selectedMoves.length===0||selectedMoves.includes(mv);
        return okStatus&&okRekl&&okPlan&&okMove;
      });
      addMarkers(filtered);updateLabels(filtered.length);
    }
    const updateLabels=cnt=>['statusLabel','reklamaLabel','planLabel','moveLabel'].forEach(id=>document.getElementById(id).innerText=–í—Å–µ (${cnt}));

    /* ------------------------------------------------------------------
       7.¬†LOAD DATA
       ------------------------------------------------------------------*/
    fetch('https://script.google.com/macros/s/AKfycbxprxG-MDgk1ULTdQFAjpDr8_wPGkNnTmVjoawzUeGAFKRC-LgUPtRoTiBKVCWvQRAy/exec')
      .then(r=>r.json())
      .then(d=>{markersData=d;applyCombinedFilter();})
      .catch(e=>console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',e));

    /* ------------------------------------------------------------------
       8.¬†LEGEND / PANEL
       ------------------------------------------------------------------*/
    const overlay=document.getElementById('overlay');
    const bottomPanel=document.getElementById('bottomPanel');
    const togglePanel=(title,html)=>{const t=document.getElementById('panelTitle');const c=document.getElementById('panelContent');if(bottomPanel.classList.contains('active')&&t.innerText===title){closePanel();}else{t.innerText=title;c.innerHTML=html;bottomPanel.classList.add('active');overlay.style.display='block';}};
    const closePanel=()=>{bottomPanel.classList.remove('active');overlay.style.display='none';};
    overlay.addEventListener('click',closePanel);
    document.getElementById('legendToggle').addEventListener('click',()=>togglePanel('–õ–µ–≥–µ–Ω–¥–∞',<div class="legend-section"><div class="legend-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div class="legend-row"><div class="legend-icon" style="background:#00FF00"></div> –†–∞–±–æ—Ç–∞–µ—Ç</div><div class="legend-row"><div class="legend-icon" style="background:#FF0000"></div> –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</div><div class="legend-row"><div class="legend-icon" style="background:#D3D3D3"></div> –°–Ω—è—Ç —Ç–∞–±–ª–æ</div><div class="legend-row"><div class="legend-icon" style="background:#555555"></div> –î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω</div><div class="legend-title" style="margin-top:15px;">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</div><div class="legend-row"><div class="legend-icon" style="background:#708090"></div> –¢—Ä–µ–±—É–µ—Ç—Å—è</div><div class="legend-row"><div class="legend-icon" style="background:#8B0000"></div> –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</div></div>));

    /* ------------------------------------------------------------------
       9.¬†FILTER PANEL GENERATOR
       ------------------------------------------------------------------*/
    function openFilter(mode,values,selectedArr,toggleFnName,title){
      colorMode=mode;
      if(mode!=='status')selectedStatuses=[];
      if(mode!=='reklama')selectedReklamas=[];
      if(mode!=='plan')   selectedPlans=[];
      if(mode!=='move')   selectedMoves=[];

      let html='<div class="filter-buttons">';
      values.forEach(v=>{const act=selectedArr.includes(v)?'active':'';html+=<button class="${act}" onclick="${toggleFnName}('${v}')">${v}</button>;});
      html+=<button onclick="clear${toggleFnName.slice(6)}s()">–û—á–∏—Å—Ç–∏—Ç—å</button></div>; // e.g. clearMoves()
      togglePanel(title,html);
      applyCombinedFilter();
    }

    /* ------------------------------------------------------------------
       10.¬†TOGGLE / CLEAR HANDLERS
       ------------------------------------------------------------------*/
    document.getElementById('statusToggle').addEventListener('click',()=>openFilter('status',allStatuses,selectedStatuses,'toggleStatus','–°–æ—Å—Ç–æ—è–Ω–∏–µ'));
    window.toggleStatus=st=>{selectedStatuses=selectedStatuses.includes(st)?selectedStatuses.filter(x=>x!==st):[...selectedStatuses,st];applyCombinedFilter();document.getElementById('statusToggle').click();};
    window.clearStatuss=()=>{selectedStatuses=[];applyCombinedFilter();document.getElementById('statusToggle').click();};

    document.getElementById('reklamaToggle').addEventListener('click',()=>openFilter('reklama',allReklamas,selectedReklamas,'toggleReklama','–†–µ–∫–ª–∞–º–∞'));
    window.toggleReklama=rk=>{selectedReklamas=selectedReklamas.includes(rk)?selectedReklamas.filter(x=>x!==rk):[...selectedReklamas,rk];applyCombinedFilter();document.getElementById('reklamaToggle').click();};
    window.clearReklamas=()=>{selectedReklamas=[];applyCombinedFilter();document.getElementById('reklamaToggle').click();};

    document.getElementById('planToggle').addEventListener('click',()=>openFilter('plan',planMonths,selectedPlans,'togglePlan','–ü–ª–∞–Ω'));
    window.togglePlan=pl=>{selectedPlans=selectedPlans.includes(pl)?selectedPlans.filter(x=>x!==pl):[...selectedPlans,pl];applyCombinedFilter();document.getElementById('planToggle').click();};
    window.clearPlans=()=>{selectedPlans=[];applyCombinedFilter();document.getElementById('planToggle').click();};

    document.getElementById('moveToggle').addEventListener('click',()=>openFilter('move',allMoves,selectedMoves,'toggleMove','–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ'));
    window.toggleMove=mv=>{selectedMoves=selectedMoves.includes(mv)?selectedMoves.filter(x=>x!==mv):[...selectedMoves,mv];applyCombinedFilter();document.getElementById('moveToggle').click();};
    window.clearMoves=()=>{selectedMoves=[];applyCombinedFilter();document.getElementById('moveToggle').click();};

    /* ------------------------------------------------------------------
       11.¬†SEARCH
       ------------------------------------------------------------------*/
    function doSearch(){
      const q=document.getElementById('searchInput').value.toLowerCase().trim();
      if(!q){applyCombinedFilter();return;}
      const filtered=markersData.filter(m=>{
        const st=(m.status||'').toLowerCase().trim();
        let rk=(m.reklama||'').toLowerCase().replace(/\s/g,'');if(['x','(x)–Ω–µ—Ç','none','x–Ω–µ—Ç'].includes(rk))rk='–Ω–µ—Ç';
        const pl=(m.plan||'').toLowerCase().trim();
        const mv=getMoveVal(m);
        const okStatus=selectedStatuses.length===0||selectedStatuses.includes(st);
        const okRekl  =selectedReklamas.length===0||selectedReklamas.includes(rk);
        const okPlan  =selectedPlans.length===0||selectedPlans.includes(pl);
        const okMove  =selectedMoves.length===0||selectedMoves.includes(mv);
        if(!okStatus||!okRekl||!okPlan||!okMove)return false;
        const name=(m.stopName||'').toLowerCase();
        const tablo=String(m.tablo||'').toLowerCase();
        return name.includes(q)||tablo.includes(q);
      });
      addMarkers(filtered);updateLabels(filtered.length);
    }
    document.getElementById('searchBtn').addEventListener('click',doSearch);
    document.getElementById('searchInput').addEventListener('keypress',e=>{if(e.key==='Enter')doSearch();});
  </script>
</body>
</html>
