const map = L.map('map').setView([51.09, 71.45], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let markersData = [];
let markers = [];
let uniqueMonths = [];

fetch('https://script.google.com/macros/s/AKfycbw02IfURjZsCIZsckiRYKt_kawJ4OlazkNILhw4cGwSj-9cdAXzbP6AtNWWr3zNFnky/exec')
  .then(response => response.json())
  .then(data => {
    markersData = data;
    extractUniqueMonths();
    addMarkers(markersData);
    createPlanButtons();
  })
  .catch(error => console.error('Ошибка загрузки данных:', error));

function addMarkers(data) {
  clearMarkers();
  data.forEach(marker => {
    const icon = L.divIcon({
      className: 'custom-icon',
      html: `<div style="background-color: ${getStatusColor(marker.status)}; border: 6px solid ${getReklamaColor(marker.reklama)}; width: 20px; height: 20px; border-radius: 50%;"></div>`
    });
    const mapMarker = L.marker([marker.lat, marker.lng], { icon: icon }).addTo(map);
    markers.push(mapMarker);
  });
}

function clearMarkers() {
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
}

function getStatusColor(status) {
  switch (status.toLowerCase()) {
    case 'работает': return '#00FF00';
    case 'не работает': return '#FF0000';
    case 'снят': return '#AAAAAA';
    case 'снят табло': return '#D3D3D3';
    case 'демонтирован': return '#555555';
    default: return '#FFFFFF';
  }
}

function getReklamaColor(reklama) {
  switch (reklama.toLowerCase()) {
    case 'led': return '#FF0000';
    case 'lightbox': return '#0000FF';
    case '(x) нет': return '#00FF00';
    case 'none': return '#808080';
    case 'x none': return '#808080';
    default: return '#000000';
  }
}

function extractUniqueMonths() {
  uniqueMonths = [...new Set(markersData.map(marker => marker.month))].sort();
}

function createPlanButtons() {
  const planToggle = document.getElementById('searchToggle');
  planToggle.innerText = 'План';
  planToggle.removeEventListener('click', togglePanel);
  planToggle.addEventListener('click', () => {
    togglePanel('Фильтр по месяцам', generatePlanButtons());
  });
}

function generatePlanButtons() {
  return `<div class="filter-buttons">
    ${uniqueMonths.map(month => `<button onclick="filterPlan('${month}')">${month}</button>`).join('')}
  </div>`;
}

function filterPlan(month) {
  const filtered = markersData.filter(marker => marker.month === month);
  addMarkers(filtered);
  closePanel();
  updateLegend();
}

function updateLegend() {
  document.getElementById('panelContent').innerHTML = `<div class="legend-container">
    ${uniqueMonths.map(month => `<div class="legend-row"><div class="legend-icon" style="background-color:${getPlanColor(month)}"></div>${month}</div>`).join('')}
  </div>`;
}

function getPlanColor(month) {
  const colors = ['#FF5733', '#33FF57', '#3357FF', '#FFFF33', '#FF33A8'];
  return colors[uniqueMonths.indexOf(month) % colors.length];
}

function togglePanel(title, content) {
  const panel = document.getElementById('bottomPanel');
  const overlay = document.getElementById('overlay');
  document.getElementById('panelTitle').innerText = title;
  document.getElementById('panelContent').innerHTML = content;
  panel.classList.add('active');
  overlay.style.display = 'block';
  overlay.addEventListener('click', closePanel);
}

function closePanel() {
  document.getElementById('bottomPanel').classList.remove('active');
  document.getElementById('overlay').style.display = 'none';
}

document.getElementById('legendToggle').addEventListener('click', () => {
  togglePanel('Легенда', updateLegend());
});
