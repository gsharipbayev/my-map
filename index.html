<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ä—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –ê—Å—Ç–∞–Ω–∞ ‚Äî –†–∞–±–æ—Ç–∞–µ—Ç / –°—Ç–∞—Ç—É—Å</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #map { width:100%; height:100%; z-index:0; }

    /* –í–µ—Ä—Ö–Ω—è—è –≤—ã–µ–∑–∂–∞—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ */
    #searchActivator { position:fixed; top:0; left:0; right:0; height:10px; z-index:3000; }
    #topSearchBar{
      position:fixed; top:-70px; left:0; right:0; z-index:3001;
      display:flex; gap:8px; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.95); padding:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
      transition:top .25s ease;
    }
    #topSearchBar.show { top:0; }
    #searchInput { flex:1; max-width:600px; padding:8px 10px; font-size:15px; border:1px solid #ccc; border-radius:8px; }
    #searchBtn { padding:8px 12px; font-size:14px; border:none; border-radius:8px; cursor:pointer; background:#007bff; color:#fff; }

    /* –°–∏–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    .control-buttons{
      position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
      display:flex; flex-wrap:wrap; gap:8px; z-index:1001;
    }
    .btn{
      padding:10px 16px; font-size:14px; min-width:120px;
      background:#007bff; color:#fff; border:none; border-radius:10px; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    .btn:hover{ background:#0062cc; }
    .btn.active-filter{ background:#0056b3; box-shadow:0 0 0 2px #fff, 0 0 0 4px #0056b3; }

    /* –û–≤–µ—Ä–ª–µ–π + –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–ª–µ–≥–µ–Ω–¥–∞) */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:1000; }
    .bottom-panel{
      position:fixed; left:50%; transform:translateX(-50%); bottom:-100%;
      width:90%; max-width:520px; max-height:70%;
      background:#fff; border-radius:18px 18px 0 0; padding:18px 18px 6px;
      box-shadow:0 -4px 16px rgba(0,0,0,.25);
      transition:bottom .35s ease; z-index:1002; overflow-y:auto;
    }
    .bottom-panel.active{ bottom:0; }
    .panel-title{ font-weight:700; font-size:18px; margin-bottom:10px; }
    .legend-container{ display:flex; flex-direction:column; gap:14px; }
    .legend-row{ display:flex; align-items:center; gap:10px; }
    .legend-icon{ width:22px; height:22px; border:1px solid #000; display:inline-block; }
    .legend-icon.square{ border-radius:4px; }
    .legend-icon.circle{ border-radius:50%; }
    .legend-icon.triangle{ border:none; width:0; height:0; border-left:11px solid transparent; border-right:11px solid transparent; }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width:600px){
      #searchInput{ max-width:calc(100% - 70px); font-size:14px; }
      #searchBtn{ font-size:13px; padding:6px 10px; }
      .control-buttons{ width:100%; padding:0 10px; box-sizing:border-box; }
      .btn{ flex:1 1 auto; min-width:auto; font-size:13px; padding:9px 10px; }
      .bottom-panel{ width:100%; max-height:65%; }
    }
  </style>
</head>
<body>
  <!-- –≤—ã–µ–∑–∂–∞—é—â–∏–π –ø–æ–∏—Å–∫ -->
  <div id="searchActivator"></div>
  <div id="topSearchBar">
    <input id="searchInput" placeholder="ID –û—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏" />
    <button id="searchBtn">üîç –ü–æ–∏—Å–∫</button>
  </div>

  <!-- –∫–∞—Ä—Ç–∞ -->
  <div id="map"></div>

  <!-- –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -->
  <div class="control-buttons">
    <button class="btn active-filter" id="worksModeBtn">–†–∞–±–æ—Ç–∞–µ—Ç</button>
    <button class="btn" id="statusModeBtn">–°—Ç–∞—Ç—É—Å</button>
    <button class="btn" id="legendBtn">–õ–µ–≥–µ–Ω–¥–∞</button>
  </div>

  <!-- –ø–∞–Ω–µ–ª—å -->
  <div class="overlay" id="overlay"></div>
  <div class="bottom-panel" id="bottomPanel">
    <div class="panel-title" id="panelTitle">–õ–µ–≥–µ–Ω–¥–∞</div>
    <div id="panelContent" class="legend-container"></div>
  </div>

<script>
/* =========================
   0) –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
========================= */
const DATA_URL = "https://script.google.com/macros/s/AKfycbykrfvSNKlLMLRPbuxuUtqD_-o1chp-wIIW6-OFW-BjabiBw9QIDUtNwmvxXj9x4igx/exec"; // –≤–∞—à –¥–µ–ø–ª–æ–π
const ASTANA_CENTER = [51.128, 71.43];
const DEFAULT_ZOOM = 12;

// –¶–≤–µ—Ç–∞/—Å—Ç–∏–ª–∏
const COLORS = {
  // –†–∞–±–æ—Ç–∞–µ—Ç
  worksYes: "#00c853",   // —è—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π
  worksNo: "#ff1744",    // —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
  worksNA: "#9e9e9e",    // —Å–µ—Ä—ã–π

  // –ö–≤–∞–¥—Ä–∞—Ç—ã (–°—Ç–∞—Ç—É—Å ‚Äì –¥–æ–∫—É–º–µ–Ω—Ç—ã)
  agreedBlue: "#2196f3", // –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω
  allotYellow: "#ffeb3b",// –û—Ç–≤–æ–¥=–î–∞
  techOrange: "#ff9800", // –¢–µ—Ö —É—Å–ª=–î–∞

  // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ (–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
  fundViolet: "#8e24aa", // –§—É–Ω–¥–∞–º–µ–Ω—Ç
  netOrange:  "#ff9800", // –°–µ—Ç—å
  frameGreen: "#2e7d32", // –ö–∞—Ä–∫–∞—Å

  clusterBorder: "#555"
};

// –ö–ª—é—á–∏ –∏–∑ GAS-–æ—Ç–≤–µ—Ç–∞ (—Ä—É—Å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
const KEYS = {
  id: "ID –û—Å—Ç–∞–Ω–æ–≤–∫–∏",
  stopName: "–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫",
  street: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã",
  direction: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
  district: "–†–∞–π–æ–Ω",
  lat: "—à–∏—Ä–æ—Ç–∞",
  lng: "–î–æ–ª–≥–æ—Ç–∞",
  works: "–†–∞–±–æ—Ç–∞–µ—Ç",
  agree: "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Ç. —Å—Ö–µ–º",
  allot: "–û—Ç–≤–æ–¥",
  tech: "–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ",
  inst: "–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏",
  note: "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ",
  num: "‚Ññ"
};

// –†–µ–∂–∏–º—ã –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
const MODES = {
  WORKS: "works",
  STATUS: "status"
};
let currentMode = MODES.WORKS;

/* =========================
   1) UI: –≤–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞
========================= */
const searchActivator = document.getElementById("searchActivator");
const topSearchBar = document.getElementById("topSearchBar");
let hideTimer = null;
function showSearchBar(){ clearTimeout(hideTimer); topSearchBar.classList.add("show"); }
function hideSearchBar(){ topSearchBar.classList.remove("show"); }
function startHideTimer(){ hideTimer = setTimeout(hideSearchBar, 1600); }
searchActivator.addEventListener("mouseenter", showSearchBar);
searchActivator.addEventListener("mouseleave", startHideTimer);
searchActivator.addEventListener("touchstart", showSearchBar, {passive:true});
topSearchBar.addEventListener("mouseleave", startHideTimer);
topSearchBar.addEventListener("touchstart", ()=>clearTimeout(hideTimer), {passive:true});

// –ü–æ–∏—Å–∫
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("searchInput").addEventListener("keypress", e => {
  if (e.key === "Enter") doSearch();
});

/* =========================
   2) –ö–∞—Ä—Ç–∞
========================= */
const map = L.map("map", { zoomControl: false }).setView(ASTANA_CENTER, DEFAULT_ZOOM);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);
L.control.zoom({ position: "topright" }).addTo(map);

// –¢–†–ò –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ ‚Äî –ø–æ —Ñ–æ—Ä–º–µ (—á—Ç–æ–±—ã –Ω–µ —Å–º–µ—à–∏–≤–∞–ª–∏—Å—å!)
let clusterCircles, clusterSquares, clusterTriangles;

/* =========================
   3) –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
========================= */
let rawData = [];      // –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ GAS
let filteredData = []; // –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞

loadData();

async function loadData(){
  try{
    const r = await fetch(DATA_URL);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const json = await r.json();

    // json –º–æ–∂–µ—Ç –±—ã—Ç—å [{...}, ...] –∏–ª–∏ {data:[...]}
    rawData = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    rawData = rawData.filter(row => {
      const lat = parseFloat(row[KEYS.lat]);
      const lng = parseFloat(row[KEYS.lng]);
      return !isNaN(lat) && !isNaN(lng);
    });

    filteredData = rawData.slice(); // –∫–æ–ø–∏—è
    render();
  }catch(err){
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).");
  }
}

/* =========================
   4) –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
========================= */
function clearClusters(){
  if(clusterCircles){ map.removeLayer(clusterCircles); }
  if(clusterSquares){ map.removeLayer(clusterSquares); }
  if(clusterTriangles){ map.removeLayer(clusterTriangles); }
  clusterCircles = makeClusterGroup();
  clusterSquares = makeClusterGroup();
  clusterTriangles = makeClusterGroup();
}

// –ï–¥–∏–Ω—ã–π —Ñ–∞–±—Ä–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Ç–µ—Ä-–≥—Ä—É–ø–ø—ã
function makeClusterGroup(){
  return L.markerClusterGroup({
    maxClusterRadius: 60,
    iconCreateFunction: (cluster) => {
      const count = cluster.getChildCount();
      let size = Math.min(Math.max(30 + count / 10, 30), 50);

      // –í—ã–±–µ—Ä–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–π —Ü–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
      const markers = cluster.getAllChildMarkers();
      const freq = {};
      let topColor = COLORS.worksNA, topCnt = 0;
      markers.forEach(m => {
        const c = m.__color || COLORS.worksNA;
        freq[c] = (freq[c] || 0) + 1;
        if(freq[c] > topCnt){ topCnt = freq[c]; topColor = c; }
      });

      const html = `
        <div style="
          background:${topColor};
          border:2px solid ${COLORS.clusterBorder};
          border-radius:50%;
          width:${size}px; height:${size}px;
          display:flex; align-items:center; justify-content:center;
          color:#000; font-weight:700; font-size:${Math.max(10, size/2.5)}px;
        ">${count}</div>
      `;
      return L.divIcon({ html, className:"cluster-icon-only", iconSize:[size,size], iconAnchor:[size/2,size/2] });
    }
  });
}

// –¶–≤–µ—Ç/—Ñ–æ—Ä–º–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–†–∞–±–æ—Ç–∞–µ—Ç" (–∫—Ä—É–≥–∏)
function styleByWorks(row){
  const v = String(row[KEYS.works] || "").trim().toLowerCase();
  if (v === "–¥–∞")   return {shape:"circle", color: COLORS.worksYes};
  if (v === "–Ω–µ—Ç")  return {shape:"circle", color: COLORS.worksNo};
  if (v === "–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω") return {shape:"circle", color: COLORS.worksNA};
  return {shape:"circle", color: COLORS.worksNA};
}

// –¶–≤–µ—Ç/—Ñ–æ—Ä–º–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–°—Ç–∞—Ç—É—Å"
function styleByStatus(row){
  const agree = String(row[KEYS.agree] || "").trim().toLowerCase();
  const allot = String(row[KEYS.allot] || "").trim().toLowerCase();
  const tech  = String(row[KEYS.tech]  || "").trim().toLowerCase();
  const inst  = String(row[KEYS.inst]  || "").trim().toLowerCase();

  // 1) –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ –ø–æ "–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  if (inst === "—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç") return {shape:"triangle", color: COLORS.fundViolet};
  if (inst === "—Å–µ—Ç—å")      return {shape:"triangle", color: COLORS.netOrange};
  if (inst === "–∫–∞—Ä–∫–∞—Å")    return {shape:"triangle", color: COLORS.frameGreen};

  // 2) –ö–≤–∞–¥—Ä–∞—Ç—ã –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
  if (agree === "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω") return {shape:"square", color: COLORS.agreedBlue};
  if (allot === "–¥–∞")         return {shape:"square", color: COLORS.allotYellow};
  if (tech  === "–¥–∞")         return {shape:"square", color: COLORS.techOrange};

  // 3) –ò–Ω–∞—á–µ ‚Äî –∫–∞–∫ ¬´–†–∞–±–æ—Ç–∞–µ—Ç¬ª (–∫—Ä—É–≥)
  return styleByWorks(row);
}

// divIcon –¥–ª—è –∫—Ä—É–≥–∞
function iconCircle(color){
  const html = `<div style="width:18px;height:18px;border-radius:50%;background:${color};border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4);"></div>`;
  return L.divIcon({ className:"my-div-icon", html, iconSize:[18,18], iconAnchor:[9,9] });
}
// divIcon –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∞
function iconSquare(color){
  const html = `<div style="width:18px;height:18px;border-radius:4px;background:${color};border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4);"></div>`;
  return L.divIcon({ className:"my-div-icon", html, iconSize:[18,18], iconAnchor:[9,9] });
}
// divIcon –¥–ª—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–≤–≤–µ—Ä—Ö)
function iconTriangle(color){
  const html = `
    <div style="position:relative;width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:18px solid ${color};filter:drop-shadow(0 0 3px rgba(0,0,0,.4));"></div>
  `;
  return L.divIcon({ className:"my-div-icon", html, iconSize:[18,18], iconAnchor:[9,9] });
}

function addMarkers(rows){
  clearClusters();

  rows.forEach(row => {
    const lat = parseFloat(row[KEYS.lat]);
    const lng = parseFloat(row[KEYS.lng]);

    const style = (currentMode === MODES.WORKS) ? styleByWorks(row) : styleByStatus(row);
    let icon;
    if (style.shape === "circle")   icon = iconCircle(style.color);
    if (style.shape === "square")   icon = iconSquare(style.color);
    if (style.shape === "triangle") icon = iconTriangle(style.color);

    const m = L.marker([lat, lng], { icon });
    m.__color = style.color; // –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä-–∏–∫–æ–Ω–∫–∏

    // –ü–æ–ø–∞–ø: –æ—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—è
    const popupHtml = `
      <b>ID –û—Å—Ç–∞–Ω–æ–≤–∫–∏:</b> ${escapeHtml(row[KEYS.id] ?? "-")}<br/>
      <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> ${escapeHtml(row[KEYS.stopName] ?? "-")}<br/>
      <b>–£–ª–∏—Ü–∞:</b> ${escapeHtml(row[KEYS.street] ?? "-")}<br/>
      <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${escapeHtml(row[KEYS.direction] ?? "-")}<br/>
      <b>–†–∞–π–æ–Ω:</b> ${escapeHtml(row[KEYS.district] ?? "-")}<br/>
      <b>–†–∞–±–æ—Ç–∞–µ—Ç:</b> ${escapeHtml(row[KEYS.works] ?? "-")}<br/>
      <b>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Ç. —Å—Ö–µ–º:</b> ${escapeHtml(row[KEYS.agree] ?? "-")}<br/>
      <b>–û—Ç–≤–æ–¥:</b> ${escapeHtml(row[KEYS.allot] ?? "-")}<br/>
      <b>–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ:</b> ${escapeHtml(row[KEYS.tech] ?? "-")}<br/>
      <b>–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</b> ${escapeHtml(row[KEYS.inst] ?? "-")}<br/>
      <b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${escapeHtml(row[KEYS.note] ?? "-")}
    `;
    m.bindPopup(popupHtml, { maxWidth: 320 });

    // –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ –≥—Ä—É–ø–ø–∞–º —Ñ–æ—Ä–º—ã
    if (style.shape === "circle")   clusterCircles.addLayer(m);
    if (style.shape === "square")   clusterSquares.addLayer(m);
    if (style.shape === "triangle") clusterTriangles.addLayer(m);
  });

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É –≤—Å–µ —Ç—Ä–∏ (–∫–∞–∫–∏–µ-—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ ‚Äî —ç—Ç–æ –æ–∫)
  map.addLayer(clusterCircles);
  map.addLayer(clusterSquares);
  map.addLayer(clusterTriangles);
}

function render(){
  addMarkers(filteredData);
  updateLegend();
}

/* =========================
   5) –ü–æ–∏—Å–∫
========================= */
function doSearch(){
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
  if (!q) {
    filteredData = rawData.slice();
    render();
    return;
  }
  filteredData = rawData.filter(row => {
    const id  = String(row[KEYS.id] || "").toLowerCase();
    const nm  = String(row[KEYS.stopName] || "").toLowerCase();
    return id.includes(q) || nm.includes(q);
  });
  render();
}

/* =========================
   6) –†–µ–∂–∏–º—ã: –†–∞–±–æ—Ç–∞–µ—Ç / –°—Ç–∞—Ç—É—Å
========================= */
const worksModeBtn = document.getElementById("worksModeBtn");
const statusModeBtn = document.getElementById("statusModeBtn");
worksModeBtn.addEventListener("click", () => {
  currentMode = MODES.WORKS;
  worksModeBtn.classList.add("active-filter");
  statusModeBtn.classList.remove("active-filter");
  render();
});
statusModeBtn.addEventListener("click", () => {
  currentMode = MODES.STATUS;
  statusModeBtn.classList.add("active-filter");
  worksModeBtn.classList.remove("active-filter");
  render();
});

/* =========================
   7) –õ–µ–≥–µ–Ω–¥–∞ (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å)
========================= */
const overlay = document.getElementById("overlay");
const bottomPanel = document.getElementById("bottomPanel");
const panelTitle = document.getElementById("panelTitle");
const panelContent = document.getElementById("panelContent");
document.getElementById("legendBtn").addEventListener("click", () => {
  updateLegend();
  togglePanel("–õ–µ–≥–µ–Ω–¥–∞");
});
overlay.addEventListener("click", closePanel);

function togglePanel(title){
  if (bottomPanel.classList.contains("active") && panelTitle.innerText === title){
    closePanel();
  } else {
    panelTitle.innerText = title;
    bottomPanel.classList.add("active");
    overlay.style.display = "block";
  }
}
function closePanel(){
  bottomPanel.classList.remove("active");
  overlay.style.display = "none";
}

function updateLegend(){
  if (currentMode === MODES.WORKS){
    panelContent.innerHTML = `
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksYes}"></span> –†–∞–±–æ—Ç–∞–µ—Ç = ¬´–î–∞¬ª</div>
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksNo}"></span> –†–∞–±–æ—Ç–∞–µ—Ç = ¬´–ù–µ—Ç¬ª</div>
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksNA}"></span> –ü—É—Å—Ç–æ / ¬´–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω¬ª</div>
    `;
  } else {
    panelContent.innerHTML = `
      <div class="legend-row"><span class="legend-icon triangle" style="border-bottom-color:${COLORS.fundViolet}"></span> –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: –§—É–Ω–¥–∞–º–µ–Ω—Ç</div>
      <div class="legend-row"><span class="legend-icon triangle" style="border-bottom-color:${COLORS.netOrange}"></span> –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: –°–µ—Ç—å</div>
      <div class="legend-row"><span class="legend-icon triangle" style="border-bottom-color:${COLORS.frameGreen}"></span> –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: –ö–∞—Ä–∫–∞—Å</div>
      <hr/>
      <div class="legend-row"><span class="legend-icon square" style="background:${COLORS.agreedBlue}"></span> –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Ç. —Å—Ö–µ–º: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω</div>
      <div class="legend-row"><span class="legend-icon square" style="background:${COLORS.allotYellow}"></span> –û—Ç–≤–æ–¥: –î–∞</div>
      <div class="legend-row"><span class="legend-icon square" style="background:${COLORS.techOrange}"></span> –¢–µ—Ö —É—Å–ª–æ–≤–∏–µ: –î–∞</div>
      <hr/>
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksYes}"></span> –†–∞–±–æ—Ç–∞–µ—Ç = ¬´–î–∞¬ª (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç)</div>
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksNo}"></span> –†–∞–±–æ—Ç–∞–µ—Ç = ¬´–ù–µ—Ç¬ª (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç)</div>
      <div class="legend-row"><span class="legend-icon circle" style="background:${COLORS.worksNA}"></span> –ü—É—Å—Ç–æ / ¬´–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω¬ª (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç)</div>
    `;
  }
}

/* =========================
   8) –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ
========================= */
function escapeHtml(s){
  return String(s == null ? "" : s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
</script>
</body>
</html>
