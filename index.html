<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –ê—Å—Ç–∞–Ω–∞ ‚Äî –ë—ã—Å—Ç—Ä–∞—è –∫–∞—Ä—Ç–∞</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
  html,body,#map{height:100%;margin:0}
  #bar{position:fixed;left:0;right:0;top:-64px;display:flex;gap:8px;justify-content:center;padding:8px;background:rgba(255,255,255,.95);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:.25s;z-index:3}
  #hover{position:fixed;inset:0 0 auto 0;height:10px;z-index:4}
  #bar.show{top:0} input,button{font:14px/1.2 system-ui;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  #bar button{background:#007bff;color:#fff;border:none}
  .controls{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:flex;gap:8px;z-index:2}
  .btn{background:#007bff;color:#fff;border:none;border-radius:10px;padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer}
  .btn.active{background:#0056b3;box-shadow:0 0 0 2px #fff,0 0 0 4px #0056b3}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:2}
  .panel{position:fixed;left:50%;transform:translateX(-50%);bottom:-100%;width:92%;max-width:520px;max-height:70%;background:#fff;border-radius:18px 18px 0 0;padding:16px;box-shadow:0 -4px 16px rgba(0,0,0,.25);transition:.35s;z-index:3;overflow:auto}
  .panel.active{bottom:0} .legend .row{display:flex;align-items:center;gap:10px;margin:8px 0}
  .ico{width:22px;height:22px;border:1px solid #000;display:inline-block;border-radius:50%}
  .sq{border-radius:4px} .tri{border:none;width:0;height:0;border-left:11px solid transparent;border-right:11px solid transparent}
</style>
</head>
<body>
<div id="hover"></div>
<div id="bar">
  <input id="q" placeholder="ID –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏" />
  <button id="find">üîç –ü–æ–∏—Å–∫</button>
</div>
<div id="map"></div>
<div class="controls">
  <button class="btn active" id="modeWorks">–†–∞–±–æ—Ç–∞–µ—Ç</button>
  <button class="btn" id="modeStatus">–°—Ç–∞—Ç—É—Å</button>
  <button class="btn" id="legendBtn">–õ–µ–≥–µ–Ω–¥–∞</button>
</div>
<div class="overlay" id="ov"></div>
<div class="panel" id="panel"><div id="legend" class="legend"></div></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/* ==== 0. –ö–æ–Ω—Ñ–∏–≥/–∫–ª—é—á–∏ ==== */
const DATA_URL = "https://script.google.com/macros/s/AKfycbykrfvSNKlLMLRPbuxuUtqD_-o1chp-wIIW6-OFW-BjabiBw9QIDUtNwmvxXj9x4igx/exec";
const CENTER=[51.128,71.43], ZOOM=12, CACHE_TTL_MS=60_000;
const K={ id:"ID –û—Å—Ç–∞–Ω–æ–≤–∫–∏", stop:"–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫", street:"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã", dir:"–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", dist:"–†–∞–π–æ–Ω", lat:"—à–∏—Ä–æ—Ç–∞", lng:"–î–æ–ª–≥–æ—Ç–∞", work:"–†–∞–±–æ—Ç–∞–µ—Ç", agr:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Ç. —Å—Ö–µ–º", all:"–û—Ç–≤–æ–¥", tech:"–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ", inst:"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏", note:"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" };
const C={ yes:"#00c853", no:"#ff1744", na:"#9e9e9e", blue:"#2196f3", yellow:"#ffeb3b", orange:"#ff9800", violet:"#8e24aa", green:"#2e7d32", cluster:"#555" };

/* ==== 1. –ü—Ä–∞–≤–∏–ª–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (—É—á—Ç–µ–Ω–æ ¬´–ì–æ—Ç–æ–≤–æ¬ª) ==== */
const RULES={
  works:[
    {when:r=>eq(r[K.work],"–¥–∞"),  shape:"circle", color:C.yes, label:"–†–∞–±–æ—Ç–∞–µ—Ç: –î–∞"},
    {when:r=>eq(r[K.work],"–Ω–µ—Ç"), shape:"circle", color:C.no,  label:"–†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç"},
    {when:_=>true,                shape:"circle", color:C.na,  label:"–ü—É—Å—Ç–æ/–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"},
  ],
  status:[
    {when:r=>eq(r[K.inst],"–≥–æ—Ç–æ–≤–æ"),    shape:"circle",   color:C.yes,    legend:"–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ"},
    {when:r=>eq(r[K.inst],"—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç"), shape:"triangle", color:C.violet, legend:"–°—Ç–∞—Ç—É—Å: –§—É–Ω–¥–∞–º–µ–Ω—Ç"},
    {when:r=>eq(r[K.inst],"—Å–µ—Ç—å"),      shape:"triangle", color:C.orange, legend:"–°—Ç–∞—Ç—É—Å: –°–µ—Ç—å"},
    {when:r=>eq(r[K.inst],"–∫–∞—Ä–∫–∞—Å"),    shape:"triangle", color:C.green,  legend:"–°—Ç–∞—Ç—É—Å: –ö–∞—Ä–∫–∞—Å"},
    {when:r=>eq(r[K.agr],"—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω"), shape:"square",   color:C.blue,   legend:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω"},
    {when:r=>eq(r[K.all],"–¥–∞"),         shape:"square",   color:C.yellow, legend:"–û—Ç–≤–æ–¥: –î–∞"},
    {when:r=>eq(r[K.tech],"–¥–∞"),        shape:"square",   color:C.orange, legend:"–¢–µ—Ö —É—Å–ª–æ–≤–∏–µ: –î–∞"},
    {when:r=>eq(r[K.work],"–¥–∞"),        shape:"circle",   color:C.yes,    legend:"–†–∞–±–æ—Ç–∞–µ—Ç: –î–∞ (fallback)"},
    {when:r=>eq(r[K.work],"–Ω–µ—Ç"),       shape:"circle",   color:C.no,     legend:"–†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç (fallback)"},
    {when:_=>true,                      shape:"circle",   color:C.na,     legend:"–ü—É—Å—Ç–æ/–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (fallback)"},
  ]
};

/* ==== 2. –£—Ç–∏–ª–∏—Ç—ã ==== */
const eq=(v,s)=>String(v??"").trim().toLowerCase()===s;
const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const now=()=>Date.now();

/* ==== 3. –ö–∞—Ä—Ç–∞ ==== */
const map=L.map("map",{zoomControl:false}).setView(CENTER,ZOOM);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
L.control.zoom({position:"topright"}).addTo(map);

/* ==== 4. –ö–ª–∞—Å—Ç–µ—Ä—ã –ø–æ –ö–û–ú–ë–û (shape|color) ==== */
function makeCluster(fixedColor){
  return L.markerClusterGroup({
    maxClusterRadius:60,
    iconCreateFunction: cl => {
      const n=cl.getChildCount(), s=Math.min(Math.max(30+n/10,30),50);
      // —Ü–≤–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ–º = —Ü–≤–µ—Ç –≥—Ä—É–ø–ø—ã (–Ω–µ —Å—á–∏—Ç–∞–µ–º ¬´—á–∞—Å—Ç–æ—Ç—ã¬ª)
      return L.divIcon({
        html:`<div style="background:${fixedColor};border:2px solid ${C.cluster};border-radius:50%;width:${s}px;height:${s}px;display:flex;align-items:center;justify-content:center;font-weight:700">${n}</div>`,
        className:"cluster", iconSize:[s,s], iconAnchor:[s/2,s/2]
      });
    }
  });
}
// —Ä–µ–µ—Å—Ç—Ä –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: key="shape|color" -> MarkerClusterGroup
const clusterRegistry=new Map();
function getCluster(shape,color){
  const key=shape+"|"+color;
  if(clusterRegistry.has(key)) return clusterRegistry.get(key);
  const g=makeCluster(color);
  clusterRegistry.set(key,g);
  map.addLayer(g);
  return g;
}
function clearAllClusters(){
  for(const g of clusterRegistry.values()) map.removeLayer(g);
  clusterRegistry.clear();
}

/* ==== 5. –ò–∫–æ–Ω–∫–∏ —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ==== */
const iconCache=new Map();
function getIcon(shape,color){
  const key=shape+"|"+color;
  if(iconCache.has(key)) return iconCache.get(key);
  let html;
  if(shape==="circle")   html=`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4)"></div>`;
  if(shape==="square")   html=`<div style="width:18px;height:18px;border-radius:4px;background:${color};border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,.4)"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:18px solid ${color};filter:drop-shadow(0 0 3px rgba(0,0,0,.4))"></div>`;
  const ic=L.divIcon({html,className:"",iconSize:[18,18],iconAnchor:[9,9]});
  iconCache.set(key,ic); return ic;
}

/* ==== 6. –°–æ—Å—Ç–æ—è–Ω–∏–µ ==== */
let mode="works";
let data=[], view=[];

/* ==== 7. –ó–∞–≥—Ä—É–∑–∫–∞ —Å –∫—ç—à–µ–º ==== */
(async function init(){
  try{
    const cached=readCache();
    if(cached){ data=cached; } else {
      const r=await fetch(DATA_URL,{cache:"no-store"});
      const json=await r.json();
      data=Array.isArray(json)?json:(json.data||[]);
      writeCache(data);
    }
    data=data.map(r=>{
      const lat=+r[K.lat], lng=+r[K.lng];
      return {...r, _lat:lat, _lng:lng,
        _id:String(r[K.id]??""), _nm:String(r[K.stop]??""),
        _work:String(r[K.work]??"").trim().toLowerCase(),
        _inst:String(r[K.inst]??"").trim().toLowerCase(),
        _agr:String(r[K.agr]??"").trim().toLowerCase(),
        _all:String(r[K.all]??"").trim().toLowerCase(),
        _tech:String(r[K.tech]??"").trim().toLowerCase(),
      };
    }).filter(r=>!Number.isNaN(r._lat)&&!Number.isNaN(r._lng));

    view=data; draw(); fit(view);
  }catch(e){ console.error(e); alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"); }
})();
function readCache(){
  try{
    const raw=localStorage.getItem("stops_cache_v1");
    if(!raw) return null;
    const {ts,rows}=JSON.parse(raw);
    if(now()-ts>CACHE_TTL_MS) return null;
    return rows;
  }catch{ return null; }
}
function writeCache(rows){
  try{ localStorage.setItem("stops_cache_v1", JSON.stringify({ts:now(), rows})); }catch{}
}

/* ==== 8. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ (–∫–ª–∞—Å—Ç–µ—Ä = shape|color) ==== */
function draw(){
  clearAllClusters(); // –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø (—Ä–µ–∂–∏–º/–ø–æ–∏—Å–∫ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–π)
  const rules=RULES[mode];

  // –±–∞—Ç—á-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ: key -> [markers]
  const batches=new Map();

  for(const r of view){
    const {shape,color}=rules.find(x=>x.when(r));
    const ic=getIcon(shape,color);
    const m=L.marker([r._lat,r._lng],{icon:ic}); m.__c=color;
    m.bindPopup(
      `<b>ID:</b> ${esc(r[K.id])}<br><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> ${esc(r[K.stop])}<br><b>–£–ª–∏—Ü–∞:</b> ${esc(r[K.street])}<br><b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> ${esc(r[K.dir])}<br><b>–†–∞–π–æ–Ω:</b> ${esc(r[K.dist])}<br><b>–†–∞–±–æ—Ç–∞–µ—Ç:</b> ${esc(r[K.work])}<br><b>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ:</b> ${esc(r[K.agr])}<br><b>–û—Ç–≤–æ–¥:</b> ${esc(r[K.all])}<br><b>–¢–µ—Ö —É—Å–ª.:</b> ${esc(r[K.tech])}<br><b>–°—Ç–∞—Ç—É—Å —É—Å—Ç.:</b> ${esc(r[K.inst])}<br><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${esc(r[K.note])}`
    );
    const key=shape+"|"+color;
    if(!batches.has(key)) batches.set(key, []);
    batches.get(key).push(m);
  }

  // –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—á–∫–∞–º–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Ç–µ—Ä
  for(const [key, markers] of batches){
    const [shape,color]=key.split("|");
    const g=getCluster(shape,color);
    g.addLayers(markers);
  }
}

function fit(rows){
  if(!rows.length) return;
  const b=L.latLngBounds(rows.map(r=>[r._lat,r._lng]));
  map.fitBounds(b.pad(0.05),{animate:false});
}

/* ==== 9. –ü–æ–∏—Å–∫ (–¥–µ–±–∞—É–Ω—Å) ==== */
const q=document.getElementById("q");
const applySearch=()=>{
  const s=(q.value||"").trim().toLowerCase();
  view = s ? data.filter(r=>r._id.toLowerCase().includes(s)||r._nm.toLowerCase().includes(s)) : data;
  draw(); fit(view);
};
document.getElementById("find").onclick=applySearch;
q.addEventListener("input", debounce(applySearch,200), {passive:true});

/* ==== 10. –†–µ–∂–∏–º—ã ==== */
const btnW=document.getElementById("modeWorks");
const btnS=document.getElementById("modeStatus");
btnW.onclick=()=>{ mode="works"; btnW.classList.add("active"); btnS.classList.remove("active"); draw(); };
btnS.onclick=()=>{ mode="status"; btnS.classList.add("active"); btnW.classList.remove("active"); draw(); };

/* ==== 11. –õ–µ–≥–µ–Ω–¥–∞ ==== */
const ov=document.getElementById("ov"), panel=document.getElementById("panel");
document.getElementById("legendBtn").onclick=()=>{ setLegend(); togglePanel(); };
ov.onclick=togglePanel;
function togglePanel(){ const on=panel.classList.toggle("active"); ov.style.display=on?"block":"none"; }
function setLegend(){
  const box=document.getElementById("legend");
  if(mode==="works"){
    box.innerHTML=`
      <div class="row"><span class="ico" style="background:${C.yes}"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –î–∞</div>
      <div class="row"><span class="ico" style="background:${C.no}"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç</div>
      <div class="row"><span class="ico" style="background:${C.na}"></span> –ü—É—Å—Ç–æ / –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
    `;
  }else{
    box.innerHTML=`
      <div class="row"><span class="ico" style="background:${C.yes}"></span> –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ</div>
      <div class="row"><span class="tri" style="border-bottom:22px solid ${C.violet}"></span> –°—Ç–∞—Ç—É—Å: –§—É–Ω–¥–∞–º–µ–Ω—Ç</div>
      <div class="row"><span class="tri" style="border-bottom:22px solid ${C.orange}"></span> –°—Ç–∞—Ç—É—Å: –°–µ—Ç—å</div>
      <div class="row"><span class="tri" style="border-bottom:22px solid ${C.green}"></span> –°—Ç–∞—Ç—É—Å: –ö–∞—Ä–∫–∞—Å</div>
      <hr/>
      <div class="row"><span class="ico sq" style="background:${C.blue}"></span> –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω</div>
      <div class="row"><span class="ico sq" style="background:${C.yellow}"></span> –û—Ç–≤–æ–¥: –î–∞</div>
      <div class="row"><span class="ico sq" style="background:${C.orange}"></span> –¢–µ—Ö —É—Å–ª–æ–≤–∏–µ: –î–∞</div>
      <hr/>
      <div class="row"><span class="ico" style="background:${C.yes}"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –î–∞ (fallback)</div>
      <div class="row"><span class="ico" style="background:${C.no}"></span> –†–∞–±–æ—Ç–∞–µ—Ç: –ù–µ—Ç (fallback)</div>
      <div class="row"><span class="ico" style="background:${C.na}"></span> –ü—É—Å—Ç–æ/–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (fallback)</div>
    `;
  }
}

/* ==== 12. –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–≤—ã–µ–∑–¥) ==== */
const bar=document.getElementById("bar"), hover=document.getElementById("hover");
let t; const show=()=>{clearTimeout(t);bar.classList.add("show")}, hide=()=>bar.classList.remove("show");
hover.addEventListener("mouseenter", show); hover.addEventListener("mouseleave", ()=>t=setTimeout(hide,1200));
hover.addEventListener("touchstart", show, {passive:true}); bar.addEventListener("mouseleave", ()=>t=setTimeout(hide,1200));
</script>
</body>
</html>
